# 功能列表

## 1、增加数据大屏中明细表和汇总表的下载Excel带格式的功能

首先通过查看页面，发现在数据大屏的透视表中本身是支持“导出Excel(带格式)”的功能的。

### 1. “查看数据”按钮的实现

- 透视图（如“UserView”组件）在预览或编辑时，右上角会有一个“查看数据”按钮。

- 这个按钮实际上是 ComponentEditBar.vue 组件中的一项，点击后会触发 userViewEnlargeOpen($event, 'details') 事件。

- 事件会通过 ComponentWrapper.vue 组件的 @userViewEnlargeOpen 向上传递，最终调用 UserViewEnlarge.vue 组件的 dialogInit 方法，弹出“查看数据”弹窗。

------

### 2. “查看数据”弹窗的实现

- 弹窗组件为 UserViewEnlarge.vue，以 <el-dialog> 形式展示。

- 弹窗内会根据 optType 为 details，渲染表格数据（透视表），并在顶部渲染导出按钮。

------

### 3. 三个下载链接的实现

- 在 UserViewEnlarge.vue 头部，optType 为 details 时，会显示如下按钮：

- “导出Excel” —— @click="downloadViewDetails('view')"

- “导出原始明细” —— @click="downloadViewDetails('dataset')"

- “导出Excel(带格式)”（仅透视表类型）—— @click="exportAsFormattedExcel"

- 相关方法：

- downloadViewDetails(type)：调用 exportExcelDownload 方法，下载普通 Excel 或原始明细。

- exportAsFormattedExcel()：调用 exportPivotExcel 方法，下载带格式的 Excel（透视表专用）。

- 这些方法最终会调用后端接口或前端导出逻辑，将数据以 Excel 文件下载到本地。

------

### 4. 相关主要文件

- core/core-frontend/src/components/visualization/ComponentEditBar.vue（右上角操作栏）

- core/core-frontend/src/components/visualization/UserViewEnlarge.vue（弹窗及导出按钮）

- core/core-frontend/src/views/chart/components/js/util.ts、common_table.ts（导出实现）

------

### 5. 总结

你看到的“查看数据”弹窗和三个下载链接，正是通过上述组件和方法实现的。

如需定制导出逻辑、按钮权限、样式或其它行为，可以直接在 UserViewEnlarge.vue 里修改。

如需进一步分析某个导出类型的实现细节或想自定义行为，请告知！

## 2、我现在想在新建“明细表”和“汇总表”时，也支持“下载带格式的 Excel” 的功能，应该怎么做？

你要的效果是：让“明细表”（table-info）和“汇总表”（table-normal）也支持“导出Excel（带格式）”的功能，即在“查看数据”弹窗右上角显示“导出Excel(带格式)”按钮，并能正常导出。

------

**结论与实现思路**

1. ### 现状

- 目前“导出Excel(带格式)”按钮只在 viewInfo.type === 'table-pivot' 时显示，并调用 exportAsFormattedExcel 方法。

- exportAsFormattedExcel 实际调用的是 exportPivotExcel，而该方法只支持 PivotSheet（透视表）的 S2 实例。

- 明细表（table-info）和汇总表（table-normal）底层也是 S2 的 TableSheet，可以用类似方式导出。

2. ### 你的需求

- 让“明细表”（table-info）和“汇总表”（table-normal）也显示“导出Excel(带格式)”按钮。

- 并且点击后能导出带格式的 Excel。

**具体修改建议**

### 步骤一：让按钮在明细表和汇总表也显示

#### 修改 UserViewEnlarge.vue 头部按钮渲染条件

找到：

```vue
<el-button
  class="m-button"
  v-if="optType === 'details' && exportPermissions[2] && viewInfo.type === 'table-pivot'"
  link
  size="middle"
  :loading="exportLoading"
  @click="exportAsFormattedExcel"
>
  <el-icon ... />
  {{ t('chart.export_excel_formatter') }}
</el-button>
```

改为：

```vue
<el-button
  class="m-button"
  v-if="optType === 'details' && exportPermissions[2] && ['table-pivot', 'table-info', 'table-normal'].includes(viewInfo.type)"
  link
  size="middle"
  :loading="exportLoading"
  @click="exportAsFormattedExcel"
>
  <el-icon ... />
  {{ t('chart.export_excel_formatter') }}
</el-button>
```



------

### 步骤二：让导出方法支持明细表和汇总表

#### 修改 exportAsFormattedExcel 方法

原本只支持 table-pivot，你需要让它支持 table-info 和 table-normal。

```typescript
const exportAsFormattedExcel = () => {
  const s2Instance = dvMainStore.getViewInstanceInfo(viewInfo.value.id)
  if (!s2Instance) {
    return
  }
  const chart = dvMainStore.getViewDetails(viewInfo.value.id)
  // 新增支持 table-info 和 table-normal
  if (['table-pivot', 'table-info', 'table-normal'].includes(viewInfo.value.type)) {
    exportPivotExcel(s2Instance, chart)
  }
}
```

> 其实 exportPivotExcel 内部只要能拿到 S2 的实例和 chart 配置，明细表和汇总表也能导出，只是样式和数据结构略有不同，但 S2 的 TableSheet 兼容。

------

### 总结

只需两步：

1. 按钮显示条件加上 table-info 和 table-normal

1. 导出方法判断类型后直接调用 exportPivotExcel

------

### 代码修改示例

```vue
// ... 省略其它代码 ...
<el-button
  class="m-button"
  v-if="optType === 'details' && exportPermissions[2] && ['table-pivot', 'table-info', 'table-normal'].includes(viewInfo.type)"
  link
  size="middle"
  :loading="exportLoading"
  @click="exportAsFormattedExcel"
>
  <el-icon color="#1F2329" size="16" style="margin-right: 3px">
    <icon_download_outlined />
  </el-icon>
  {{ t('chart.export_excel_formatter') }}
</el-button>
```



```typescript
const exportAsFormattedExcel = () => {
  const s2Instance = dvMainStore.getViewInstanceInfo(viewInfo.value.id)
  if (!s2Instance) {
    return
  }
  const chart = dvMainStore.getViewDetails(viewInfo.value.id)
  if (['table-pivot', 'table-info', 'table-normal'].includes(viewInfo.value.type)) {
    exportPivotExcel(s2Instance, chart)
  }
}
```

------

如需详细代码补丁或遇到导出格式问题，可继续追问！