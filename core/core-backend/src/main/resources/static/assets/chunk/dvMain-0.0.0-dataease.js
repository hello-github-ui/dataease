import{d as B}from"./pinia-0.0.0-dataease.js";import{e as x,u as b}from"./index-0.0.0-dataease.js";import{j as _,A as g}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{S as N,B as k,l as U,m as W}from"./chart-0.0.0-dataease.js";import{c as L,f as q,C as D,a as E,d as F,D as R,b as H}from"./dataVisualization-0.0.0-dataease2.js";import{c as I}from"./index-0.0.0-dataease12.js";import{u as J,g as V,s as w}from"./lodash-es-0.0.0-dataease.js";import{useAppearanceStoreWithOut as z}from"./appearance-0.0.0-dataease.js";import{p as Y}from"./element-plus-secondary-0.0.0-dataease.js";import{y as G}from"./dataset-0.0.0-dataease.js";const j=(e,t)=>{const a=t==="y_M_d_H"?e+":":e;if(new Date(a).toString()==="Invalid Date")return a;switch(t){case"year":case"y":return X(a);case"month":case"y_M":return K(a);case"date":case"y_M_d":case"M_d":return Q(a);case"hour":case"y_M_d_H":return Z(a);case"minute":case"y_M_d_H_m":return $(a);case"y_M_d_H_m_s":return ee(a);case"datetime":return[+new Date(a),+new Date(a)];default:return a}},X=e=>{const t=new Date(e);return[+new Date(t.getFullYear(),0,1),+new Date(t.getFullYear(),11,31)+60*1e3*60*24-1e3]},K=e=>{const t=new Date(e),a=new Date(t.getFullYear(),t.getMonth(),1);return a.setDate(1),a.setMonth(a.getMonth()+1),[+new Date(t.getFullYear(),t.getMonth(),1),+new Date(a.getTime()-1e3)]},Q=e=>{const t=te(e);return[+t,+t+60*1e3*60*24-1e3]},Z=e=>[+new Date(e),+new Date(e)+60*1e3*60-1e3],$=e=>[+new Date(e),+new Date(e)+60*1e3-1e3],ee=e=>[+new Date(e),+new Date(e)+999],te=e=>{if(e){const t=new Date(e);return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())}else return e};function ae(e,t){var a,i,s,n;if(e&&t&&t.dimensionList){const o=e.fields?e.fields:(a=e.left)!=null&&a.fields||(i=e.right)!=null&&i.fields?J((s=e.left)==null?void 0:s.fields,(n=e.right)==null?void 0:n.fields):[],l=o.reduce((u,f)=>(u[f.id]=f.dataeaseName,u),{}),d=o.reduce((u,f)=>(u[f.dataeaseName]=f.deType,u),{}),r=o.reduce((u,f)=>(u[f.dataeaseName]=f.dateStyle,u),{});t.dimensionList.forEach(u=>{const f=l[u.id];d[f]===1&&(u.timeValue=j(u.value,r[f]))})}}let M={};const se=async e=>{const t=e.queryId,a=e.displayId,i=await G({queryId:t,displayId:a,searchText:""});return i==null?void 0:i.reduce((s,n)=>(s[n[a]]=n[t],s),{})},ie=(e,t)=>{const a=M[t];if(a){const i=[];return e.forEach(s=>{i.push(a[s]||s)}),i}else return e},ge=async e=>{M={};for(const t of e)if(t.component==="VQuery")for(const a of t.propValue){const{optionValueSource:i,field:s,displayId:n}=a;i===1&&s.id&&(M[s.id]=await se({queryId:s.id,displayId:n,searchText:""}))}},{t:A}=_(),ne=B("dataVisualization",{state:()=>({canvasAttachInfo:{},fullscreenFlag:!1,staticResourcePath:"/static-resource/",canvasCollapse:{defaultSide:!1,realTimeComponent:!1,canvas:!1,componentProp:!1,chartAreaCollapse:!1,datasetAreaCollapse:!1},canvasState:{curPointArea:"base"},embeddedCallBack:"no",editMode:"preview",mobileInPc:!1,inMobile:!1,firstLoadMap:[],canvasStyleData:{...g(L),backgroundColor:null},appData:null,componentDataCache:null,pcComponentData:[],mobileComponentData:[],isInEditor:!1,componentData:[],curComponent:null,curTabName:null,curComponentIndex:null,curCanvasScaleMap:{},previewCanvasScale:{scalePointWidth:1,scalePointHeight:1},isClickComponent:!1,dvInfo:{dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1},canvasViewInfo:{},canvasViewDataInfo:{},canvasViewInstanceInfo:{},canvasViewOriginDataInfo:{},lastViewRequestInfo:{},bashMatrixInfo:{baseWidth:0,baseHeight:0,baseMarginLeft:0,baseMarginTop:0},curActiveTabInner:null,linkageSettingStatus:!1,curLinkageView:null,targetLinkageInfo:[],nowPanelTrackInfo:{},nowPanelJumpInfo:{},nowPanelJumpInfoTargetPanel:{},nowPanelOuterParamsInfoV2:{},nowPanelOuterParamsBaseInfoV2:{},dragComponentInfo:null,mobileLayoutStatus:!1,publicLinkStatus:!1,pcTabMatrixCount:{x:36,y:36},basePcScreenSize:{width:1920,height:1080},pcMatrixCount:{x:72,y:36},mobileMatrixCount:{x:6,y:12},mobileLayoutStyle:{x:300,y:600},scrollAutoMove:0,isCollapse:!1,panelViewEditInfo:{},panelViewDetailsInfo:{},batchOptComponentType:null,batchOptStatus:!1,hiddenListStatus:!1,lastHiddenComponent:[],curBatchOptComponents:[],curMultiplexingComponents:{},mixProperties:[],mixPropertiesInner:{},batchOptComponentInfo:null,batchOptComponents:{},changeProperties:{customStyle:{},customAttr:{}},allViewRender:[],tabCollisionActiveId:null,tabMoveInActiveId:null,tabMoveOutActiveId:null,tabMoveOutComponentId:null,tabActiveTabNameMap:{},mousePointShadowMap:{mouseX:0,mouseY:0,width:0,height:0},previewVisible:!1,previewComponentData:[],currentCanvasNewId:[],curOriginThemes:"light",baseCellInfo:{},dataPrepareState:!1,multiplexingStyleAdapt:!0,mainScrollTop:0,isIframe:!1,isPopWindow:!1}),actions:{setLastHiddenComponent(e){e?this.lastHiddenComponent=[e]:this.lastHiddenComponent.length>0&&(this.lastHiddenComponent=[])},setIframeFlag(e){this.isIframe=e},setIsPopWindow(e){this.isPopWindow=e},setCanvasAttachInfo(e){this.canvasAttachInfo=e},setEmbeddedCallBack(e){this.embeddedCallBack=e},setPublicLinkStatus(e){this.publicLinkStatus=e},setFirstLoadMap(e){this.firstLoadMap=e},setDataPrepareState(e){this.dataPrepareState=e},setBaseCellInfo(e){this.baseCellInfo=e},aceSetCanvasData(e){this.canvasStyleData=e},setInMobile(e){this.inMobile=e},aceSetCurComponent(e){for(let t=0;t<this.componentData.length;t++)this.componentData[t].id===e.id&&this.componentData.splice(t,1);this.componentData.push(e),this.curComponent=e},setClickComponentStatus(e){this.isClickComponent=e},setEditMode(e){this.editMode=e},setMobileInPc(e){this.mobileInPc=e},setInEditorStatus(e){this.isInEditor=e},setCanvasStyle(e){e.component.seniorStyleSetting=e.component.seniorStyleSetting||g(N),this.canvasStyleData=e},setCanvasStyleScale(e){this.canvasStyleData.scale=e},setCanvasViewInfo(e){this.canvasViewInfo=e},getAppDataInfo(){return this.appData},setAppDataInfo(e){this.appData=e},setCurComponentMobileConfig(e){this.curComponent=e},setCurTabName(e){this.curTabName=e},setCurComponent({component:e,index:t}){var a,i;this.setCurTabName(null),this.setHiddenListStatus(!1),!e&&this.curComponent&&(this.curComponent.editing=!1,this.curComponent.resizing=!1,this.curComponent.dragging=!1,this.curComponent.canvasActive=!1,this.curComponent.canvasId!=="canvas-main"&&this.componentData.forEach(s=>{this.curComponent.canvasId.includes(s.id)&&(s.canvasActive=!1)})),this.curComponent||this.componentData.forEach(s=>{s.canvasActive=!1}),e&&(this.componentData.forEach(s=>{e.canvasId.includes(s.id)||(s.canvasActive=!1)}),this.curComponent?e.id!==this.curComponent.id&&(e.editing=!1):e.editing=!1),this.curComponent=e,this.curComponentIndex=t,this.curComponent&&this.curComponent.category&&(this.curComponent.component!=="Picture"||this.curComponent.component==="Picture"&&(!((a=this.curComponent.events)!=null&&a.checked)||((i=this.curComponent.events)==null?void 0:i.type)!=="displayChange"))&&(this.canvasState.curPointArea=this.curComponent.category),this.mobileInPc&&b().emitter.emit("curComponentChange",{type:"curComponentChange",value:this.curComponent?JSON.parse(JSON.stringify(this.curComponent)):null})},setBashMatrixInfo(e){this.bashMatrixInfo=e},setShapeStyle({top:e,left:t,width:a,height:i,rotate:s},n=[],o="move",l={}){if(this.curComponent.component==="GroupArea"&&n.length>0){const d=e-this.curComponent.style.top,r=t-this.curComponent.style.left,u=a-this.curComponent.style.width,f=i-this.curComponent.style.height;o==="move"?n.forEach(p=>{p.style.top=p.style.top+d,p.style.left=p.style.left+r,p.style.width=p.style.width+u,p.style.height=p.style.height+f}):n.forEach(p=>{const h=l[p.id];h&&(p.style.top=e+i*h.topRadio,p.style.left=t+a*h.leftRadio,p.style.width=a*h.widthRadio,p.style.height=i*h.heightRadio)})}this.dvInfo.type==="dashboard"?(e&&(this.curComponent.style.top=e<0?0:Math.round(e)),t&&(this.curComponent.style.left=t<0?0:Math.round(t)),a&&(this.curComponent.style.width=Math.round(a)),i&&(this.curComponent.style.height=Math.round(i)),s&&(this.curComponent.style.rotate=Math.round(s))):(e&&(this.curComponent.style.top=e),t&&(this.curComponent.style.left=t),a&&(this.curComponent.style.width=a),i&&(this.curComponent.style.height=i),s&&(this.curComponent.style.rotate=s))},setShapeSingleStyle({key:e,value:t}){this.curComponent.style[e]=t},setComponentData(e=[]){this.componentData=e},addCopyComponent(e,t,a=this.canvasViewInfo){e.canvasId==="canvas-main"?this.componentData.push(e):this.componentData.forEach(i=>{e.canvasId.includes(i.id)&&i.component=="DeTabs"&&i.propValue.forEach(s=>{e.canvasId.includes(s.name)&&s.componentData.push(e)})}),this.updateCopyCanvasView(t,a)},updateCopyCanvasView(e,t=this.canvasViewInfo){const a=this;e&&Object.keys(e).forEach(function(i){if(t[i]){const s=e[i],n={...g(t[i]),id:s,linkageActive:!1,jumpActive:!1};n.customAttrMobile=null,n.customStyleMobile=null,a.canvasViewInfo[s]=n}})},addComponent({component:e,index:t,isFromGroup:a=!1,componentData:i=this.componentData}){if(a){i.push(e);return}t!==void 0?(i.splice(t,0,e),this.setCurComponent({component:e,index:t})):(i.push(e),this.setCurComponent({component:e,index:i.length-1}));const s=z().fontList.find(n=>n.isDefault);if(e.component==="UserView"){const n=JSON.parse(JSON.stringify(k));e.innerType==="bar-range"&&(n.customStyle.xAxis.axisLine.show=!1,n.customStyle.xAxis.splitLine.show=!0,n.customStyle.yAxis.axisLine.show=!0,n.customStyle.yAxis.splitLine.show=!1);let o={...n,id:e.id,type:e.innerType,render:e.render,isPlugin:e.isPlugin,plugin:{isPlugin:e.isPlugin,staticMap:e.staticMap}};const l=I.getChartView(o.render,o.type);l&&(o=l.setupDefaultOptions(o),o.title=e.name),s&&(o.customStyle.text.fontFamily=s.name),this.canvasViewInfo[e.id]=o}if(e.component==="VQuery"){const{color:n,titleColor:o,labelColor:l,borderColor:d,bgColor:r,text:u,titleLayout:f,layout:p}=this.canvasStyleData.component.filterStyle||{},h={...JSON.parse(JSON.stringify(k)),id:e.id,title:A("visualization.query_component"),type:e.innerType,customStyle:{component:{show:!0,color:n,titleShow:!1,text:u,textColorShow:!1,labelColor:l,borderColor:d,title:"",borderWidth:1,bgColor:r,titleColor:o,titleLayout:f,layout:p,btnList:["sure"],fontSize:"14",labelShow:!0,fontWeight:"",fontStyle:"",fontSizeBtn:"14",fontWeightBtn:"",fontStyleBtn:"",queryConditionWidth:227,nameboxSpacing:8,placeholderShow:!0,placeholderSize:14,queryConditionSpacing:16,labelColorBtn:"#ffffff",btnColor:"#3370ff"}}};this.canvasViewInfo[e.id]=h}},setLinkageTargetInfo(e){this.linkageSettingStatus=!0,this.curLinkageView=this.curComponent,this.targetLinkageInfo=e},setFullscreenFlag(e){this.fullscreenFlag=e},removeViewFilter(e){this.componentData=this.componentData.map(t=>{const a=t;return a.filters=a.filters&&a.filters.filter(i=>i.componentId!==e)||[],a})},deleteComponentById(e,t=this.componentData){if(e){let a;t.forEach((i,s)=>{e===i.id&&(a=s)}),this.deleteComponent(a,t)}},deleteComponent(e,t=this.componentData){e===void 0&&(e=this.curComponentIndex),/\d/.test(e)&&(this.curComponentIndex=null,t.splice(e,1))},updateCurDvInfo(e){this.dvInfo=e,this.curOriginThemes=e.type==="dashboard"?"light":"dark"},matrixSizeAdaptor(){const{baseWidth:e,baseHeight:t,baseMarginLeft:a,baseMarginTop:i}=this.bashMatrixInfo;this.componentData.forEach(function(s){s.style.width=e*s.sizeX-a,s.style.height=t*s.sizeY-i,s.style.left=e*(s.x-1)+a,s.style.top=t*(s.y-1)+i})},clearTargetViewLinkage(e,t){if(t.linkageFilters&&t.linkageFilters.length>0){const a=t.linkageFilters.length,i=t.linkageFilters.filter(s=>s.sourceViewId!==e);t.linkageFilters.splice(0,t.linkageFilters.length),i.length>0&&i.forEach(s=>{t.linkageFilters.push(s)}),a!==i.length&&b().emitter.emit("query-data-"+t.id)}},clearViewLinkage(e){this.componentData.forEach(t=>{t.component==="UserView"&&t.innerType!="VQuery"?this.clearTargetViewLinkage(e,t):t.component==="Group"?t.propValue.forEach(a=>{this.clearTargetViewLinkage(e,a)}):t.component==="DeTabs"&&t.propValue.forEach(a=>{a.componentData.forEach(i=>{this.clearTargetViewLinkage(e,i)})})})},addCurBatchComponent(e){var i;const t=e.id,a=e.component;if(this.curBatchOptComponents.push(t),a==="UserView"){const s=this.canvasViewInfo[t],n=I.getChartView(s.render,s.type);n&&(this.curBatchOptComponents.length===1&&(this.changeProperties.customAttr=s.customAttr,this.changeProperties.customStyle=s.customStyle,this.changeProperties.customAttr.indicator=this.changeProperties.customAttr.indicator||g(U),this.changeProperties.customAttr.indicatorName=this.changeProperties.customAttr.indicatorName||g(W)),this.batchOptComponents[t]={properties:n.properties,propertyInner:n.propertyInner,value:n.name,componentType:a},this.setBatchOptComponentInfo())}else this.batchOptComponents[t]=q(a),this.setBatchOptComponentInfo();this.batchOptComponentType!=="UserView"&&(this.batchOptComponentInfo={collapseName:"background",commonBackground:g(this.curOriginThemes==="light"?D:E),style:{}},(i=this.mixPropertiesInner["common-style"])==null||i.forEach(s=>{this.batchOptComponentInfo.style[s]=F[s]}))},setBatchOptComponentInfo(){var e;if(this.batchOptComponents&&JSON.stringify(this.batchOptComponents)!=="{}"){const t={render:null,type:null};this.mixPropertiesAdaptor(t),this.batchOptComponentType==="UserView"?this.batchOptComponentInfo={...g(k),mode:"batchOpt",render:t.render,type:t.type,commonBackground:g(this.curOriginThemes==="light"?D:E),customAttr:this.changeProperties.customAttr,customStyle:this.changeProperties.customStyle}:(this.batchOptComponentInfo={collapseName:"background",commonBackground:g(this.curOriginThemes==="light"?D:E),style:{}},(e=this.mixPropertiesInner["common-style"])==null||e.forEach(a=>{this.batchOptComponentInfo.style[a]=F[a]}))}else this.batchOptComponentInfo=null},mixPropertiesAdaptor(e){this.mixProperties=[],this.mixPropertiesInner={};let t=[],a={},i=null;for(const s in this.batchOptComponents){const n=this.batchOptComponents[s];i?i=i===n.componentType?n.componentType:"mix":i=n.componentType,t.length>0?(t=t.filter(o=>n.properties.indexOf(o)>-1),t.forEach(o=>{a[o]&&n.propertyInner[o]&&(a[o]=a[o].filter(l=>n.propertyInner[o].indexOf(l)>-1))})):(t=g(n.properties),a=g(n.propertyInner)),e.type=e.type===null||e.type===n.value?n.value:"mix"}t.forEach(s=>{a[s]&&(this.mixPropertiesInner[s]=a[s],this.mixProperties.push(s))}),this.batchOptComponentType=i},setChangeProperties(e){if(this.batchOptComponentType==="UserView"){if(e.subProp){const t=V(e.value,e.subProp),a=this.changeProperties[e.custom][e.property];w(a,e.subProp,t)}else this.changeProperties[e.custom][e.property]=e.value;this.curBatchOptComponents.forEach(t=>{const a=this.canvasViewInfo[t];if(a.type.includes("chart-mix")&&e.property==="basicStyle"&&e.subProp){const i=V(e.value,e.subProp),s=a[e.custom][e.property];switch(w(s,e.subProp,i),e.subProp){case"alpha":const n=V(e.value,"subAlpha");w(s,"subAlpha",n);break;case"colorScheme":const o=V(e.value,"subColorScheme");w(s,"subColorScheme",o);break;case"seriesColor":const l=V(e.value,"subSeriesColor");w(s,"subSeriesColor",l);break;case"colors":const d=V(e.value,"subColors");w(s,"subColors",d);break;case"lineWidth":const r=V(e.value,"leftLineWidth");w(s,"leftLineWidth",r);break;case"lineSymbol":const u=V(e.value,"leftLineSymbol");w(s,"leftLineSymbol",u);break;case"lineSymbolSize":const f=V(e.value,"leftLineSymbolSize");w(s,"leftLineSymbolSize",f);break;case"lineSmooth":const p=V(e.value,"leftLineSmooth");w(s,"leftLineSmooth",p);break}}else if(e.subProp){const i=V(e.value,e.subProp),s=a[e.custom][e.property];w(s,e.subProp,i)}else a[e.custom][e.property]=e.value;["tablePageMode","tablePageSize"].includes(e.subProp)?b().emitter.emit("calcData-"+t,a):setTimeout(()=>{b().emitter.emit("renderChart-"+t,a)},0)})}else this.componentData.forEach(t=>{this.curBatchOptComponents.includes(t.id)&&(e.custom==="commonBackground"?t.commonBackground=g(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&t.style[e.property]&&(t.style[e.property]=e.value)),t.component==="Group"?t.propValue.forEach(a=>{this.curBatchOptComponents.includes(a.id)&&(e.custom==="commonBackground"?a.commonBackground=g(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&a.style[e.property]&&(a.style[e.property]=e.value))}):t.component==="DeTabs"&&t.propValue.forEach(a=>{a.componentData.forEach(i=>{this.curBatchOptComponents.includes(i.id)&&(e.custom==="commonBackground"?i.commonBackground=g(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&i.style[e.property]&&(i.style[e.property]=e.value))})})})},setBatchChangeBackground(e){this.componentData.forEach(t=>{t.component==="UserView"?this.curBatchOptComponents.includes(t.id)&&(t.commonBackground=g(e)):t.component==="Group"?t.propValue.forEach(a=>{this.curBatchOptComponents.includes(a.id)&&(a.commonBackground=g(e))}):t.component==="DeTabs"&&t.propValue.forEach(a=>{a.componentData.forEach(i=>{this.curBatchOptComponents.includes(i.id)&&(i.commonBackground=g(e))})})})},setBatchOptStatus(e){this.batchOptStatus=e,this.curBatchOptComponents=[],this.mixProperties=[],this.mixPropertiesInner={},this.batchOptComponentType=null,this.batchOptComponentInfo=null,this.batchOptComponents={},this.componentViewsData={},this.changeProperties={customStyle:{},customAttr:{}}},setHiddenListStatus(e){e!=null?this.hiddenListStatus=!!e:this.hiddenListStatus=!this.hiddenListStatus,this.setBatchOptStatus(!1)},removeCurBatchComponentWithId(e){for(let t=0;t<this.curBatchOptComponents.length;t++)if(this.curBatchOptComponents[t]===e){delete this.batchOptComponents[e],this.curBatchOptComponents.splice(t,1);break}if(this.curBatchOptComponents.length===1&&this.canvasViewInfo&&this.canvasViewInfo[this.curBatchOptComponents[0]]){const t=this.curBatchOptComponents[0],a=this.canvasViewInfo[t];this.changeProperties.customAttr=a.customAttr,this.changeProperties.customStyle=a.customStyle}this.curBatchOptComponents.length===0&&(this.changeProperties={customStyle:{},customAttr:{}}),this.setBatchOptComponentInfo()},removeCurMultiplexingComponentWithId(e){delete this.curMultiplexingComponents[e]},addCurMultiplexingComponent(e){e.componentId&&(this.curMultiplexingComponents[e.componentId]=e.component)},initCurMultiplexingComponents(){this.curMultiplexingComponents={}},addCanvasViewInfo(e,t){this.canvasViewInfo[e]=t},removeCanvasViewInfo(e){delete this.canvasViewInfo[e]},clearLinkageSettingInfo(){this.linkageSettingStatus=!1,this.curLinkageView=null,this.targetLinkageInfo=[]},setNowPanelTrackInfo(e){this.nowPanelTrackInfo=e},setNowPanelJumpInfo(e){this.nowPanelJumpInfo=e.baseJumpInfoMap},setNowPanelJumpInfoInner(e){this.nowPanelJumpInfo=e},setNowTargetPanelJumpInfo(e){this.nowPanelJumpInfoTargetPanel=e.baseJumpInfoVisualizationMap},setNowPanelOuterParamsInfoV2(e,t=this.dvInfo.id){this.nowPanelOuterParamsInfoV2[t]=e.outerParamsInfoMap,this.nowPanelOuterParamsBaseInfoV2[t]=e.outerParamsInfoBaseMap},addViewTrackFilter(e){const t=e.viewId;let a;e.option==="linkage"?(ae(this.canvasViewDataInfo[t],e),a=this.nowPanelTrackInfo):a=this.nowPanelJumpInfoTargetPanel;const i=[],s=[...e.dimensionList,...e.quotaList];for(let n=0;n<this.componentData.length;n++){const o=this.componentData[n];o.id!==t&&(["UserView","VQuery"].includes(o.component)?(this.trackFilterCursor(o,s,a,i,t),this.componentData[n]=o):o.component==="Group"?o.propValue.forEach((l,d)=>{this.trackFilterCursor(l,s,a,i,t),o.propValue[d]=l}):o.component==="DeTabs"&&o.propValue.forEach(l=>{l.componentData.forEach((d,r)=>{this.trackFilterCursor(d,s,a,i,t),l.componentData[r]=d})}))}i.forEach(n=>{b().emitter.emit("query-data-"+n)})},addWebParamsFilter(e,t=this.componentData){if(e)for(let a=0;a<t.length;a++){const i=t[a];["UserView"].includes(i.component)?(this.trackWebFilterCursor(i,e),this.componentData[a]=i):i.component==="Group"?i.propValue.forEach((s,n)=>{this.trackWebFilterCursor(s,e),i.propValue[n]=s}):i.component==="DeTabs"&&i.propValue.forEach(s=>{s.componentData.forEach((n,o)=>{this.trackWebFilterCursor(n,e),s.componentData[o]=n})})}},addOuterParamsFilter(e,t=this.componentData,a="inner",i=this.dvInfo.id){const s={},n=e&&e.outerParamsVersion||"v1";if(this.nowPanelOuterParamsBaseInfoV2[i]){let o=0,l="";if(Object.keys(this.nowPanelOuterParamsBaseInfoV2[i]).forEach(d=>{const r=this.nowPanelOuterParamsBaseInfoV2[i][d],u=e?e[d]:null,f=!u||u.length===0;r.required&&f?(o++,l=l+"["+d+"]"):f&&r.enabledDefault&&r.defaultValue&&r.defaultValue.length>0?s[d]=JSON.parse(r.defaultValue):f||(s[d]=e[d])}),o>0)throw Y.error("参数"+l+"不能为空"),new Error("参数"+l+"不能为空")}else return;if(s){const o=[],l=this.nowPanelOuterParamsInfoV2[i];for(let d=0;d<t.length;d++){const r=t[d];["UserView","VQuery"].includes(r.component)?(this.trackOuterFilterCursor(r,s,o,l,a,n),this.componentData[d]=r):r.component==="Group"?r.propValue.forEach((u,f)=>{this.trackOuterFilterCursor(u,s,o,l,a,n),r.propValue[f]=u}):r.component==="DeTabs"&&r.propValue.forEach(u=>{u.componentData.forEach((f,p)=>{this.trackOuterFilterCursor(f,s,o,l,a,n),u.componentData[p]=f})})}}},trackWebFilterCursor(e,t){t[e.id]&&(e.webParamsFilters=t[e.id],b().emitter.emit("query-data-"+e.id))},trackOuterFilterCursor(e,t,a,i,s,n="v1"){if(!["UserView","VQuery"].includes(e.component)||e.category==="hidden"&&!this.canvasStyleData.popupAvailable)return;const o=[];Object.keys(t).forEach(function(l){let d,r,u,f;n==="v2"?(d=t[l].operator,r=t[l].value,u=t[l].value,f=t[l].value):(r=t[l],u=t[l],f=t[l]);let p="in";r&&!Array.isArray(r)?(r=[r],p="eq"):r&&Array.isArray(r)&&(u="",r.forEach((m,y)=>{y===0?u=m:u=u+","+m})),(i[l]||[]).forEach(m=>{var O;const y=m.split("#"),S=y[0];if(e.component==="UserView"&&e.id===S){if(u!=="DE_EMPTY"){const v=y[1],c={fieldId:v,operator:d||p,value:r,viewIds:[S]};let C=o.length;for(;C--;){const P=o[C];v===P.fieldId&&P.viewIds.includes(S)&&o.splice(C,1)}o.push(c)}a.push(e.id)}if(e.component==="VQuery"){const v={};e.propValue.forEach(c=>{if(c.id===S){let C=r;["1","7"].includes(c.displayType)||(C=r.map(P=>String(P))),c.defaultMapValue=[],c.mapValue=[],c.defaultValueCheck=!0,c.timeType="fixed",["0","2"].includes(c.displayType)?(c.multiple?(c.selectValue=C,c.defaultValue=C):(c.selectValue=C[0],c.defaultValue=C[0]),c.defaultMapValue=C,c.mapValue=C):c.displayType==="1"?(c.selectValue=C[0],c.defaultValue=C[0]):c.displayType==="7"?(c.selectValue=C,c.defaultValue=C):c.displayType==="8"&&(c.conditionValueF=f+"",c.defaultConditionValueF=f+""),u==="DE_EMPTY"&&(c.selectValue=null,c.defaultValue=null,c.conditionValueF=null,c.defaultConditionValueF=null),c.defaultValue&&(v[c.id]=c.defaultValue)}}),(O=e.cascade)!=null&&O.length&&Object.keys(v).length&&e.cascade.forEach(c=>{Object.keys(v).forEach(C=>{const P=v[C];c.length&&c.forEach(T=>{T.datasetId.includes(C)&&P?T.currentSelectValue=Array.isArray(P)?P:[P]:T.currentSelectValue=[]})})})}})}),e.component==="UserView"&&(e.outerParamsFilters=o),s==="outer"&&a.forEach(l=>{b().emitter.emit("query-data-"+l)})},trackFilterCursor(e,t,a,i,s){let n=e.linkageFilters||[];["table-info","table-normal"].includes(e.innerType)&&(n=[]),t.forEach(o=>{const l=s+"#"+o.id,d=a[l]||[],r=[o.value];d.forEach(u=>{const f=u.split("#"),p=f[0];if(e.component==="UserView"&&e.id===p){const h=f[1];let m;o.timeValue&&Array.isArray(o.timeValue)?m={fieldId:h,operator:"between",value:o.timeValue,viewIds:[p],sourceViewId:s}:m={fieldId:h,operator:"eq",value:[o.value],viewIds:[p],sourceViewId:s};let y=n.length;for(;y--;){const S=n[y];h===S.fieldId&&S.viewIds.includes(p)&&n.splice(y,1)}n.push(m),i.includes(e.id)||i.push(e.id)}e.component==="VQuery"&&e.propValue.forEach(h=>{if(h.id===p){let m=r;if(["1","7"].includes(h.displayType)||(m=r.map(y=>String(y))),h.defaultValueCheck=!0,h.timeType="fixed",["0","2"].includes(h.displayType)){const{optionValueSource:y,field:S,displayId:O}=h,v=y===1&&S.id!==O;let c=m;v&&(c=ie(m,S.id)),h.multiple?(h.selectValue=m,h.defaultValue=m):(h.selectValue=m[0],h.defaultValue=m[0]),h.defaultMapValue=c,h.mapValue=c}else h.displayType==="1"?(h.selectValue=m[0],h.defaultValue=m[0]):h.displayType==="7"?o.timeValue&&Array.isArray(o.timeValue)?(h.selectValue=o.timeValue,h.defaultValue=o.timeValue):(h.selectValue=m,h.defaultValue=m):h.displayType==="8"&&(h.conditionValueF=m[0],h.defaultConditionValueF=m[0])}})})}),e.linkageFilters=n},clearPanelLinkageInfo(){this.componentData.forEach(e=>{e.component==="UserView"?e.linkageFilters&&e.linkageFilters.length>0&&(e.linkageFilters.splice(0,e.linkageFilters.length),b().emitter.emit("query-data-"+e.id)):e.component==="Group"?e.propValue.forEach(t=>{t.linkageFilters&&t.linkageFilters.length>0&&(t.linkageFilters.splice(0,t.linkageFilters.length),b().emitter.emit("query-data-"+t.id))}):e.component==="DeTabs"&&e.propValue.forEach(t=>{t.componentData.forEach(a=>{a.linkageFilters&&a.linkageFilters.length>0&&(a.linkageFilters.splice(0,a.linkageFilters.length),b().emitter.emit("query-data-"+a.id))})})})},setTabCollisionActiveId(e){this.tabCollisionActiveId=e},setTabMoveInActiveId(e){this.tabMoveInActiveId=e},setMousePointShadowMap(e){this.mousePointShadowMap.mouseX=e.mouseX,this.mousePointShadowMap.mouseY=e.mouseY,this.mousePointShadowMap.width=e.width,this.mousePointShadowMap.height=e.height},setTabMoveOutComponentId(e){this.tabMoveOutComponentId=e},resetDvInfo(){this.dvInfo={dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1,contentId:0},this.mainScrollTop=0},setViewDataDetails(e,t){this.canvasViewDataInfo[e]=t.data;const a=this.canvasViewInfo[e];if(a){const i=a.calParams?a.calParams.reduce((s,n)=>(s[n.id]=n.value,s),{}):{};t.calParams&&t.calParams.forEach(s=>{i[s.id]&&(s.value=i[s.id])}),this.canvasViewInfo[e].calParams=t.calParams||null}},getViewDataDetails(e){return this.canvasViewDataInfo[e]},setViewOriginData(e,t){this.canvasViewOriginDataInfo[e]=t},getViewOriginData(e){return this.canvasViewOriginDataInfo[e]},setViewInstanceInfo(e,t){this.canvasViewInstanceInfo[e]=t},getViewInstanceInfo(e){return this.canvasViewInstanceInfo[e]},setLastViewRequestInfo(e,t){this.lastViewRequestInfo[e]=t},getLastViewRequestInfo(e){return this.lastViewRequestInfo[e]},getViewDetails(e){return this.canvasViewInfo[e]},updateDvInfoId(e,t){this.dvInfo&&(this.dvInfo.dataState="ready",this.dvInfo.optType=null,e&&(this.dvInfo.id=e),t&&(this.dvInfo.contentId=t))},popAreaActiveSwitch(){this.canvasState.curPointArea==="base"?this.canvasState.curPointArea="hidden":this.canvasState.curPointArea="base"},canvasStateChange({key:e,value:t}){this.canvasState[e]&&t&&(this.canvasState[e]=t)},createInit(e,t,a,i,s){const n=A(e==="dashboard"?"visualization.new_dashboard":"visualization.new_screen"),o=s||n;this.hiddenListStatus=!1,this.dvInfo={dataState:"prepare",optType:null,id:t,name:o,pid:a,type:e,status:1,selfWatermarkStatus:!0,watermarkInfo:i,mobileLayout:!1,contentId:"0",weight:9};const l=e==="dashboard"?R:H;this.canvasStyleData=g(l),this.componentData=[],this.canvasViewInfo={}},removeLinkageInfo(e){e&&this.nowPanelTrackInfo&&(Object.keys(this.nowPanelTrackInfo).forEach(t=>{const a=this.nowPanelTrackInfo[t];for(let i=0;i<a.length;i++)a[i].indexOf(e)>-1&&(a.splice(i,1),i--)}),Object.keys(this.nowPanelTrackInfo).forEach(t=>{(t.indexOf(e)>-1||this.nowPanelTrackInfo[t].length===0)&&delete this.nowPanelTrackInfo[t]}))},canvasDataInit(){this.canvasViewInfo={},this.componentData=[],this.dvInfo={dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1,contentId:"0"},this.canvasStyleData={...g(L),backgroundColor:null}},removeGroupArea(e=this.componentData){const t=e==null?void 0:e.filter(a=>(a==null?void 0:a.component)==="GroupArea");t&&t.length>0&&t.forEach(a=>{this.deleteComponentById(a.id,e)})}}}),Ce=()=>ne(x);export{Ce as d,ge as f,ae as v};
