import"./chart-0.0.0-dataease.js";import{a3 as defineStore,G as computed,am as toRaw}from"./vue-0.0.0-dataease.js";import{a5 as store}from"./index-0.0.0-dataease.js";import{x as request,o as useI18n,U as useLinkStoreWithOut,D as ElMessage}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as innerExportDataSetDetails,a as innerExportDetails}from"./chart-0.0.0-dataease2.js";import{useAppStoreWithOut}from"./app-0.0.0-dataease.js";import{E as isNumber}from"./lodash-0.0.0-dataease.js";const useMapStore=defineStore("map",{state:()=>({mapCache:{},mapKey:{key:"",securityCode:""}}),actions:{setMap({id:e,geoJson:s}){this.mapCache[e]=s},setKey(e){this.mapKey=e}}}),useMapStoreWithOut=()=>useMapStore(store),getWorldTree=()=>request.get({url:"/map/worldTree"}),getGeoJson=e=>{let s="/map",o=e;isCustomGeo(e)&&(s="/geo",o=getBusiGeoCode(e));const n=o.substring(0,3),i=`${s}/${n}/${o}.json`;return request.get({url:i})},isCustomGeo=e=>e.startsWith("geo_"),getBusiGeoCode=e=>e.substring(4),listCustomGeoArea=()=>request.get({url:"/customGeo/geoArea/list"}),getCustomGeoArea=e=>request.get({url:`/customGeo/geoArea/${e}`}),deleteCustomGeoArea=e=>request.delete({url:`/customGeo/geoArea/${e}`}),saveCustomGeoArea=e=>request.post({url:"/customGeo/geoArea/save",data:e}),deleteCustomGeoSubArea=e=>request.delete({url:`/customGeo/geoSubArea/${e}`}),saveCustomGeoSubArea=e=>request.post({url:"/customGeo/geoSubArea/save",data:e}),listSubAreaOptions=()=>request.get({url:"/customGeo/geoSubArea/options"}),appStore=useAppStoreWithOut(),isDataEaseBi=computed(()=>appStore.getIsDataEaseBi),{t}=useI18n();function hexColorToRGBA(hex,alpha){let rgb=[];if(hex.indexOf("#")>-1){if(/^\#[0-9A-F]{3}$/i.test(hex)){let e="#";hex.replace(/[0-9A-F]/gi,function(s){e+=s+s}),hex=e}return/^#[0-9A-F]{6}$/i.test(hex)?(hex.replace(/[0-9A-F]{2}/gi,function(kw){rgb.push(eval("0x"+kw))}),`rgba(${rgb.join(",")},${alpha/100})`):"rgb(0,0,0)"}else return rgb=hex.match(/\d+/g),`rgba(${rgb.join(",")},${alpha/100})`}const quotaViews=["label","richTextView","indicator","gauge","liquid"],mapChartTypes=["bubble-map","flow-map","heat-map","map","symbolic-map"],distributionChartTypes=["pie","pie-donut","pie-rose","pie-donut-rose","radar","treemap","word-cloud"],relationChartTypes=["scatter","quadrant","funnel","sankey","circle-packing"],notSupportAccumulateViews=[...quotaViews,...mapChartTypes,...distributionChartTypes,...relationChartTypes,"table-info","t-heatmap","percentage-bar-stack","percentage-bar-stack-horizontal","progress-bar","stock-line"];function handleEmptyDataStrategy(e,s){const{data:o}=s,n=e.type.includes("chart-mix");if(!(o!=null&&o.length))return s;const i=parseJson(e.senior).functionCfg.emptyDataStrategy;if(i==="ignoreData"){if(n)for(let c=0;c<o.length;c++)handleIgnoreData(o[c]);else handleIgnoreData(o);return s}const{yAxis:a,xAxisExt:r,extStack:l}=e,f=(a==null?void 0:a.length)>=2||(r==null?void 0:r.length)>0||(l==null?void 0:l.length)>0;switch(i){case"breakLine":{if(f)if(n)for(let c=0;c<o.length;c++)handleBreakLineMultiDimension(o[c]);else handleBreakLineMultiDimension(o);return{...s,connectNulls:!1}}case"setZero":{if(f)if(n)for(let c=0;c<o.length;c++)handleSetZeroMultiDimension(o[c]);else handleSetZeroMultiDimension(o);else if(n)for(let c=0;c<o.length;c++)handleSetZeroSingleDimension(o[c]);else handleSetZeroSingleDimension(o);break}}return s}function handleBreakLineMultiDimension(e){const s=new Map,o=new Set,n=new Map;for(let a=0;a<e.length;a++){const r=e[a],l=s.get(r.field);l?l.set.add(r.category):s.set(r.field,{set:new Set([r.category]),index:a}),o.add(r.category),n.set(r.category,r.quotaList)}let i=0;s.forEach((a,r)=>{if(a.set.size<o.size){let l=0;o.forEach(f=>{a.set.has(f)||e.splice(a.index+i+l,0,{field:r,value:null,category:f,quotaList:n.get(f)}),l++}),i+=o.size-a.set.size}})}function handleSetZeroMultiDimension(e){const s=new Map,o=new Set,n=new Map;for(let a=0;a<e.length;a++){const r=e[a];r.value===null&&(r.value=0);const l=s.get(r.field);l?l.set.add(r.category):s.set(r.field,{set:new Set([r.category]),index:a}),o.add(r.category),n.set(r.category,r.quotaList)}let i=0;s.forEach((a,r)=>{if(a.set.size<o.size){let l=0;o.forEach(f=>{a.set.has(f)||e.splice(a.index+i+l,0,{field:r,value:0,category:f,quotaList:n.get(f)}),l++}),i+=o.size-a.set.size}})}function handleSetZeroSingleDimension(e){e.forEach(s=>{s.value===null&&(s.value=0)})}function handleIgnoreData(e){for(let s=e.length-1;s>=0;s--)e[s].value===null&&e.splice(s,1)}function resetRgbOpacity(e,s){if(e!=null&&e.startsWith("rgb")){const o=e.match(/(\d(\.\d+)?)+/g);if((o==null?void 0:o.length)===4){const n=parseFloat(o[3]);if(isNumber(n)){let i=parseFloat((n*s).toFixed(2));return i>1&&(i=1),`rgba(${o.slice(0,3).concat(i.toString()).join(",")})`}}}return e}function parseJson(e){return typeof e!="string"?e:JSON.parse(e)}function flow(...e){return(s,o,n,i)=>e.reduce((a,r)=>i?r.call(i,s,a,n):r(s,a,n),o)}const isParent=(e,s)=>{let o=e;for(;o;){if(o===s)return!0;o=o.__proto__}return!1},getGeoJsonFile=async e=>{const s=useMapStoreWithOut();let o=s.mapCache[e];return o||(o=(await getGeoJson(e)).data,s.setMap({id:e,geoJson:o})),toRaw(o)},getExcelDownloadRequest=(e,s)=>{var c;let o=JSON.parse(JSON.stringify(e.fields));["gauge","liquid"].includes(s)&&o.length>1&&(o=o.slice(1));const n=JSON.parse(JSON.stringify(e.tableRow)),i=o.map(u=>u.chartShowName??u.name),a=o.map(u=>u.deType),r=o.map(u=>u.dataeaseName);let l=n.map(u=>r.map(p=>u[p])),f=[];return(c=e.detailFields)!=null&&c.length&&(f=e.detailFields.map(u=>({name:u.name,deType:u.deType,dataeaseName:u.dataeaseName})),l=n.map(u=>r.map(p=>{if(p==="detail"&&!u[p]&&Array.isArray(u.details)){const h=u.details;return h!=null&&h.length?h.map(g=>f.map(d=>g[d.dataeaseName])):null}return u[p]}))),{header:i,details:l,excelTypes:a,excelHeaderKeys:r,detailFields:f}},exportExcelDownload=(e,s)=>{var r,l,f;const o=e.title;let n={proxy:null,dvId:e.sceneId,viewId:e.id,viewInfo:e,viewName:o,busiFlag:e.busiFlag,downloadType:e.downloadType};if(e.type.includes("chart-mix")){const c=getExcelDownloadRequest(e.data.left),u=getExcelDownloadRequest(e.data.right);n={...n,multiInfo:[c,u]},e.downloadType==="dataset"&&delete n.multiInfo}else{const c=getExcelDownloadRequest(e.data,e.type);n={...n,...c}}e.type.includes("symbolic-map")&&(n.detailFields=[]);const i=useLinkStoreWithOut();(isDataEaseBi.value||appStore.getIsIframe)&&(n.dataEaseBi=!0);const a=n.downloadType==="dataset"?innerExportDataSetDetails:innerExportDetails;(f=(l=(r=n.viewInfo)==null?void 0:r.customAttr)==null?void 0:l.basicStyle)!=null&&f.tablePageMode&&(n.viewInfo.customAttr.basicStyle.tablePageMode="page"),a(n).then(c=>{if(i.getLinkToken||isDataEaseBi.value||appStore.getIsIframe){const u=new Blob([c.data],{type:"application/vnd.ms-excel"}),p=document.createElement("a");p.style.display="none",p.href=URL.createObjectURL(u),p.download=o+".xlsx",document.body.appendChild(p),p.click(),document.body.removeChild(p)}else s&&s(c)}).catch(()=>{console.error("Excel download error"),s("error")})},copyString=(e,s=!1)=>{(navigator.clipboard||{writeText:n=>new Promise(i=>{const a=document.createElement("textarea");a.setAttribute("style","z-index: -1;position: fixed;opacity: 0;"),a.value=n,document.body.appendChild(a),a.select(),document.execCommand("copy"),a.remove(),i()})}).writeText(e).then(()=>{s&&ElMessage.success(t("commons.copy_success"))})},getDynamicColorScale=(e,s,o,n)=>{const i=(s-e)/o,a=[];for(let r=0;r<o;r++)a.push({value:[e+r*i,e+(r+1)*i],color:n==null?void 0:n[r],label:`${(e+r*i).toFixed(0)} - ${(e+(r+1)*i).toFixed(0)}`});return a},filterChartDataByRange=(e,s,o)=>e.filter(n=>n.value===null||n.value===void 0||n.value>=o&&n.value<=s),getMaxAndMinValueByData=(e,s,o,n,i)=>{const a=r=>e.reduce((l,f)=>r?f[s]>l?f[s]:l:f[s]<l?f[s]:l,r?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER);if(n===null||o===null){let r=o,l=n;r===null&&(r=a(!0)),l===null&&(l=a(!1)),i(r,l)}if(n===0&&o===0){const r=a(!0),l=a(!1);i(r,l)}},stepsColor=(e,s,o,n)=>{let i,a,r,l;const f=[],c=[];n=n||1;const u=function(g){return Math.pow(g/255,n)};for(e=p(e).map(u),s=p(s).map(u),i=0;i<o;i++){for(r=o-1===0?0:i/(o-1),l=1-r,a=0;a<3;a++)c[a]=h(Math.round(Math.pow(e[a]*l+s[a]*r,1/n)*255).toString(16));f.push("#"+c.join(""))}function p(g){return g.length===4?g.substr(1).split("").map(function(d){return 17*parseInt(d,16)}):[g.substr(1,2),g.substr(3,2),g.substr(5,2)].map(function(d){return parseInt(d,16)})}function h(g){return g.length===1?"0"+g:g}return f},getMapColorCases=e=>JSON.parse(JSON.stringify(e)).map(o=>{let n=o.colors;["fresh","red","spiritual"].includes(o.value)&&(n=o.colors.reverse());const i=n.length,a=n[0],r=n[i-1];return{name:o.name,value:o.value+"_split_gradient",baseColors:[a,r],colors:stepsColor(a,r,9,1)}});function getColor(e){const s=parseJson(e.customAttr).basicStyle,{seriesColor:o}=s;if(o!=null&&o.length){const{yAxis:n}=e,i=o.reduce((r,l)=>(r[l.id]=l,r),{});return n==null||n.forEach((r,l)=>{const f=i[r.id];f&&(l+1>s.colors.length?s.colors.push(f.color):s.colors[l]=f.color)}),s.colors.map(r=>hexColorToRGBA(r,s.alpha))}}function setupSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,a=e.yAxis;return a==null||a.forEach(r=>{n.has(r.id)||(n.add(r.id),o.push({id:r.id,name:r.chartShowName??r.name,color:i[(n.size-1)%i.length]}))}),o}function getGroupColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,u)=>(c[u.id]=u,c),{}),{yAxis:a,xAxisExt:r}=e,{data:l}=s;if(r!=null&&r.length){const c=new Set;l==null||l.forEach(p=>p.category!==null&&c.add(p.category)),[...c].forEach((p,h)=>{const g=i[p];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}else a==null||a.forEach((c,u)=>{const p=i[c.id];p&&(u+1>o.colors.length?o.colors.push(p.color):o.colors[u]=p.color)});return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpGroupSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{yAxis:a,xAxisExt:r}=e;return r!=null&&r.length?s==null||s.forEach(l=>{l.value===null||l.category===null||n.has(l.category)||(n.add(l.category),o.push({id:l.category,name:l.category,color:i[(n.size-1)%i.length]}))}):a==null||a.forEach(l=>{n.has(l.id)||(n.add(l.id),o.push({id:l.id,name:l.chartShowName??l.name,color:i[(n.size-1)%i.length]}))}),o}function getStackColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,u)=>(c[u.id]=u,c),{}),{yAxis:a,extStack:r}=e,{data:l}=s;if(r!=null&&r.length){const c=new Set;l==null||l.forEach(p=>p.category!==null&&c.add(p.category)),[...c].forEach((p,h)=>{const g=i[p];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}else a==null||a.forEach((c,u)=>{const p=i[c.id];p&&(u+1>o.colors.length?o.colors.push(p.color):o.colors[u]=p.color)});return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpStackSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{yAxis:a,extStack:r}=e;return r!=null&&r.length?s==null||s.forEach(l=>{l.value===null||l.category===null||n.has(l.category)||(n.add(l.category),o.push({id:l.category,name:l.category,color:i[(n.size-1)%i.length]}))}):a==null||a.forEach(l=>{n.has(l.id)||(n.add(l.id),o.push({id:l.id,name:l.chartShowName??l.name,color:i[(n.size-1)%i.length]}))}),o}function getSingleDimensionColor(e,s){const{basicStyle:o}=parseJson(e.customAttr),{seriesColor:n}=o;if(!(n!=null&&n.length))return;const i=n.reduce((c,u)=>(c[u.id]=u,c),{}),{xAxis:a,yAxis:r}=e,{data:l}=s;if(a!=null&&a.length&&(r!=null&&r.length)){const c=new Set;l==null||l.forEach(p=>p.field!==null&&c.add(p.field)),[...c].forEach((p,h)=>{const g=i[p];g&&(h+1>o.colors.length?o.colors.push(g.color):o.colors[h]=g.color)})}return o.colors.map(c=>hexColorToRGBA(c,o.alpha))}function setUpSingleDimensionSeriesColor(e,s){const o=[],n=new Set,i=e.customAttr.basicStyle.colors,{xAxis:a,yAxis:r}=e;return a!=null&&a.length&&(r!=null&&r.length)&&(s==null||s.forEach(l=>{n.has(l.field)||(n.add(l.field),o.push({id:l.field,name:l.field,color:i[(n.size-1)%i.length]}))})),o}function isAlphaColor(e){return e!=null&&e.trim()?e.startsWith("#")?e.length===9:e.startsWith("rgb")?e.split(",").length===4:!1:!1}function getColorFormAlphaColor(e){if(isAlphaColor(e)){if(e.startsWith("#"))return e.slice(0,7);if(e.startsWith("rgb")||e.startsWith("RGB")){const s=e.split(",");return s[0]+","+s[1]+","+s[2]+")"}}return e}function isTransparent(e){if(!(e!=null&&e.trim()))return!0;if(e.startsWith("#")){const s=e.substring(1,e.length);if(s.length===3||s.length===6)return!1;if(s.length===8)return s.substring(6,8)==="00"}if(e.startsWith("rgb")){const s=e.split(",");return s.length!==4?!1:s[3].substring(0,s[3].length-1).trim()==="0"}return!1}function convertToAlphaColor(e,s){if(!(e!=null&&e.trim()))return"rgba(255,255,255,1)";if(e.startsWith("#")){let o=e.trim().substring(1);if(o.length===3){const i=o.split("");o=`${i[0]}${i[0]}${i[1]}${i[1]}${i[2]}${i[2]}`}if(o.length!==6)return"#FFFFFFFF";const n=parseInt((s*2.55).toFixed(0)).toString(16).toUpperCase();return`#${o}${n}`}return e.startsWith("rgb")?`rgba(${e.match(/\d+/g).join(",")},${s/100})`:"rgba(255,255,255,1)"}function svgStrToUrl(e){let s="";try{if(e){const o=new Blob([e],{type:"image/svg+xml"});s=URL.createObjectURL(o)}}catch{}return s}function filterEmptyMinValue(e,s){let o=0;return getMaxAndMinValueByData(e.filter(n=>n[s]),"value",0,0,(n,i)=>{o=i}),o}function getLineConditions(e){var n;const{threshold:s}=parseJson(e.senior),o=[];return s.enable&&((n=s.lineThreshold)==null||n.forEach(i=>{var a;return(a=i.conditions)==null?void 0:a.forEach(r=>o.push({fieldId:i.fieldId,term:r.term,value:r.value,color:r.color,min:r.min,max:r.max}))})),o}function getLineLabelColorByCondition(e,s,o){const n=e.filter(a=>a.fieldId===o);let i;return n.length&&n.some(a=>{if(a.term==="lt"&&s<=a.value||a.term==="gt"&&s>=a.value||a.term==="between"&&s>=a.min&&s<=a.max)return i=a.color,!0}),i}const measureText=(e,s,o,n)=>{const r=document.getElementById(e.container).querySelector("canvas").getContext("2d"),{fontWeight:l,fontSize:f,fontFamily:c}=o;r.font=[l,`${f}px`,c].join(" ").trim();const u=r.measureText(s);return n==="height"?u.actualBoundingBoxAscent+u.actualBoundingBoxDescent:n==="width"?u.actualBoundingBoxRight+u.actualBoundingBoxLeft:0},hexToRgba=(e,s=1)=>{if(!e.startsWith("#"))return e;e=e.replace("#","");const o=parseInt(e.slice(0,2),16),n=parseInt(e.slice(2,4),16),i=parseInt(e.slice(4,6),16),r=e.slice(6,8)?parseInt(e.slice(6,8),16)/255:s;return`rgba(${o}, ${n}, ${i}, ${r})`};export{isAlphaColor as A,copyString as B,isTransparent as C,isParent as D,exportExcelDownload as E,getWorldTree as F,listCustomGeoArea as G,quotaViews as H,notSupportAccumulateViews as I,getMapColorCases as J,stepsColor as K,convertToAlphaColor as L,saveCustomGeoArea as M,deleteCustomGeoArea as N,listSubAreaOptions as O,saveCustomGeoSubArea as P,deleteCustomGeoSubArea as Q,hexToRgba as a,handleEmptyDataStrategy as b,getGroupColor as c,getStackColor as d,getSingleDimensionColor as e,flow as f,getColor as g,hexColorToRGBA as h,setUpStackSeriesColor as i,setUpGroupSeriesColor as j,getLineConditions as k,getLineLabelColorByCondition as l,measureText as m,getCustomGeoArea as n,getGeoJsonFile as o,parseJson as p,getMaxAndMinValueByData as q,filterChartDataByRange as r,setupSeriesColor as s,getDynamicColorScale as t,useMapStoreWithOut as u,filterEmptyMinValue as v,getColorFormAlphaColor as w,svgStrToUrl as x,setUpSingleDimensionSeriesColor as y,resetRgbOpacity as z};
