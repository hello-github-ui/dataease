import{e as w}from"./eventBus-0.0.0-dataease.js";import{d as K}from"./dvMain-0.0.0-dataease.js";import{s as ne}from"./snapshot-0.0.0-dataease.js";import{d as $,s as C}from"./pinia-0.0.0-dataease.js";import{e as T}from"./index-0.0.0-dataease.js";import{g as ye}from"./util-0.0.0-dataease.js";import{j as ve,$ as Ce,A as g}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{b as De}from"./canvasStyle-0.0.0-dataease.js";import{e as ge,g as Se,h as we}from"./dataVisualization-0.0.0-dataease2.js";import{c as W,g as Ie,a as xe}from"./style-0.0.0-dataease.js";import{e as ke,l as ae,m as Ae,n as Ee,p as Ke}from"./canvasUtils-0.0.0-dataease.js";const Ge=$("contextmenu",{state:()=>({menuTop:0,menuLeft:0,menuShow:!1,position:"canvasCore"}),actions:{showContextMenu({top:e,left:t,position:o}){this.menuShow=!0,this.menuTop=e,this.menuLeft=t,this.position=o},hideContextMenu(){this.menuShow=!1}}}),be=()=>Ge(T);function B(e,t,o,a="canvas-main"){e.style.left=e.style.left+o.left,e.style.top=e.style.top+o.top,e.groupStyle={},e.canvasId=a}const se=()=>ye(),{t:_}=ve(),x=K(),{curComponent:I,componentData:h,curOriginThemes:Me}=C(x),Oe=$("compose",{state:()=>({areaData:{style:{top:0,left:0,width:0,height:0},components:[]},editorMap:{},isCtrlOrCmdDown:!1,isSpaceDown:!1,isShiftDown:!1,laterIndex:null,editor:null}),actions:{getEditor(e="canvas-main"){this.editorMap[e]=Ce("#editor-"+e)},setLaterIndex(e){this.laterIndex=e},setSpaceDownStatus(e){this.isSpaceDown=e},setIsCtrlOrCmdDownStatus(e){this.isCtrlOrCmdDown=e},setIsShiftDownStatus(e){this.isShiftDown=e},setAreaData(e){this.areaData=e},updateGroupBorder(e){if(e){const t=e.replace("Group-",""),o=h.value.filter(n=>n.id===t)[0],a=o.propValue,s={...o.style};a.forEach(n=>{B(n,null,s)});const i={style:{top:0,left:0,width:0,height:0},components:a};this.calcComposeArea(i),o.style={...o.style,...i.style},a.forEach(n=>{n.canvasId=e}),W(o)}},alignment:function(e){const{areaData:t}=this;if(t.components.length===1){t.components=[];return}t.components.length>0&&t.style.width===0&&this.calcComposeArea();const{left:o,top:a,width:s,height:i}=t.style,n=o+s,c=o+s/2,u=a+i,f=a+i/2;t.components.forEach(r=>{e==="left"?r.style.left=o:e==="right"?r.style.left=n-r.style.width:e==="top"?r.style.top=a:e==="bottom"?r.style.top=u-r.style.height:e==="transverse"?r.style.left=c-r.style.width/2:e==="direction"&&(r.style.top=f-r.style.height/2)})},compose:function(e="canvas-main"){const t=this.editorMap[e],{areaData:o}=this;if(o.components.length===1){o.components=[];return}o.components.length>0&&this.calcComposeArea();const a=[];o.components.forEach(n=>{if(["Group"].includes(n.component)){const c={...n.style},u=n.propValue,f=t.getBoundingClientRect();u.forEach(r=>{B(r,f,c)}),a.push(...n.propValue)}else["GroupArea"].includes(n.component)||ke(n)&&a.push(n)});const s=se();a.forEach(n=>{n.canvasId="Group-"+s});const i=g({id:s,component:"Group",canvasActive:!1,name:_("visualization.view_group"),label:_("visualization.view_group"),icon:"group",expand:!0,commonBackground:{...ge[Me.value],backgroundColorSelect:!1,innerPadding:0},...Se,style:{...we,...o.style},propValue:a});W(i),x.addComponent({component:i,index:void 0}),w.emit("hideArea-canvas-main"),this.batchDeleteComponent(o.components),x.setCurComponent({component:h.value[h.value.length-1],index:h.value.length-1}),this.areaData.components=[]},batchDeleteComponent(e){e.forEach(t=>{if(!["GroupArea"].includes(t.component)){for(let o=0,a=h.value.length;o<a;o++)if(t.id==h.value[o].id){h.value.splice(o,1);break}}})},decompose(){const e=I.value.canvasId,t=this.editorMap[e],o={...I.value.style},a=I.value.propValue,s=t.getBoundingClientRect(),i=ae(e);let n=h.value;if(i){const c={};h.value.forEach(r=>{Ae(r,null,c)});const f=c[I.value.id].propValue.filter(r=>e.indexOf(r.name)>-1);f&&f.length>0&&(n=f[0].componentData)}x.deleteComponentById(I.value.id,n),a.forEach(c=>{B(c,s,o,e),x.addComponent({component:c,index:void 0,isFromGroup:!0,componentData:n})})},calcComposeArea(e=this.areaData){if(e.components<=1)return;let t=1/0,o=1/0,a=-1/0,s=-1/0;e.components.forEach(i=>{let n={left:0,top:0,right:0,bottom:0};n=Ie(i.style),n.left<o&&(o=n.left),n.top<t&&(t=n.top),n.right>a&&(a=n.right),n.bottom>s&&(s=n.bottom)}),e.style={left:o,top:t,width:a-o,height:s-t}}}}),ie=()=>Oe(T),v=K(),m=ie(),Ve=be(),{multiplexingStyleAdapt:$e,curComponent:y,curComponentIndex:L,curMultiplexingComponents:Te,dvInfo:N,pcMatrixCount:Be,canvasStyleData:G,componentData:q}=C(v),{menuTop:Le,menuLeft:Pe}=C(Ve),H=ne(),Re=$("copy",{state:()=>({copyDataArray:[],copyData:null,isCut:!1}),actions:{copyMultiplexingComponents(e,t=Te.value,o=!1,a="multiplexing",s=(i=>(i=G.value)==null?void 0:i.scale)()){const n=this,{width:c,height:u,scale:f}=G.value;Object.keys(t).forEach(function(r,z){const p=g(t[r]);if(p.canvasId="canvas-main",o)p.style.top=p.style.height+p.style.top;else{const me=z%2;a==="multiplexing"&&!$e.value?(p.style.width=p.style.width*f/s,p.style.height=p.style.height*f/s):(p.sizeX=Be.value.x/2,p.sizeY=14,p.style.width=G.value.width/3*f/100,p.style.height=G.value.height/3*f/100),p.x=p.sizeX*me+1,p.y=Ee()+10,p.style.left=0,p.style.top=0}n.copyData={data:[p],copyCanvasViewInfo:e,index:z,copyFrom:a},n.paste()})},copy(){y.value&&y.value.component!=="GroupArea"?this.copyDataInfo([y.value]):m.areaData.components.length&&this.copyDataInfo(m.areaData.components),this.isCut=!1},paste(e){if(!this.copyData)return;const t=this.copyData.data;let o=0;const a=this.copyData,s=t.length>1?300:10,i=setInterval(function(){if(o>=t.length)clearInterval(i);else{const n=t[o];N.value.type==="dataV"?e?(n.style.top=Le,n.style.left=Pe):(n.style.top+=10,n.style.left+=10):n.y=n.y+n.sizeY;const c={},u=O(n,c);u.category="base",u.canvasId.includes("Group")&&(u.canvasId="canvas-main"),v.addCopyComponent(u,c,a.copyCanvasViewInfo),v.multiplexingStyleAdapt&&a.copyFrom==="multiplexing"&&De(u),N.value.type==="dashboard"&&w.emit("addDashboardItem-"+u.canvasId,u),o===t.length-1&&v.setCurComponent({component:u,index:q.value.length-1}),o++}},s);H.recordSnapshotCache("paste")},cut(e=q.value){y.value&&y.value.component!=="GroupArea"?(this.copyDataInfo([y.value]),v.deleteComponentById(y.value.id,e)):m.areaData.components.length&&(this.copyDataInfo(m.areaData.components),m.areaData.components.forEach(t=>{v.deleteComponentById(t.id)}),m.setAreaData({style:{left:0,top:0,width:0,height:0},components:[]})),H.recordSnapshotCache("cut"),this.isCut=!0},restorePreCutData(){if(this.isCut&&this.copyData){const e=g(this.copyData.data),t=this.copyData.index;v.addComponent({component:e,index:t}),L.value>=t&&L.value++}},copyDataArrayInfo(){this.copyDataArray=g(m.areaData.components)},copyDataInfo(e){this.copyData={data:g(e),index:L}}}});function bt(e,t,o){const a=[];return t.forEach(s=>{const i=O(s,o);i.canvasId=e,a.push(i)}),a}function O(e,t){const o=g(e),a=se();return t[e.id]=a,o.id=a,o.inMobile=!1,delete o.mStyle,delete o.mEvents,delete o.mPropValue,delete o.mCommonBackground,o.component==="Group"&&o.propValue.forEach((s,i)=>{o.propValue[i]=O(s,t)}),o.component==="DeTabs"&&o.propValue.forEach(s=>{s.componentData.forEach((i,n)=>{s.componentData[n]=O(i,t),s.componentData[n].canvasId=o.id+"--"+s.name})}),o}const ze=()=>Re(T),We=K(),{curComponent:Y}=C(We),_e=$("lock",{actions:{lock(e=Y.value){e.isLock=!0,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!0})},unlock(e=Y.value){e.isLock=!1,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!1})}}}),Ne=()=>_e(T),qe=K(),{curComponent:j,componentData:V}=C(qe),Mt=e=>{const t=le(e);return t?t.targetComponent:null},le=e=>{if(e)return X(e);if(j.value)return X(j.value.id)},X=e=>{if(e){let t=0,o=0,a=V.value,s=null;return V.value.forEach((i,n)=>{e===i.id&&(t=n,s=i),i.component==="Group"&&i.propValue.forEach((c,u)=>{e===c.id&&(t=u,s=c,a=i.propValue)}),i.component==="DeTabs"&&i.propValue.forEach((c,u)=>{o=u,c.componentData.forEach((f,r)=>{e===f.id&&(t=r,s=f,a=c.componentData)})})}),{index:t,tabIndex:o,targetComponent:s,componentData:a}}},Ot=(e,t="down")=>{e.sort((o,a)=>{const s=V.value.findIndex(n=>n.id===o.id),i=V.value.findIndex(n=>n.id===a.id);return t==="down"?i-s:s-i})},k=K(),d=ie(),D=ne(),R=ze(),re=Ne(),{curComponent:l,isInEditor:Vt,editMode:He}=C(k),{areaData:A}=C(d),F=17,J=16,U=91,ce=37,ue=38,pe=39,fe=40,Ye=86,je=67,Xe=88,Fe=89,Je=90,Ue=71,Qe=66,Ze=76,et=85,tt=83,ot=80,nt=68,de=46,at=8,st=69,Q=32,$t=[8,37,38,39,40,66,67,68,69,71,76,80,83,85,86,88,89,90],he={[Ye]:rt,[Fe]:ut,[Je]:pt,[tt]:ht,[ot]:mt,[st]:yt},Z={[ce]:b,[ue]:b,[pe]:b,[fe]:b},ee={...he,[et]:Ct},te={...he,[je]:lt,[Xe]:ct,[Ue]:ft,[Qe]:dt,[nt]:P,[de]:P,[Ze]:vt},it=()=>{let e=!1;return document.querySelectorAll(".ed-overlay").forEach(t=>{window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelectorAll(".ed-popper").forEach(t=>{window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelector(".tox-dialog-wrap")&&(e=!0),e};let S=!1,E=!1;function Tt(){window.onkeydown=e=>{if(He.value==="preview"||it())return;const{keyCode:t}=e;Z[t]&&l.value?(Z[t](t),e.preventDefault(),e.stopPropagation()):t===J?(E=!0,d.setIsShiftDownStatus(!0),oe("shift")):t===F||t===U?(S=!0,d.setIsCtrlOrCmdDownStatus(!0),oe("ctrl")):t===Q?(d.setSpaceDownStatus(!0),e.preventDefault(),e.stopPropagation()):(t==de||t==at)&&l.value?P():S&&(te[t]&&(!l.value||!l.value.isLock)?(e.preventDefault(),te[t]()):ee[t]&&l.value&&l.value.isLock&&(e.preventDefault(),ee[t]()))},window.onkeyup=e=>{e.keyCode===F||e.keyCode===U?(S=!1,d.setIsCtrlOrCmdDownStatus(!1)):e.keyCode===J?(E=!0,d.setIsShiftDownStatus(!1)):e.keyCode===Q&&(d.setSpaceDownStatus(!1),e.preventDefault(),e.stopPropagation())},window.onmousedown=()=>{k.setInEditorStatus(!1)}}function Bt(){S=!1,d.setIsCtrlOrCmdDownStatus(!1),E=!1,d.setIsShiftDownStatus(!1)}function oe(e){e==="shift"&&S?(S=!1,d.setIsCtrlOrCmdDownStatus(!1)):e==="ctrl"&&E&&(E=!1,d.setIsShiftDownStatus(!1))}function lt(){R.copy()}function rt(){R.paste(!1),D.recordSnapshotCache("key-paste")}function b(e){if(l.value){const t=k.canvasStyleData.scale/100;e===ce?(l.value.style.left=l.value.style.left-t,M(-t,0)):e===pe?(l.value.style.left=l.value.style.left+t,M(t,0)):e===ue?(l.value.style.top=l.value.style.top-t,M(0,-t)):e===fe&&(l.value.style.top=l.value.style.top+t,M(0,t)),D.recordSnapshotCache("key-move")}}function M(e=0,t=0){const o=l.value.canvasId,a=document.querySelector("#editor-"+o);Ke(o)||ae(o)?xe(l.value,{width:a.offsetWidth,height:a.offsetHeight}):l.value.component==="GroupArea"&&A.value.components.length>0&&A.value.components.forEach(s=>{s.style.top=s.style.top+t,s.style.left=s.style.left+e})}function ct(){R.cut()}function ut(){D.redo()}function pt(){D.undo()}function ft(){A.value.components.length&&(d.compose(),D.recordSnapshotCache("key-compose"))}function dt(){const e=l.value;e&&!e.isLock&&e.component=="Group"&&(d.decompose(),D.recordSnapshotCache("key-decompose"))}function ht(){w.emit("save")}function mt(){w.emit("preview")}function P(){if(l.value&&l.value.component!=="GroupArea"){const e=le();e&&k.deleteComponent(e.index,e.componentData)}else A.value.components.length&&(A.value.components.forEach(e=>{k.deleteComponentById(e.id)}),w.emit("hideArea-canvas-main"));D.recordSnapshotCache("listenGlobalKeyDown")}function yt(){w.emit("clearCanvas")}function vt(){re.lock()}function Ct(){re.unlock()}export{be as a,Tt as b,ie as c,ze as d,le as e,Mt as f,se as g,Ot as h,bt as i,$t as k,Ne as l,Bt as r};
