import{d as Q,p as w,af as ta,ag as sa,r as na,w as oa,x as ra,y as ia,h as da,V as ua,T as ca,v as ma,o as fa,z as pa,A as _a,U as ha,S as va,X as ya}from"./element-plus-secondary-0.0.0-dataease.js";import{d as ga,l as q,r as f,x as ie,q as ba,ak as wa,o as v,Z as x,_ as i,a0 as d,a4 as T,a2 as p,u as s,W as k,X as N,a as c,c as G,M as de,ab as ue,Y as H,z as X,$ as Ee,a3 as ka,n as Ce}from"./@vue-0.0.0-dataease.js";import{i as Pe}from"./icon_expand-right_filled-0.0.0-dataease.js";import{j as xa,h as B,D as W}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import Va from"./ApiHttpRequestForm-0.0.0-dataease.js";import{g as S}from"./js-base64-0.0.0-dataease.js";import{E as Na}from"./EmptyBackground-0.0.0-dataease.js";import{c as ce}from"./datasource-0.0.0-dataease.js";import{f as U}from"./attr-0.0.0-dataease20.js";import{i as Te}from"./field-list-0.0.0-dataease.js";import"./index-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import{_ as Ea}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{e as Ca}from"./lodash-es-0.0.0-dataease.js";const Pa={class:"flex-center"},Ta={class:"step-icon"},ja={class:"icon"},Fa={class:"title"},qa={class:"step-icon"},Sa={class:"icon"},Ua={class:"title"},Da={class:"title-form_primary base-info"},Ja={class:"title-form_primary request-info"},Oa={class:"title-form_primary request-info"},$a={class:"title-form_primary request-info"},Ma={class:"table-container de-svg-in-table"},Ka={class:"name"},za={class:"de-svg-in-table"},Aa=["title"],La={style:{float:"left"}},Ra={style:{float:"left","font-size":"12px",color:"#8492a6"}},Ia={class:"name"},dl=ga({__name:"ApiHttpRequestDraw",emits:["returnItem"],setup(Qa,{expose:je,emit:Fe}){const{t:o}=xa(),me=q({jsonFields:[],fields:[]});let O=q([]),y=q([]),E=q([]),a=q({status:"",name:"",type:"table",url:"",method:"GET",request:{changeId:"",rest:[],headers:[],arguments:[],body:{typeChange:"",raw:"",kvs:[]},authManager:{verification:"",username:"",password:""}},fields:[],jsonFields:[],useJsonPath:!1,apiQueryTimeout:10,showApiStructure:!1,jsonPath:"",serialNumber:-1}),$=[];const qe=f(),Y=f(!1),j=f(!1),g=f(1),Z=f(!1),M=f(!1),fe=ie([]),K=ie([]),ee=ie([]),D=f(),_=f(),pe=f(!1),Se=(l,e,t)=>{if(!e){t(new Error(o("datasource.please_input_query_timeout")));return}let n=!1;var u=/^\d+$/;if(n=u.test(e),!n){t(new Error(o("datasource.please_input_query_timeout")));return}if(e<=0||e>300){t(new Error(o("datasource.please_input_query_timeout")));return}t()},_e=q({name:[{required:!0,message:o("datasource.input_name"),trigger:"blur"},{min:2,max:64,message:o("datasource.input_limit_2_25",[2,64]),trigger:"blur"}],apiQueryTimeout:[{required:!0,validator:Se,trigger:["blur","change"]}],url:[{required:!0,message:o("data_source.the_request_address"),trigger:"blur"}],desc:[{required:!0,trigger:"blur"}]}),z=f("table"),ae=f(!1),le=f(!1),C=f("API"),he=f(""),P=f(!1),te=f([]),se=f(""),ne=f(!1);ba("api-active-name",z);const Ue=(l,e,t,n,u,b,J,F)=>{if(te.value=b,se.value=J,F)P.value=F;else{const h=te.value.filter(V=>V.type===e.type);h&&h.length>0&&(P.value=!0)}if(le.value=l.copy,ne.value=e.copy,C.value=e.type,pe.value=u,z.value=t,ae.value=n,O=e.apiConfiguration,E=l.fields,e.paramsConfiguration&&(y=e.paramsConfiguration),P.value&&(he.value=We()),K.value=[],l.type!=="params"&&y)for(let h=0;h<y.length;h++)K.value=K.value.concat(y[h].fields);Object.assign(a,l),j.value=!0,g.value=0,Ce(()=>{var h,V;P.value?((h=_==null?void 0:_.value)==null||h.invokeMethod({methodName:"clearForm",args:[]}),(V=_==null?void 0:_.value)==null||V.invokeMethod({methodName:"initForm",args:[]})):D.value.clearValidate()})},De=()=>{D.value.validate(l=>{var e,t;if(l){const n=S.encode(JSON.stringify(a)),u=S.encode(JSON.stringify(y));Z.value=!0,(t=(e=W)["/datasource/checkApiDatasource"])==null||t.call(e),ce({dsType:C.value,data:n,type:"apiStructure",paramsList:u}).then(b=>{me.jsonFields=b.data.jsonFields}).catch(b=>{console.warn(b==null?void 0:b.message)}),Z.value=!1}else return!1})},Je=[{id:"GET",label:"GET"},{id:"POST",label:"POST"}],Oe=[{id:!0,label:o("common.yes")},{id:!1,label:o("common.no")}],$e=[{label:o("dataset.text"),value:0},{label:o("dataset.value"),value:2},{label:o("dataset.value")+"("+o("dataset.float")+")",value:3}],A=f(!1),Me=()=>{var l;if(a.type!=="params"&&a.fields.length===0){w.error(o("datasource.api_field_not_empty"));return}if(a.type==="params"){for(let e=0;e<a.fields.length;e++)for(let t=0;t<y.length;t++)for(let n=0;n<y[t].fields.length;n++)if(a.fields[e].name===y[t].fields[n].name&&a.serialNumber!==y[t].serialNumber){w.error(o("data_source.name_already_exists")+a.fields[e].name);return}}for(let e=0;e<a.fields.length-1;e++)for(let t=e+1;t<a.fields.length;t++)if(a.fields[e].name===a.fields[t].name){w.error(a.fields[e].name+", "+o("datasource.has_repeat_field_name"));return}if(ae.value){let e="";for(let t=0;t<a.fields.length;t++)if(a.fields[t].primaryKey){let n=!1;for(let u=0;u<E.length;u++)E[u].name===a.fields[t].name&&E[u].primaryKey&&(n=!0);n||(e=e+" "+a.fields[t].name)}for(let t=0;t<E.length;t++)if(E[t].primaryKey){let n=!1;for(let u=0;u<a.fields.length;u++)E[t].name===a.fields[u].name&&a.fields[u].primaryKey&&(n=!0);n||(e=e+" "+E[t].name)}if(e!==""&&!(ne.value||le.value)){w.error(o("datasource.primary_key_change")+e);return}for(let t=0;t<a.fields.length;t++)if(a.fields[t].primaryKey&&!a.fields[t].length&&a.fields[t].deExtractType===0){w.error(o("datasource.primary_key_length")+a.fields[t].name);return}}else for(let e=0;e<a.fields.length;e++)if(a.fields[e].primaryKey&&!a.fields[e].length&&a.fields[e].deExtractType===0){w.error(o("datasource.primary_key_length")+a.fields[e].name);return}Ye("returnItem",Ca(a)),P.value&&((l=_==null?void 0:_.value)==null||l.invokeMethod({methodName:"resetForm",args:[]})),j.value=!1},Ke=()=>{g.value-=1},ze=()=>{var l;P.value?(l=_==null?void 0:_.value)==null||l.invokeMethod({methodName:"submitForm",args:[{eventName:"stepNext",args:a}]}):D.value.validate(e=>{e&&ve()})},ve=()=>{var e,t;if(a.useJsonPath&&!a.jsonPath){w.error(o("datasource.please_input_dataPath"));return}if(a.type==="params"){for(let n=0;n<y.length;n++)if(y[n].name===a.name&&a.serialNumber!==y[n].serialNumber){w.error(o("data_source.name_already_exists_de"));return}}else for(let n=0;n<O.length;n++)if(O[n].name===a.name&&a.serialNumber!==O[n].serialNumber){w.error(o("datasource.has_repeat_name"));return}(t=(e=W)["/datasource/checkApiDatasource"])==null||t.call(e);const l=S.encode(JSON.stringify(y));A.value=!0,M.value=!0,ce({dsType:C.value,data:S.encode(JSON.stringify(a)),paramsList:l}).then(n=>{A.value=!1,M.value=!1,a.jsonFields=n.data.jsonFields,a.fields=[],a.name=n.data.name,oe(a),L(),g.value+=1}).catch(n=>{A.value=!1,M.value=!1,console.warn(n==null?void 0:n.message)})},Ae=()=>{var l;P.value?(l=_==null?void 0:_.value)==null||l.invokeMethod({methodName:"submitForm",args:[{eventName:"validateItem",args:a}]}):D.value.validate(e=>{if(e)ye();else return})},ye=()=>{var e,t;if(a.useJsonPath&&!a.jsonPath){w.error(o("datasource.please_input_dataPath"));return}(t=(e=W)["/datasource/checkApiDatasource"])==null||t.call(e);const l=S.encode(JSON.stringify(y));ce({dsType:C.value,data:S.encode(JSON.stringify(a)),paramsList:l}).then(n=>{a.jsonFields=n.data.jsonFields,a.fields=[],a.name=n.data.name,oe(a),L(),w.success(o("datasource.validate_success"))}).catch(()=>{w.error(o("data_source.verification_failed"))})},Le=l=>{const e=l.validate;e(t=>{t&&(l.eventName==="validateItem"?ye():ve())})},ge=()=>{var l,e,t;(e=(l=W)["/datasource/checkApiDatasource"])==null||e.call(l),P.value&&((t=_==null?void 0:_.value)==null||t.invokeMethod({methodName:"resetForm",args:[]})),j.value=!1},Re=l=>!!(l.hasOwnProperty("children")&&l.children.length>0),Ie=l=>l.hasOwnProperty("children")&&l.children.length>0?!0:l.deExtractType!==0,Qe=l=>l.hasOwnProperty("children")&&l.children.length>0?!0:le.value||ne.value?!1:!!(ae.value||!l.checked),Ge=l=>!!(a.type=="params"||l.hasOwnProperty("children")&&l.children.length>0),He=l=>{l.deExtractType!==0&&(l.length="")},L=()=>{Y.value=!1;const l=[],e=[];let t=0;for(let n=0;n<a.fields.length;n++)a.fields[n].value&&a.fields[n].value.length>t&&(t=a.fields[n].value.length);for(let n=0;n<t;n++)l.push({});for(let n=0;n<a.fields.length;n++){for(let u=0;u<a.fields[n].value.length;u++)l[u][a.fields[n].name]=a.fields[n].value[u];e.push({key:a.fields[n].name,dataKey:a.fields[n].name,title:a.fields[n].name,width:150})}ee.value=l,fe.value=e,Y.value=a.fields.length===0},be=(l,e)=>{var t;(t=e.children)!=null&&t.length&&e.children.forEach(n=>{n.checked=e.checked,be(l,n)})},oe=l=>{for(var e=0;e<l.jsonFields.length;e++)l.jsonFields[e].checked&&l.jsonFields[e].children===void 0&&l.fields.push(l.jsonFields[e]),l.jsonFields[e].children!==void 0&&we(l,l.jsonFields[e].children)},we=(l,e)=>{var u;for(var t=0;t<e.length;t++){if(e[t].checked&&e[t].children===void 0){for(var n=0;n<l.fields.length;n++)l.fields[n].name===e[t].name&&(e[t].checked=!1,Ce(()=>{e[t].checked=!1}),$.push(e[t].name));l.fields.push(e[t])}(u=e[t].children)!=null&&u.length&&we(l,e[t].children)}},Xe=l=>{$=[],be(a,l),a.fields=[],oe(a),L(),$.length&&w.error([...new Set($)].join(",")+", "+o("datasource.has_repeat_field_name"))},Be=l=>{a.request.body.typeChange=l},R=f(!0),I=f(!0),We=()=>{var e;const l=te.value.filter(t=>t.type===C.value);return se.value?se.value:l&&l.length>0?(e=l[0].staticMap)==null?void 0:e.index:null},Ye=Fe;return je({initApiItem:Ue}),(l,e)=>{const t=ta,n=sa,u=na,b=oa,J=ra,F=ia,h=da,V=ua,ke=ca,xe=ma,re=fa,Ve=pa,Ze=_a,ea=ha,aa=va,la=ya,Ne=wa("loading");return v(),x(la,{title:z.value==="table"?s(o)("datasource.data_table"):s(o)("data_source.interface_parameters"),modelValue:j.value,"onUpdate:modelValue":e[9]||(e[9]=r=>j.value=r),"custom-class":"api-datasource-drawer",size:"1000px","before-close":ge,direction:"rtl"},{footer:i(()=>[d(h,{secondary:"",onClick:ge},{default:i(()=>[T(p(s(o)("common.cancel")),1)]),_:1}),k(d(h,{secondary:"",onClick:Ae},{default:i(()=>[T(p(s(o)("commons.validate")),1)]),_:1},512),[[N,g.value===0]]),k(d(h,{type:"primary",disabled:A.value,onClick:ze},{default:i(()=>[T(p(s(o)("common.next")),1)]),_:1},8,["disabled"]),[[N,g.value===0]]),k(d(h,{secondary:"",onClick:Ke},{default:i(()=>[T(p(s(o)("common.prev")),1)]),_:1},512),[[N,g.value===1]]),k(d(h,{type:"primary",onClick:Me},{default:i(()=>[T(p(s(o)("commons.save")),1)]),_:1},512),[[N,g.value===1]])]),default:i(()=>[c("div",Pa,[d(n,{active:g.value,"align-center":""},{default:i(()=>[d(t,null,{icon:i(()=>[c("div",Ta,[c("span",ja,p(g.value<=0?"1":""),1),c("span",Fa,p(s(o)("datasource.api_step_1")),1)])]),_:1}),d(t,null,{icon:i(()=>[c("div",qa,[c("span",Sa,p(g.value<=1?"2":""),1),c("span",Ua,p(z.value==="table"?s(o)("datasource.api_step_2"):s(o)("data_source.extract_parameters")),1)])]),_:1})]),_:1},8,["active"])]),k(d(re,null,{default:i(()=>[k((v(),x(xe,{ref_key:"apiItemBasicInfo",ref:D,model:s(a),"label-position":"top","label-width":"100px","require-asterisk-position":"right",rules:_e},{default:i(()=>[c("div",Da,[c("span",null,p(s(o)("datasource.base_info")),1)]),d(b,{label:s(o)("common.name"),prop:"name"},{default:i(()=>[d(u,{modelValue:s(a).name,"onUpdate:modelValue":e[0]||(e[0]=r=>s(a).name=r),placeholder:s(o)("common.input_name"),autocomplete:"off"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),d(b,{label:s(o)("datasource.request"),prop:"url"},{default:i(()=>[d(u,{modelValue:s(a).url,"onUpdate:modelValue":e[2]||(e[2]=r=>s(a).url=r),placeholder:s(o)("datasource.path_all_info"),class:"input-with-select"},{prepend:i(()=>[d(F,{modelValue:s(a).method,"onUpdate:modelValue":e[1]||(e[1]=r=>s(a).method=r)},{default:i(()=>[(v(),G(de,null,ue(Je,r=>d(J,{key:r.id,label:r.label,value:r.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),k((v(),G("div",null,[c("div",Ja,[c("span",null,p(s(o)("datasource.req_param")),1)]),d(b,{class:"line-height_18"},{default:i(()=>[j.value?(v(),x(Va,{key:0,request:s(a).request,"value-list":K.value,onChangeId:Be},null,8,["request","value-list"])):H("",!0)]),_:1})])),[[Ne,Z.value]]),d(b,{label:l.$t("datasource.query_timeout"),prop:"apiQueryTimeout"},{default:i(()=>[d(u,{modelValue:s(a).apiQueryTimeout,"onUpdate:modelValue":e[3]||(e[3]=r=>s(a).apiQueryTimeout=r),autocomplete:"off",type:"number",min:0},{append:i(()=>[T(p(l.$t("chart.second")),1)]),_:1},8,["modelValue"])]),_:1},8,["label"]),c("div",Oa,[c("span",null,p(s(o)("datasource.isUseJsonPath")),1)]),d(b,null,{default:i(()=>[d(u,{modelValue:s(a).jsonPath,"onUpdate:modelValue":e[5]||(e[5]=r=>s(a).jsonPath=r),placeholder:s(o)("datasource.jsonpath_info"),class:"input-with-select"},{prepend:i(()=>[d(F,{modelValue:s(a).useJsonPath,"onUpdate:modelValue":e[4]||(e[4]=r=>s(a).useJsonPath=r),style:{width:"100px"}},{default:i(()=>[(v(),G(de,null,ue(Oe,r=>d(J,{key:r.label,label:r.label,value:r.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),append:i(()=>[d(h,{onClick:De},{default:i(()=>[T(p(s(o)("data_source.view_data_structure")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1}),k(c("div",$a,[c("span",null,p(s(o)("datasource.column_info")),1)],512),[[N,s(a).useJsonPath]]),k(c("div",Ma,[d(ke,{data:me.jsonFields,style:{width:"100%"},"row-key":"jsonPath"},{default:i(()=>[d(V,{"class-name":"checkbox-table",prop:"originName",label:s(o)("datasource.parse_filed"),"show-overflow-tooltip":""},{default:i(r=>[T(p(r.row.originName),1)]),_:1},8,["label"])]),_:1},8,["data"])],512),[[N,s(a).useJsonPath]])]),_:1},8,["model","rules"])),[[Ne,M.value]])]),_:1},512),[[N,g.value===0&&C.value==="API"]]),k(d(re,null,{default:i(()=>[C.value!=="API"?(v(),x(s(Ea),{key:0,jsname:he.value,"api-item":s(a),ref_key:"xpackApiItemBasicInfo",ref:_,onSubmitForm:Le},null,8,["jsname","api-item"])):H("",!0)]),_:1},512),[[N,g.value===0&&C.value!=="API"]]),k(d(re,null,{default:i(()=>[d(xe,{style:{width:"100%"},ref_key:"apiItemForm",ref:qe,model:s(a),"label-position":"top","label-width":"100px",rules:_e},{default:i(()=>[c("p",{class:X([R.value?"active":"deactivate","column-info-title"]),onClick:e[6]||(e[6]=r=>R.value=!R.value)},[d(s(Q),{style:{"font-size":"10px"}},{default:i(()=>[d(s(B),{name:"icon_expand-right_filled"},{default:i(()=>[d(s(Pe),{class:"svg-icon"})]),_:1})]),_:1}),c("span",Ka,p(s(o)("datasource.column_info")),1)],2),k(c("div",za,[d(ke,{"header-cell-class-name":"header-cell",data:s(a).jsonFields,style:{width:"100%"},"row-key":"jsonPath"},{default:i(()=>[d(V,{"class-name":"checkbox-table",prop:"originName",label:s(o)("datasource.parse_filed"),width:"200"},{default:i(r=>[(v(),x(Ve,{style:{display:"inline-block","max-width":"80px","white-space":"nowrap"},key:r.row.jsonPath,modelValue:r.row.checked,"onUpdate:modelValue":m=>r.row.checked=m,disabled:s(a).useJsonPath,onChange:m=>Xe(r.row)},{default:i(()=>[c("span",{title:r.row.originName,class:"ellipsis",style:{display:"inline-block","max-width":"80px"}},p(r.row.originName),9,Aa)]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"]),d(V,{prop:"name",label:s(o)("datasource.field_rename")},{default:i(r=>[d(u,{modelValue:r.row.name,"onUpdate:modelValue":m=>r.row.name=m,disabled:Re(r.row),text:"",onChange:e[7]||(e[7]=m=>L())},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["label"]),d(V,{prop:"deExtractType",label:s(o)("datasource.field_type"),disabled:s(a).type==="params"},{default:i(r=>[d(F,{modelValue:r.row.deExtractType,"onUpdate:modelValue":m=>r.row.deExtractType=m,disabled:Ge(r.row),class:"select-type",style:{display:"inline-block",width:"120px"},onChange:m=>He(r.row)},{prefix:i(()=>[d(s(Q),null,{default:i(()=>[d(s(B),{className:`field-icon-${s(U)[r.row.deExtractType]}`},{default:i(()=>[(v(),x(Ee(s(Te)[s(U)[r.row.deExtractType]]),{class:X(["svg-icon",`field-icon-${s(U)[r.row.deExtractType]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),default:i(()=>[(v(),G(de,null,ue($e,m=>d(J,{key:m.value,label:m.label,value:m.value},{default:i(()=>[c("span",La,[d(s(Q),null,{default:i(()=>[d(s(B),{className:`field-icon-${s(U)[m.value]}`},{default:i(()=>[(v(),x(Ee(s(Te)[s(U)[m.value]]),{class:X(["svg-icon",`field-icon-${s(U)[m.value]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),c("span",Ra,p(m.label),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:1},8,["label","disabled"]),s(a).type!=="params"?(v(),x(V,{key:0,prop:"length",label:s(o)("datasource.length")},{default:i(r=>[d(Ze,{disabled:Ie(r.row),modelValue:r.row.length,"onUpdate:modelValue":m=>r.row.length=m,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:s(o)("common.inputText"),"controls-position":"right",type:"number"},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder"])]),_:1},8,["label"])):H("",!0),s(a).type!=="params"&&pe.value?(v(),x(V,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:s(o)("datasource.set_key"),width:"100"},{default:i(r=>[(v(),x(Ve,{key:r.row.jsonPath,modelValue:r.row.primaryKey,"onUpdate:modelValue":m=>r.row.primaryKey=m,disabled:Qe(r.row)},null,8,["modelValue","onUpdate:modelValue","disabled"]))]),_:1},8,["label"])):H("",!0)]),_:1},8,["data"])],512),[[N,R.value]]),c("p",{class:X([I.value?"active":"deactivate","column-info-title"]),onClick:e[8]||(e[8]=r=>I.value=!I.value)},[d(s(Q),{style:{"font-size":"10px"}},{default:i(()=>[d(s(B),{name:"icon_expand-right_filled"},{default:i(()=>[d(s(Pe),{class:"svg-icon"})]),_:1})]),_:1}),c("span",Ia,p(s(o)("datasource.data_preview")),1)],2),k(c("div",{class:"info-table",style:ka({height:Math.min(ee.value.length,20)*40+"px"})},[Y.value?(v(),x(Na,{key:0,description:s(o)("data_source.the_data_structure"),"img-type":"select"},null,8,["description"])):(v(),x(aa,{key:1},{default:i(({height:r,width:m})=>[d(ea,{columns:fe.value,"header-class":"header-cell",data:ee.value,width:m,height:r,fixed:""},null,8,["columns","data","width","height"])]),_:1}))],4),[[N,I.value]])]),_:1},8,["model","rules"])]),_:1},512),[[N,g.value===1]])]),_:1},8,["title","modelValue"])}}});export{dl as _};
