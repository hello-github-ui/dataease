import"./index-0.0.0-dataease.js";import{o as Ce,F as $,y as _e}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{d as ye}from"./dvMain-0.0.0-dataease.js";import{v as Me,f as ke}from"./formatter-0.0.0-dataease.js";import{E as Ie,v,B as Te}from"./antv-0.0.0-dataease.js";import{u as ee}from"./index.esm-0.0.0-dataease.js";import{g as j,f as be,h as b}from"./index-0.0.0-dataease19.js";import{e as Se,d as we,k as Ne,E as Ee}from"./lodash-0.0.0-dataease.js";import{d as De,G as te,o as Be,aj as ze,f as Le,L as Ae,M as F,k as ne,i as oe,a5 as re,a6 as ie,j as ae,Y as He,n as Ke}from"./vue-0.0.0-dataease.js";import{_ as Oe}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./util-0.0.0-dataease2.js";import"./chart-0.0.0-dataease2.js";import"./app-0.0.0-dataease.js";import"./index-0.0.0-dataease20.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./row-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";const Ve=["id"],Ge={class:"button-group"},Re=["id"],ce=1,Pe=De({__name:"TableHeaderGroupConfig",props:{chart:{type:Object,required:!0},themes:{type:String,default:"dark"},propertyInner:{type:Array}},emits:["onConfigChange","onCancelConfig"],setup(q,{emit:se}){const{t:g}=Ce(),le=ye(),H=q,U=se,de=()=>{U("onCancelConfig")},fe=()=>{var M;const c=(M=H.chart.xAxis)==null?void 0:M.map(u=>u.hide!==!0&&u.dataeaseName).filter(u=>u),{fields:o,meta:f}=e.dataCfg,s=f.filter(u=>!c.includes(u.field));U("onConfigChange",{columns:o.columns,meta:s})},ue=()=>{var M;const c=we(H.chart),o=c.xAxis,{headerGroupConfig:f}=c.customAttr.tableHeader,s=[];if(o==null||o.forEach(u=>{u.hide!==!0&&s.push({key:u.dataeaseName})}),!!s.length){if((M=f==null?void 0:f.columns)!=null&&M.length){const u=s.map(w=>w.key),P=j(f.columns).map(w=>w.key);if(!Ne(u,P)){const{columns:w,meta:K}=f;w.splice(0,w.length,...s),K.splice(0,K.length)}}else c.customAttr.tableHeader.headerGroupConfig={columns:[...s],meta:[]};Ke(()=>{pe(c)})}},W=te(()=>"menu-group-"+H.chart.id),R=te(()=>"table-container-"+H.chart.id);let e;const pe=c=>{var J,Q,Z;const o=le.getViewDataDetails(c.id),f=document.getElementById(R.value);let s=[];(J=o==null?void 0:o.tableRow)!=null&&J.length&&(s=o.tableRow.slice(0,10));const{headerGroupConfig:M}=c.customAttr.tableHeader,u=[...M.meta],Y=M.columns,P=c.xAxis.reduce((a,t)=>(a[t.dataeaseName]=t,a),{});(Q=o==null?void 0:o.fields)!=null&&Q.length?o.fields.forEach(a=>{const t=P[a.dataeaseName];(t==null?void 0:t.hide)!==!0&&u.push({field:a.dataeaseName,name:a.chartShowName??a.name,formatter:function(n){if(!t||n==null||![2,3].includes(t.deType)||!Ee(n))return n;let k=t.formatterCfg;return k||(k=ke),Me(n,k)}})}):(Z=c.xAxis)==null||Z.forEach(a=>{a.hide!==!0&&u.push({field:a.dataeaseName,name:a.chartShowName??a.name})});const w={fields:{columns:Y},meta:u,data:s},K={width:f.getBoundingClientRect().width,height:f.offsetHeight,tooltip:{getContainer:()=>f,renderTooltip:a=>new ge(a),style:{position:"absolute",borderRadius:"4px"}},interaction:{rangeSelection:!1}};e=new Ie(f,w,K);const xe=be(c);e.setTheme(xe);const E=document.getElementById(W.value);e.on(v.COL_CELL_CONTEXT_MENU,a=>{var L,A,O,V,G;a.preventDefault();const t=e.dataCfg.fields.columns,n=e.dataCfg.meta,k=e.interaction.getActiveCells(),D=k==null?void 0:k.map(_=>_.getMeta().field),x=b(D,t),d=e.getCell(a.target);if(E.innerText="",x!=null&&x.length&&x.findIndex(N=>N.key===d.getMeta().field)===-1){e.interaction.clearState(),e.hideTooltip();return}if((x==null?void 0:x.length)===1&&d.getMeta().colIndex===-1){e.interaction.clearState(),e.interaction.selectHeaderCell({cell:d});const _=document.createElement("span");E.appendChild(_),_.innerText=g("chart.cancel_group"),_.onclick=()=>{var r,C;e.hideTooltip();const l=d.getMeta().parent;if((l==null?void 0:l.id)==="root"){const h=t.findIndex(i=>i.key===d.getMeta().field),[T]=b([d.getMeta().field],t);t.splice(h,1,...T.children);const I=n.findIndex(i=>i.field===d.getMeta().field);n.splice(I,1),e.setDataCfg({fields:{columns:t},meta:n}),e.render(!0)}else{const[h]=b([l.field],t);if(h){const T=(r=h.children)==null?void 0:r.findIndex(m=>m.key===d.getMeta().field),[I]=b([d.getMeta().field],h.children);(C=h.children)==null||C.splice(T,1,...I.children);const i=n.findIndex(m=>m.field===d.getMeta().field);n.splice(i,1),e.setDataCfg({fields:{columns:t},meta:n}),e.render(!0)}}e.interaction.clearState()};const N=document.createElement("span");E.appendChild(N),N.innerText=g("chart.cancel_all_group"),N.onclick=()=>{var r,C;e.hideTooltip();const l=d.getMeta().parent;if((l==null?void 0:l.id)==="root"){const[h]=b([d.getMeta().field],t),T=j(h.children),I=t.findIndex(y=>y.key===d.getMeta().field);t.splice(I,1,...T);const i=X([h]),m=n.filter(y=>!i.includes(y.field));e.setDataCfg({fields:{columns:t},meta:m}),e.render(!0)}else{const[h]=b([l.field],t);if(h){const[T]=b([d.getMeta().field],h.children),I=j(T.children),i=(r=h.children)==null?void 0:r.findIndex(B=>B.key===d.getMeta().field);(C=h.children)==null||C.splice(i,1,...I);const m=X([T]),y=n.filter(B=>!m.includes(B.field));e.setDataCfg({fields:{columns:t},meta:y}),e.render(!0)}}e.interaction.clearState()};const p=document.createElement("span");E.appendChild(p),p.innerText=g("chart.rename"),p.onclick=()=>{e.hideTooltip();const l=n.find(r=>r.field===d.getMeta().field);$.prompt("",g("chart.group_name"),{confirmButtonText:g("chart.confirm"),cancelButtonText:g("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:g("chart.group_name_edit_tip"),inputValue:l.name,inputErrorMessage:g("chart.group_name_error_tip"),inputValidator:r=>(r==null?void 0:r.length)<1||(r==null?void 0:r.length)>20?g("chart.group_name_error_tip"):!0}).then(r=>{l.name=r.value,e.setDataCfg({meta:n}),e.render(!0)}).catch(()=>{})},e.showTooltip({position:{x:a.x,y:a.y},content:E});return}if((x==null?void 0:x.length)>1){if(!k.every(i=>i.getMeta().parent===d.getMeta().parent))return;let N=-1,p=d;for(;(A=(L=p==null?void 0:p.getMeta)==null?void 0:L.call(p))!=null&&A.parent||p!=null&&p.parent;)N++,p=((V=(O=p==null?void 0:p.getMeta)==null?void 0:O.call(p))==null?void 0:V.parent)||(p==null?void 0:p.parent);let l=-1,r=-1;const C=d.getMeta().parent;C.colIndex!==-1?x.forEach(i=>{const m=C.children.findIndex(y=>y.getMeta().field===i.key);(m<l||l===-1)&&(l=m),(m>r||r===-1)&&(r=m)}):x.forEach(i=>{const m=C.children.findIndex(y=>y.key===i.key);(m<l||l===-1)&&(l=m),(m>r||r===-1)&&(r=m)});const h=[];if((C==null?void 0:C.id)==="root")h.push(...t.slice(l,r+1));else{const[i]=b([C.field],t);h.push(...(G=i.children)==null?void 0:G.slice(l,r+1))}if(he(h)+N>1)return;const I=document.createElement("span");E.appendChild(I),I.innerText=g("chart.merge_group"),I.onclick=()=>{e.hideTooltip(),$.prompt("",g("chart.group_name"),{confirmButtonText:g("chart.confirm"),cancelButtonText:g("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:g("chart.group_name_edit_tip"),inputErrorMessage:g("chart.group_name_error_tip"),inputValue:g("chart.group"),inputValidator:i=>(i==null?void 0:i.length)<1||(i==null?void 0:i.length)>20?g("chart.group_name_error_tip"):!0}).then(i=>{var m;if((C==null?void 0:C.id)==="root"){const y=ee.v4();t==null||t.splice(l,r-l+1,{key:y,children:h}),n.push({field:y,name:i.value}),e.setDataCfg({fields:{columns:t},meta:n}),e.render(!0)}else{const[y]=b([C.field],t),B=ee.v4();(m=y.children)==null||m.splice(l,r-l+1,{key:B,children:h}),n.push({field:B,name:i.value}),e.setDataCfg({fields:{columns:t},meta:n}),e.render(!0)}e.interaction.clearState()}).catch(()=>{})},e.showTooltip({position:{x:a.x,y:a.y},content:E});return}}),e.on(v.COL_CELL_CLICK,a=>{const t=e.store.get("lastClickedCell"),n=a.originalEvent;if(!t||!(n!=null&&n.ctrlKey||n!=null&&n.metaKey||n!=null&&n.shiftKey)){const k=e.getCell(a.target);e.store.set("lastClickedCell",k);return}if(n!=null&&n.shiftKey){if(!t){const _=e.getCell(a.target);e.store.set("lastClickedCell",_);return}const k=e.getCell(a.target),D=t.getMeta(),x=k.getMeta();if(D.key===x.key||D.level!==x.level||D.parent!==x.parent)return;const d=x.parent,L=d.children.findIndex(_=>_.key===D.key),A=d.children.findIndex(_=>_.key===x.key),O=Math.min(L,A),V=Math.max(L,A),G=d.children.slice(O,V+1);e.interaction.clearState(),G.forEach(_=>{e.interaction.selectHeaderCell({cell:_.belongsCell,isMultiSelection:!0})})}}),e.render()},X=c=>{const o=[],f=s=>{var M;if(((M=s.children)==null?void 0:M.length)>0){o.push(s.key);for(let u=0;u<s.children.length;u++)f(s.children[u])}};return c.forEach(s=>f(s)),o},he=c=>{if(!(c!=null&&c.length))return 0;const o=s=>{if(!s.children||s.children.length===0)return 0;const M=s.children.map(u=>o(u));return Math.max(...M)+1},f=c.map(s=>o(s));return Math.max(...f)},me=Se((c,o)=>{e&&(e.changeSheetSize(c,o),e.render(!1))},500),S=[0,0];let z;Be(()=>{ue(),z=new ResizeObserver(([c]=[])=>{const[o]=c.borderBoxSize||[];S[0]||S[1]||(S[0]=o.inlineSize,S[1]=o.blockSize);const f=Math.abs(o.inlineSize-S[0]),s=Math.abs(o.blockSize-S[1]);f<ce&&s<ce||(S[0]=o.inlineSize,S[1]=o.blockSize,me(o.inlineSize,Math.round(o.blockSize)))}),z.observe(document.getElementById(R.value))}),ze(()=>{z==null||z.disconnect()});class ge extends Te{show(o){super.show(o),this.container.style.display="flex"}hide(){this.container&&(this.container.style.display="none")}}return(c,o)=>{const f=_e;return Le(),Ae(He,null,[F("div",{id:R.value,class:"table-container"},null,8,Ve),F("div",Ge,[ne(f,{effect:q.themes,onClick:de},{default:oe(()=>[re(ie(ae(g)("chart.cancel")),1)]),_:1},8,["effect"]),ne(f,{type:"primary",onClick:fe},{default:oe(()=>[re(ie(ae(g)("chart.confirm")),1)]),_:1})]),F("div",{id:W.value,class:"group-menu"},null,8,Re)],64)}}});const yt=Oe(Pe,[["__scopeId","data-v-0810f045"]]);export{yt as default};
