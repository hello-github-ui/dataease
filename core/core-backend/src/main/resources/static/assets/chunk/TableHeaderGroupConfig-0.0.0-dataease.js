import{q as v,h as ke}from"./element-plus-secondary-0.0.0-dataease.js";import{d as Ie}from"./dvMain-0.0.0-dataease.js";import{z as be,q as ee,B as Te}from"./@antv-0.0.0-dataease.js";import{u as Ae}from"./vue-uuid-0.0.0-dataease.js";import{j as Se}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as S,j as we,k as N,g as te}from"./index-0.0.0-dataease12.js";import{d as Ne,e as M}from"./lodash-es-0.0.0-dataease.js";import{d as Be,k as oe,b as De,j as Ee,o as ze,c as Ge,a as W,a0 as ne,_ as re,a4 as ie,a2 as ce,u as ae,M as He,n as Le}from"./@vue-0.0.0-dataease.js";import{_ as Oe}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./@vueuse-0.0.0-dataease.js";import"./@element-plus-0.0.0-dataease.js";import"./dayjs-0.0.0-dataease.js";import"./@amap-0.0.0-dataease.js";import"./async-validator-0.0.0-dataease.js";import"./@ctrl-0.0.0-dataease.js";import"./@popperjs-0.0.0-dataease.js";import"./escape-html-0.0.0-dataease.js";import"./normalize-wheel-es-0.0.0-dataease.js";import"./memoize-one-0.0.0-dataease.js";import"./pinia-0.0.0-dataease.js";import"./vue-demi-0.0.0-dataease.js";import"./index-0.0.0-dataease.js";import"./mitt-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./vue-types-0.0.0-dataease.js";import"./is-plain-object-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./snowflake-id-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./less-0.0.0-dataease.js";import"./tslib-0.0.0-dataease.js";import"./copy-anything-0.0.0-dataease.js";import"./is-what-0.0.0-dataease.js";import"./jspdf-0.0.0-dataease.js";import"./@babel-0.0.0-dataease.js";import"./fflate-0.0.0-dataease.js";import"./vue-i18n-0.0.0-dataease.js";import"./@intlify-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./qs-0.0.0-dataease.js";import"./side-channel-0.0.0-dataease.js";import"./es-errors-0.0.0-dataease.js";import"./object-inspect-0.0.0-dataease.js";import"./crypto-js-0.0.0-dataease.js";import"./side-channel-list-0.0.0-dataease.js";import"./side-channel-map-0.0.0-dataease.js";import"./get-intrinsic-0.0.0-dataease.js";import"./es-object-atoms-0.0.0-dataease.js";import"./math-intrinsics-0.0.0-dataease.js";import"./gopd-0.0.0-dataease.js";import"./es-define-property-0.0.0-dataease.js";import"./has-symbols-0.0.0-dataease.js";import"./get-proto-0.0.0-dataease.js";import"./dunder-proto-0.0.0-dataease.js";import"./call-bind-apply-helpers-0.0.0-dataease.js";import"./function-bind-0.0.0-dataease.js";import"./hasown-0.0.0-dataease.js";import"./call-bound-0.0.0-dataease.js";import"./side-channel-weakmap-0.0.0-dataease.js";import"./vue-router-0.0.0-dataease.js";import"./lodash-0.0.0-dataease.js";import"./vue-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./zrender-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./eventemitter3-0.0.0-dataease.js";import"./@mapbox-0.0.0-dataease.js";import"./pbf-0.0.0-dataease.js";import"./ieee754-0.0.0-dataease.js";import"./supercluster-0.0.0-dataease.js";import"./gl-matrix-0.0.0-dataease.js";import"./topojson-client-0.0.0-dataease.js";import"./viewport-mercator-project-0.0.0-dataease.js";import"./@turf-0.0.0-dataease.js";import"./polygon-clipping-0.0.0-dataease.js";import"./splaytree-0.0.0-dataease.js";import"./robust-predicates-0.0.0-dataease.js";import"./d3-scale-0.0.0-dataease.js";import"./d3-collection-0.0.0-dataease.js";import"./d3-format-0.0.0-dataease.js";import"./d3-time-format-0.0.0-dataease.js";import"./d3-time-0.0.0-dataease.js";import"./d3-color-0.0.0-dataease.js";import"./d3-array-0.0.0-dataease.js";import"./earcut-0.0.0-dataease.js";import"./regl-0.0.0-dataease.js";import"./mapbox-gl-0.0.0-dataease.js";import"./d3-dsv-0.0.0-dataease.js";import"./geojson-vt-0.0.0-dataease.js";import"./hammerjs-0.0.0-dataease.js";import"./element-resize-detector-0.0.0-dataease.js";import"./batch-processor-0.0.0-dataease.js";import"./d3-hexbin-0.0.0-dataease.js";import"./detect-browser-0.0.0-dataease.js";import"./d3-ease-0.0.0-dataease.js";import"./d3-interpolate-0.0.0-dataease.js";import"./d3-timer-0.0.0-dataease.js";import"./fecha-0.0.0-dataease.js";import"./size-sensor-0.0.0-dataease.js";import"./d3-regression-0.0.0-dataease.js";import"./d3-hierarchy-0.0.0-dataease.js";import"./fmin-0.0.0-dataease.js";import"./pdfast-0.0.0-dataease.js";import"./uuid-0.0.0-dataease.js";import"./util-0.0.0-dataease2.js";import"./chart-0.0.0-dataease2.js";import"./app-0.0.0-dataease.js";import"./mathjs-0.0.0-dataease.js";import"./decimal.js-0.0.0-dataease.js";import"./typed-function-0.0.0-dataease.js";import"./complex.js-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./exceljs-0.0.0-dataease.js";import"./file-saver-0.0.0-dataease.js";const Fe=["id"],Ve={class:"button-group"},Ke=["id"],se=1,Re=Be({__name:"TableHeaderGroupConfig",props:{chart:{type:Object,required:!0},themes:{type:String,default:"dark"},propertyInner:{type:Array}},emits:["onConfigChange","onCancelConfig"],setup(X,{emit:le}){const{t:g}=Se(),me=Ie(),C=X,B=le,de=()=>{B("onCancelConfig")},pe=()=>{var I,E,R;const o=(((R=(E=(I=C.chart)==null?void 0:I.customAttr)==null?void 0:E.tableHeader)==null?void 0:R.headerGroupConfig)||{}).columns||[],f=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),l=S(o,f),k=leafNodes.map(j=>({field:j.key,name:j.name}));console.log("[headerGroupConfig.columns]:",JSON.stringify(l,null,2)),console.log("[onConfigChange] meta:",k),B("onConfigChange",{columns:M(l),meta:M(k)})},ue=()=>{var I;const n=M(C.chart),o=n.xAxis,{headerGroupConfig:f}=n.customAttr.tableHeader,l=[];if(o==null||o.forEach(E=>{E.hide!==!0&&l.push({key:E.dataeaseName})}),!l.length)return;(I=f==null?void 0:f.columns)!=null&&I.length||(n.customAttr.tableHeader.headerGroupConfig={columns:[...l],meta:[]});const k=(n.xAxis||[]).concat(n.yAxis||[]);n.customAttr.tableHeader.headerGroupConfig.columns=S(n.customAttr.tableHeader.headerGroupConfig.columns,k),Le(()=>{fe(n)})},Q=oe(()=>"menu-group-"+C.chart.id),U=oe(()=>"table-container-"+C.chart.id);let e;const fe=n=>{var Z;const o=me.getViewDataDetails(n.id),f=document.getElementById(U.value);let l=[];(Z=o==null?void 0:o.tableRow)!=null&&Z.length&&(l=o.tableRow.slice(0,10));const{headerGroupConfig:k}=n.customAttr.tableHeader,I=(n.xAxis||[]).concat(n.yAxis||[]),E=S(k.columns,I);n.customAttr.tableHeader.headerGroupConfig.columns=E;const R=E,j=k.meta?JSON.parse(JSON.stringify(k.meta)):[],xe={fields:{columns:R},meta:j,data:l},ye={width:f.getBoundingClientRect().width,height:f.offsetHeight,tooltip:{getContainer:()=>f,renderTooltip:b=>new Ce(b),style:{position:"absolute",borderRadius:"4px"}},interaction:{rangeSelection:!1}};e=new be(f,xe,ye);const _e=we(n);e.setTheme(_e);const H=document.getElementById(Q.value);e.on(ee.COL_CELL_CONTEXT_MENU,b=>{var F,V,P,q,J;b.preventDefault();const t=e.dataCfg.fields.columns;console.log("curColumns: ",t);const r=e.dataCfg.meta,z=e.interaction.getActiveCells(),L=z==null?void 0:z.map(_=>_.getMeta().field),x=N(L,t),m=e.getCell(b.target);if(H.innerText="",x!=null&&x.length&&x.findIndex(G=>G.key===m.getMeta().field)===-1){e.interaction.clearState(),e.hideTooltip();return}if((x==null?void 0:x.length)===1&&m.getMeta().colIndex===-1){e.interaction.clearState(),e.interaction.selectHeaderCell({cell:m});const _=document.createElement("span");H.appendChild(_),_.innerText=g("chart.cancel_group"),_.onclick=()=>{var i,h;e.hideTooltip();const a=m.getMeta().parent;if((a==null?void 0:a.id)==="root"){const d=t.findIndex(u=>u.key===m.getMeta().field),[A]=N([m.getMeta().field],t);t.splice(d,1,...A.children);const T=r.findIndex(u=>u.field===m.getMeta().field);r.splice(T,1);const c=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),s=S(t,c);B("onConfigChange",{columns:M(s),meta:M(r)}),e.setDataCfg({fields:{columns:t},meta:r}),e.render(!0)}else{const[d]=N([a.field],t);if(d){const A=(i=d.children)==null?void 0:i.findIndex(y=>y.key===m.getMeta().field),[T]=N([m.getMeta().field],d.children);(h=d.children)==null||h.splice(A,1,...T.children);const c=r.findIndex(y=>y.field===m.getMeta().field);r.splice(c,1);const s=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),u=S(t,s);B("onConfigChange",{columns:M(u),meta:M(r)}),e.setDataCfg({fields:{columns:t},meta:r}),e.render(!0)}}e.interaction.clearState()};const G=document.createElement("span");H.appendChild(G),G.innerText=g("chart.cancel_all_group"),G.onclick=()=>{var i,h;e.hideTooltip();const a=m.getMeta().parent;if((a==null?void 0:a.id)==="root"){const[d]=N([m.getMeta().field],t),A=te(d.children),T=t.findIndex(w=>w.key===m.getMeta().field);t.splice(T,1,...A);const c=Y([d]),s=r.filter(w=>!c.includes(w.field)),u=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),y=S(t,u);B("onConfigChange",{columns:M(y),meta:M(s)}),e.setDataCfg({fields:{columns:t},meta:s}),e.render(!0)}else{const[d]=N([a.field],t);if(d){const[A]=N([m.getMeta().field],d.children),T=te(A.children),c=(i=d.children)==null?void 0:i.findIndex(K=>K.key===m.getMeta().field);(h=d.children)==null||h.splice(c,1,...T);const s=Y([A]),u=r.filter(K=>!s.includes(K.field)),y=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),w=S(t,y);B("onConfigChange",{columns:M(w),meta:M(u)}),e.setDataCfg({fields:{columns:t},meta:u}),e.render(!0)}}e.interaction.clearState()};const p=document.createElement("span");H.appendChild(p),p.innerText=g("chart.rename"),p.onclick=()=>{e.hideTooltip();const a=r.find(i=>i.field===m.getMeta().field);v.prompt("",g("chart.group_name"),{confirmButtonText:g("chart.confirm"),cancelButtonText:g("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:g("chart.group_name_edit_tip"),inputValue:a.name,inputErrorMessage:g("chart.group_name_error_tip"),inputValidator:i=>(i==null?void 0:i.length)<1||(i==null?void 0:i.length)>20?g("chart.group_name_error_tip"):!0}).then(i=>{const h=i.value;a.name=h;const d=(c,s,u)=>{for(const y of c){if(y.key===s){y.name=u;break}y.children&&d(y.children,s,u)}};d(t,m.getMeta().field,h);const A=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),T=S(t,A);B("onConfigChange",{columns:M(T),meta:M(r)}),e.setDataCfg({fields:{columns:t},meta:r}),e.render(!0)}).catch(()=>{})},e.showTooltip({position:{x:b.x,y:b.y},content:H});return}if((x==null?void 0:x.length)>1){if(!z.every(c=>c.getMeta().parent===m.getMeta().parent))return;let G=-1,p=m;for(;(V=(F=p==null?void 0:p.getMeta)==null?void 0:F.call(p))!=null&&V.parent||p!=null&&p.parent;)G++,p=((q=(P=p==null?void 0:p.getMeta)==null?void 0:P.call(p))==null?void 0:q.parent)||(p==null?void 0:p.parent);let a=-1,i=-1;const h=m.getMeta().parent;h.colIndex!==-1?x.forEach(c=>{const s=h.children.findIndex(u=>u.getMeta().field===c.key);(s<a||a===-1)&&(a=s),(s>i||i===-1)&&(i=s)}):x.forEach(c=>{const s=h.children.findIndex(u=>u.key===c.key);(s<a||a===-1)&&(a=s),(s>i||i===-1)&&(i=s)});const d=[];if((h==null?void 0:h.id)==="root")d.push(...t.slice(a,i+1));else{const[c]=N([h.field],t);d.push(...(J=c.children)==null?void 0:J.slice(a,i+1))}if(he(d)+G>1)return;const T=document.createElement("span");H.appendChild(T),console.log("在 mergeBtn.onclick 之前查看 totalColumns: ",d),T.innerText=g("chart.merge_group"),T.onclick=()=>{e.hideTooltip(),v.prompt("",g("chart.group_name"),{confirmButtonText:g("chart.confirm"),cancelButtonText:g("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:g("chart.group_name_edit_tip"),inputErrorMessage:g("chart.group_name_error_tip"),inputValue:g("chart.group"),inputValidator:c=>(c==null?void 0:c.length)<1||(c==null?void 0:c.length)>20?g("chart.group_name_error_tip"):!0}).then(c=>{var $;const s=c.value,u=Ae.v4(),y=(C.chart.xAxis||[]).concat(C.chart.yAxis||[]),w=S(d,y);if(console.log("allFields:",y),console.log("totalColumns:",d),console.log("filledChildren:",w),(h==null?void 0:h.id)==="root")t.splice(a,i-a+1,{key:u,name:s,children:w});else{const[Me]=N([h.field],t);($=Me.children)==null||$.splice(a,i-a+1,{key:u,name:s,children:w})}r.push({field:u,name:s});const K=S(t,y);B("onConfigChange",{columns:M(K),meta:M(r)}),e.setDataCfg({fields:{columns:t},meta:r}),e.render(!0),e.interaction.clearState()}).catch(()=>{})},e.showTooltip({position:{x:b.x,y:b.y},content:H});return}}),e.on(ee.COL_CELL_CLICK,b=>{const t=e.store.get("lastClickedCell"),r=b.originalEvent;if(!t||!(r!=null&&r.ctrlKey||r!=null&&r.metaKey||r!=null&&r.shiftKey)){const z=e.getCell(b.target);e.store.set("lastClickedCell",z);return}if(r!=null&&r.shiftKey){if(!t){const _=e.getCell(b.target);e.store.set("lastClickedCell",_);return}const z=e.getCell(b.target),L=t.getMeta(),x=z.getMeta();if(L.key===x.key||L.level!==x.level||L.parent!==x.parent)return;const m=x.parent,F=m.children.findIndex(_=>_.key===L.key),V=m.children.findIndex(_=>_.key===x.key),P=Math.min(F,V),q=Math.max(F,V),J=m.children.slice(P,q+1);e.interaction.clearState(),J.forEach(_=>{e.interaction.selectHeaderCell({cell:_.belongsCell,isMultiSelection:!0})})}}),e.render()},Y=n=>{const o=[],f=l=>{var k;if(((k=l.children)==null?void 0:k.length)>0){o.push(l.key);for(let I=0;I<l.children.length;I++)f(l.children[I])}};return n.forEach(l=>f(l)),o},he=n=>{if(!(n!=null&&n.length))return 0;const o=l=>{if(!l.children||l.children.length===0)return 0;const k=l.children.map(I=>o(I));return Math.max(...k)+1},f=n.map(l=>o(l));return Math.max(...f)},ge=Ne((n,o)=>{e&&(e.changeSheetSize(n,o),e.render(!1))},500),D=[0,0];let O;De(()=>{ue(),O=new ResizeObserver(([n]=[])=>{const[o]=n.borderBoxSize||[];D[0]||D[1]||(D[0]=o.inlineSize,D[1]=o.blockSize);const f=Math.abs(o.inlineSize-D[0]),l=Math.abs(o.blockSize-D[1]);f<se&&l<se||(D[0]=o.inlineSize,D[1]=o.blockSize,ge(o.inlineSize,Math.round(o.blockSize)))}),O.observe(document.getElementById(U.value))}),Ee(()=>{O==null||O.disconnect()});class Ce extends Te{show(o){super.show(o),this.container.style.display="flex"}hide(){this.container&&(this.container.style.display="none")}}return(n,o)=>{const f=ke;return ze(),Ge(He,null,[W("div",{id:U.value,class:"table-container"},null,8,Fe),W("div",Ve,[ne(f,{effect:X.themes,onClick:de},{default:re(()=>[ie(ce(ae(g)("chart.cancel")),1)]),_:1},8,["effect"]),ne(f,{type:"primary",onClick:pe},{default:re(()=>[ie(ce(ae(g)("chart.confirm")),1)]),_:1})]),W("div",{id:Q.value,class:"group-menu"},null,8,Ke)],64)}}});const tn=Oe(Re,[["__scopeId","data-v-6d8f7eea"]]);export{tn as default};
