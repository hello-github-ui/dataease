import{b as je}from"./chart-0.0.0-dataease2.js";import{c as U,C as _,d as Ne}from"./index-0.0.0-dataease19.js";import{useAppStoreWithOut as Ce}from"./app-0.0.0-dataease.js";import{d as ze}from"./dvMain-0.0.0-dataease.js";import{V as Re}from"./ViewTrackBar-0.0.0-dataease.js";import{d as Ge,ah as We,t as Je,r as E,Z as He,s as Ze,G as Qe,o as Ue,a as Xe,f as X,L as de,k as Ye,j as Ke,V as $e,g as et,n as tt}from"./vue-0.0.0-dataease.js";import{p as fe}from"./util-0.0.0-dataease2.js";import it from"./ChartError-0.0.0-dataease.js";import{B as at}from"./chart-0.0.0-dataease.js";import{r as pe,e as nt,f as ot}from"./canvasStyle-0.0.0-dataease.js";import{i as rt,P as lt,o as st}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{v as ct,Q as ut}from"./canvasUtils-0.0.0-dataease.js";import{u as Y}from"./index-0.0.0-dataease.js";import{a1 as dt}from"./antv-0.0.0-dataease.js";import{z as ft,d as pt}from"./lodash-0.0.0-dataease.js";import{_ as mt}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./index-0.0.0-dataease20.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./row-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./el-dropdown-menu-0.0.0-dataease.js";import"./index-0.0.0-dataease3.js";import"./dropdown-0.0.0-dataease.js";import"./refs-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import"./el-dropdown-item-0.0.0-dataease.js";import"./el-dialog-0.0.0-dataease.js";import"./use-dialog-0.0.0-dataease.js";import"./el-main-0.0.0-dataease.js";import"./index-0.0.0-dataease14.js";import"./translate-0.0.0-dataease.js";import"./eventBus-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease.js";import"./snapshot-0.0.0-dataease.js";import"./ModelUtil-0.0.0-dataease.js";const vt={class:"canvas-area"},me=.01,gt=Ge({__name:"ChartComponentG2Plot",props:{element:{type:Object,default(){return{propValue:null}}},view:{type:Object,default(){return{propValue:null}}},showPosition:{type:String,required:!1,default:"canvas"},scale:{type:Number,required:!1,default:1},terminal:{type:String,default:"pc"},suffixId:{type:String,required:!1,default:"common"},fontFamily:{type:String,required:!1,default:"inherit"}},emits:["onPointClick","onChartClick","onDrillFilters","onJumpClick","resetLoading"],setup(K,{expose:ve,emit:ge}){const{t:ye}=st(),D=ze(),{nowPanelTrackInfo:q,nowPanelJumpInfo:V,mobileInPc:$,embeddedCallBack:he,inMobile:ee}=We(D),{emitter:I}=Y(),b=K,L=ge,ke=["bidirectional-bar"],Se=["bar-range"],Ae=["circle-packing"],Pe=["bar-stack","bar-group-stack","percentage-bar-stack","bar-stack-horizontal","percentage-bar-stack-horizontal"],Te=["bar-group"],{view:c,showPosition:te,scale:ie,terminal:ae,suffixId:be}=Je(b),N=E(!1),ne=E(""),O=E(!1),oe=!ct()&&rt(),s=He({trackBarStyle:{position:"absolute",left:"50px",top:"50px"},trackBarStyleMobile:{position:"absolute",left:"50px",top:"50px"},linkageActiveParam:null,pointParam:null,data:{fields:[]}});let A=Ze({fields:[]});const x="container-"+te.value+"-"+c.value.id+"-"+be.value,re=E(null),xe=()=>{O.value=!1;try{i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1)}catch{console.warn("clearLinkage error")}},we=()=>{var a;O.value=!1,((a=i==null?void 0:i.chart)==null?void 0:a.getController("slider"))||i==null||i.render()},Le=()=>{O.value&&we(),tt(()=>{le()})},le=()=>{O.value=!0,i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1),i==null||i.setState("active",e=>Array.isArray(e)?!1:C(e)),i==null||i.setState("inactive",e=>Array.isArray(e)?!1:!C(e)),i==null||i.setState("selected",e=>Array.isArray(e)?!1:C(e))},C=e=>{var h,k;const a=Array.from(new Set((h=A.value)==null?void 0:h.fields.map(u=>u.id).filter(u=>Object.keys(q.value).some(d=>d.startsWith(c.value.id)&&d.split("#")[1]===u)))),[n,t,o]=["xAxis","xAxisExt","extStack"].map(u=>c.value[u].find(d=>a.includes(d.id))),{group:r,name:l,category:f}=s.linkageActiveParam;if(ke.includes(c.value.type))return l===e.field;if(Se.includes(c.value.type))return f===e.category;if(Ae.includes(c.value.type))return(k=e.path)!=null&&k.startsWith(l)||l===ye("commons.all")?!0:l===e.name;if(Te.includes(c.value.type)){const u=l===e.name||l==="NO_DATA"&&!e.name,d=f===e.category;return n&&t?u&&d:n&&!t?u:!n&&t?d:!1}else if(Pe.includes(c.value.type)){const u=r===e.group||r==="NO_DATA"&&!e.group,d=l===e.name||l==="NO_DATA"&&!e.name,p=f===e.category;return n&&t&&o?d&&u&&p:n&&!t&&!o?d:!n&&t&&!o?u:!n&&!t&&o?p:n&&t&&!o?d&&u:n&&!t&&o?d&&p:!n&&t&&o?u&&p:!1}else return(l===e.name||l==="NO_DATA"&&!e.name)&&f===e.category},_e=async(e,a)=>{if(e.tableId||e.dataFrom==="template"){N.value=!1;const n=JSON.parse(JSON.stringify(e));je(n).then(async t=>{var o,r,l,f,h,k,u,d;if(t.code&&t.code!==0)N.value=!0,ne.value=t.msg,a==null||a();else{if(A.value=t==null?void 0:t.data,L("onDrillFilters",t==null?void 0:t.drillFilters),!((o=t==null?void 0:t.drillFilters)!=null&&o.length))y.value="",G=null;else{const p=(f=(r=e.chartExtRequest)==null?void 0:r.drill)==null?void 0:f[((l=t==null?void 0:t.drillFilters)==null?void 0:l.length)-1].extra;y.value=(p==null?void 0:p.adcode)+"",G=p==null?void 0:p.scope;const P=(h=fe(e.customAttr))==null?void 0:h.map;if(P){let T=P.id;w.value=T.slice(0,3)}(k=y.value)!=null&&k.startsWith(w.value)||(w.value==="cus"?y.value="156"+y.value:y.value=w.value+y.value)}D.setViewDataDetails(e.id,t),!t.drill&&!((d=(u=t.chartExtRequest)==null?void 0:u.linkageFilters)!=null&&d.length)&&(D.setViewOriginData(e.id,A.value),I.emit("chart-data-change")),await j(t,a)}}).catch(()=>{a==null||a()})}else["bubble-map","map","flow-map","heat-map"].includes(e.type)&&await j(e,a),a==null||a()};let m;const j=async(e,a)=>{if(!e)return;m=e;const n=lt({...ft(e,pt(at)),data:A.value,...b.fontFamily&&b.fontFamily!=="inherit"?{fontFamily:b.fontFamily}:{}}),t=U.getChartView(e.render,e.type);switch(pe(nt,n.customAttr,ie.value,ae.value),pe(ot,n.customStyle,ie.value,ae.value),t.library){case _.L7_PLOT:await Ie(n,t,a);break;case _.L7:await De(n,t,a);break;case _.G2_PLOT:await Ee(n,t),a==null||a();break}};let i=null,z;const Ee=async(e,a)=>{z&&clearTimeout(z),z=setTimeout(async()=>{try{Ne([1],x),i==null||i.destroy(),i=await a.drawChart({chartObj:i,container:x,chart:e,scale:1,action:H,quadrantDefaultBaseline:Fe}),i==null||i.render(),O.value&&le()}catch(n){console.error("renderG2Plot error",n)}},300)},y=E(""),w=E("");Ce();const R=E(null);let G,W;const Ie=async(e,a,n)=>{let o=fe(e.customAttr).map.id;w.value=o.slice(0,3),y.value&&(w.value==="000"&&y.value.startsWith("000")?(w.value=y.value.slice(3),o=w.value):o=y.value),W&&clearTimeout(W),W=setTimeout(async()=>{i==null||i.destroy(),R.value&&(R.value.textContent=""),i=await a.drawChart({chartObj:i,container:x,chart:e,areaId:o,action:H,scope:G}),n==null||n(),L("resetLoading")},500)};let J;const De=async(e,a,n)=>{J&&clearTimeout(J),J=setTimeout(async()=>{i=await a.drawChart({chartObj:i,container:x,chart:e,action:H}),i==null||i.render(),n==null||n(),L("resetLoading")},500)},Oe=()=>{he.value==="yes"&&Z("pointClick")},Be=e=>{e.from==="map"&&I.emit("map-default-range",e),e.from==="word-cloud"&&I.emit("word-cloud-default-data-range",e),e.from==="gauge"&&I.emit("gauge-default-data",e),e.from==="liquid"&&I.emit("liquid-default-data",e)},H=e=>{var a,n,t,o;if(e.from){Be(e);return}if(!(c.value.type==="map"&&!((n=(a=e==null?void 0:e.data)==null?void 0:a.data)!=null&&n.quotaList&&((o=(t=e==null?void 0:e.data)==null?void 0:t.data)==null?void 0:o.quotaList.length)>0)))if(s.pointParam=e.data,Oe(),s.linkageActiveParam={category:s.pointParam.data.category?s.pointParam.data.category:"NO_DATA",name:s.pointParam.data.name?s.pointParam.data.name:"NO_DATA",group:s.pointParam.data.group?s.pointParam.data.group:"NO_DATA"},B.value.length<2)Z(B.value[0]);else{const r={left:e.x-50,top:e.y+10};ut(b.element,r,b.scale,B.value.length);const l=r.left;let f=50;s.trackBarStyle.left=r.left+"px",m.type==="symbolic-map"?(f=e.y+10,s.trackBarStyle.top=e.y+10+"px"):(f=r.top,s.trackBarStyle.top=r.top+"px"),oe?(s.trackBarStyle.left=l+40+"px",s.trackBarStyle.top=f+70+"px"):(s.trackBarStyle.left=l+"px",s.trackBarStyle.top=f+"px"),re.value.trackButtonClick()}},Z=e=>{var h,k,u,d,p,P,T,S,ce;const a=s.pointParam;if(!((h=a==null?void 0:a.data)!=null&&h.dimensionList))return;let n;if(a.data.dimensionList.length>1){if(c.value.type==="bar-group-stack"){const g=a.data.dimensionList.length;a.data.dimensionList[g-1].id===a.data.dimensionList[g-2].id&&a.data.dimensionList.pop(),a.data.dimensionList.forEach(v=>{v.value===a.data.category&&(n=v.id)})}n||(n=a.data.dimensionList[0].id)}n||(n=a.data.name);let t=s.pointParam.data.name;if(s.pointParam.data.dimensionList.length>1){const g=[];if(m.drill){const v=m.drillFields[m.drillFilters.length];g.push(v.id)}m.type.includes("chart-mix")?((d=(u=(k=A.value)==null?void 0:k.left)==null?void 0:u.fields)==null||d.forEach(v=>{g.includes(v.id)||g.push(v.id)}),(T=(P=(p=A.value)==null?void 0:p.right)==null?void 0:P.fields)==null||T.forEach(v=>{g.includes(v.id)||g.push(v.id)})):(ce=(S=A.value)==null?void 0:S.fields)==null||ce.forEach(v=>{g.includes(v.id)||g.push(v.id)});for(let v=0;v<g.length;v++){const ue=g[v],Ve=c.value.id+"#"+ue;if(V.value[Ve]){t=ue;break}}}let o=s.pointParam.data.quotaList;["bar-range"].includes(m.type)?o=s.pointParam.data.dimensionList:o[0].value=s.pointParam.data.value;const r={option:"linkage",name:n,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:o},l={option:"jump",name:t,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:o},f={option:"pointClick",name:n,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:o};switch(e){case"pointClick":L("onPointClick",f);break;case"linkageAndDrill":D.addViewTrackFilter(r),L("onChartClick",a);break;case"drill":L("onChartClick",a);break;case"linkage":Le(),D.addViewTrackFilter(r);break;case"jump":if($.value&&!ee.value)return;L("onJumpClick",l);break}},B=Qe(()=>{var a,n,t,o,r,l,f,h,k,u,d;let e=[];if(!["multiplexing","viewDialog"].includes(te.value)){let p=0,P=0;(a=m==null?void 0:m.type)!=null&&a.includes("chart-mix")?((o=(t=(n=A.value)==null?void 0:n.left)==null?void 0:t.fields)==null||o.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&p++,V.value[S]&&P++}),(f=(l=(r=A.value)==null?void 0:r.right)==null?void 0:l.fields)==null||f.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&p++,V.value[S]&&P++})):(k=(h=A.value)==null?void 0:h.fields)==null||k.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&p++,V.value[S]&&P++}),P&&((u=c.value)!=null&&u.jumpActive)&&(!$.value||ee.value)&&e.push("jump"),p&&((d=c.value)!=null&&d.linkageActive)&&e.push("linkage"),c.value.drillFields.length&&e.push("drill"),e.length===3&&b.element.actionSelection.linkageActive==="auto"?e=["jump","linkageAndDrill"]:e.length===2&&b.element.actionSelection.linkageActive==="auto"&&!e.includes("jump")&&(e=["linkageAndDrill"])}return e}),Fe=e=>{I.emit("quadrant-default-baseline",e)},Q=(e,a)=>{const n=document.getElementById(x),t=n.querySelectorAll(".l7-scene");if(t!=null&&t.length&&t.forEach(r=>{r.style.display="none"}),a){const r=n.querySelectorAll(".amap-maps");r==null||r.forEach(l=>{l.style.display="none"})}const o=document.createElement("img");o.style.width="100%",o.style.height="100%",o.style.position="absolute",o.style.objectFit="cover",o.style["z-index"]="2",o.classList.add("prepare-picture-img"),o.src=e,n.appendChild(o)},Me=e=>{if(e!==m.id)return;const a=U.getChartView(m.render,m.type);if(a.library===_.L7_PLOT)i.getScene().exportMap("png").then(n=>Q(n,!1));else if(a.library===_.L7){const n=i.getScene(),t=new dt({onExport:o=>{Q(o,!0)}});n.addControl(t),t.hide(),t.getImage().then(o=>{Q(o,!0)})}},qe=e=>{if(e!==m.id)return;const a=U.getChartView(m.render,m.type);if(a.library===_.L7_PLOT||a.library===_.L7){const n=document.getElementById(x),t=n.querySelectorAll(".l7-scene");t!=null&&t.length&&t.forEach(l=>{l.style.display="block"});const o=n.querySelectorAll(".prepare-picture-img");o==null||o.forEach(l=>{l.remove()});const r=n.querySelectorAll(".amap-maps");r==null||r.forEach(l=>{l.style.display="block"})}};ve({calcData:_e,renderChart:j,trackMenu:B,clearLinkage:xe});let F,M;const se=["map","bubble-map","flow-map","heat-map"];return Ue(()=>{const e=document.getElementById(x),{offsetWidth:a,offsetHeight:n}=e,t=[a,n];M=new ResizeObserver(([o]=[])=>{if(!se.includes(c.value.type))return;const[r]=o.borderBoxSize||[],l=(r.inlineSize-t[0])/t[0],f=(r.blockSize-t[1])/t[1];Math.abs(l)<me&&Math.abs(f)<me||(i&&t[1]>1&&j(m),t[0]=r.inlineSize,t[1]=r.blockSize)}),M.observe(e),F=new IntersectionObserver(([o])=>{se.includes(c.value.type)||o.intersectionRatio<=0&&(i==null||i.emit("tooltip:hidden"))}),F.observe(e),Y({name:"l7-prepare-picture",callback:Me}),Y({name:"l7-unprepare-picture",callback:qe})}),Xe(()=>{try{i==null||i.destroy(),M==null||M.disconnect(),F==null||F.disconnect()}catch(e){console.warn(e)}}),(e,a)=>(X(),de("div",vt,[Ye(Re,{ref_key:"viewTrack",ref:re,"track-menu":B.value,"font-family":K.fontFamily,"is-data-v-mobile":Ke(oe),class:"track-bar",style:$e(s.trackBarStyle),onTrackClick:Z},null,8,["track-menu","font-family","is-data-v-mobile","style"]),N.value?(X(),et(it,{key:1,"err-msg":ne.value},null,8,["err-msg"])):(X(),de("div",{key:0,ref_key:"chartContainer",ref:R,class:"canvas-content",id:x},null,512))]))}});const pi=mt(gt,[["__scopeId","data-v-b735150f"]]);export{pi as default};
