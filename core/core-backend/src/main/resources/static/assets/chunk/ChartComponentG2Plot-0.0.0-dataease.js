import{g as Ve}from"./chart-0.0.0-dataease2.js";import{c as U,C as L,h as Ne}from"./index-0.0.0-dataease12.js";import{useAppStoreWithOut as Ce}from"./app-0.0.0-dataease.js";import{d as ze}from"./dvMain-0.0.0-dataease.js";import{V as Re}from"./ViewTrackBar-0.0.0-dataease.js";import{s as Ge}from"./pinia-0.0.0-dataease.js";import{p as pe}from"./util-0.0.0-dataease2.js";import We from"./ChartError-0.0.0-dataease.js";import{B as Je}from"./chart-0.0.0-dataease.js";import{r as me,e as He,f as Ze}from"./canvasStyle-0.0.0-dataease.js";import{i as Qe,A as Ue,j as Xe}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{v as Ye,Q as Ke}from"./canvasUtils-0.0.0-dataease.js";import{u as X}from"./index-0.0.0-dataease.js";import{W as $e}from"./@antv-0.0.0-dataease.js";import"./lodash-0.0.0-dataease.js";import"./eventemitter3-0.0.0-dataease.js";import{A as et,e as tt}from"./lodash-es-0.0.0-dataease.js";import{d as it,t as ot,r as E,l as rt,x as at,k as nt,b as lt,e as st,o as Y,c as de,a0 as ct,u as ut,a3 as pt,Z as mt,n as dt}from"./@vue-0.0.0-dataease.js";import{_ as ft}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./jspdf-0.0.0-dataease.js";import"./@babel-0.0.0-dataease.js";import"./@amap-0.0.0-dataease.js";import"./fflate-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./@turf-0.0.0-dataease.js";import"./polygon-clipping-0.0.0-dataease.js";import"./splaytree-0.0.0-dataease.js";import"./robust-predicates-0.0.0-dataease.js";import"./mathjs-0.0.0-dataease.js";import"./decimal.js-0.0.0-dataease.js";import"./typed-function-0.0.0-dataease.js";import"./complex.js-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./element-plus-secondary-0.0.0-dataease.js";import"./@vueuse-0.0.0-dataease.js";import"./@element-plus-0.0.0-dataease.js";import"./dayjs-0.0.0-dataease.js";import"./async-validator-0.0.0-dataease.js";import"./@ctrl-0.0.0-dataease.js";import"./@popperjs-0.0.0-dataease.js";import"./escape-html-0.0.0-dataease.js";import"./normalize-wheel-es-0.0.0-dataease.js";import"./memoize-one-0.0.0-dataease.js";import"./vue-demi-0.0.0-dataease.js";import"./mitt-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./vue-types-0.0.0-dataease.js";import"./is-plain-object-0.0.0-dataease.js";import"./vue-i18n-0.0.0-dataease.js";import"./@intlify-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./qs-0.0.0-dataease.js";import"./side-channel-0.0.0-dataease.js";import"./es-errors-0.0.0-dataease.js";import"./object-inspect-0.0.0-dataease.js";import"./crypto-js-0.0.0-dataease.js";import"./side-channel-list-0.0.0-dataease.js";import"./side-channel-map-0.0.0-dataease.js";import"./get-intrinsic-0.0.0-dataease.js";import"./es-object-atoms-0.0.0-dataease.js";import"./math-intrinsics-0.0.0-dataease.js";import"./gopd-0.0.0-dataease.js";import"./es-define-property-0.0.0-dataease.js";import"./has-symbols-0.0.0-dataease.js";import"./get-proto-0.0.0-dataease.js";import"./dunder-proto-0.0.0-dataease.js";import"./call-bind-apply-helpers-0.0.0-dataease.js";import"./function-bind-0.0.0-dataease.js";import"./hasown-0.0.0-dataease.js";import"./call-bound-0.0.0-dataease.js";import"./side-channel-weakmap-0.0.0-dataease.js";import"./vue-router-0.0.0-dataease.js";import"./vue-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./zrender-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./@mapbox-0.0.0-dataease.js";import"./pbf-0.0.0-dataease.js";import"./ieee754-0.0.0-dataease.js";import"./supercluster-0.0.0-dataease.js";import"./gl-matrix-0.0.0-dataease.js";import"./tslib-0.0.0-dataease.js";import"./topojson-client-0.0.0-dataease.js";import"./viewport-mercator-project-0.0.0-dataease.js";import"./d3-scale-0.0.0-dataease.js";import"./d3-collection-0.0.0-dataease.js";import"./d3-format-0.0.0-dataease.js";import"./d3-time-format-0.0.0-dataease.js";import"./d3-time-0.0.0-dataease.js";import"./d3-color-0.0.0-dataease.js";import"./d3-array-0.0.0-dataease.js";import"./earcut-0.0.0-dataease.js";import"./regl-0.0.0-dataease.js";import"./mapbox-gl-0.0.0-dataease.js";import"./d3-dsv-0.0.0-dataease.js";import"./geojson-vt-0.0.0-dataease.js";import"./hammerjs-0.0.0-dataease.js";import"./element-resize-detector-0.0.0-dataease.js";import"./batch-processor-0.0.0-dataease.js";import"./d3-hexbin-0.0.0-dataease.js";import"./detect-browser-0.0.0-dataease.js";import"./d3-ease-0.0.0-dataease.js";import"./d3-interpolate-0.0.0-dataease.js";import"./d3-timer-0.0.0-dataease.js";import"./fecha-0.0.0-dataease.js";import"./size-sensor-0.0.0-dataease.js";import"./d3-regression-0.0.0-dataease.js";import"./d3-hierarchy-0.0.0-dataease.js";import"./fmin-0.0.0-dataease.js";import"./pdfast-0.0.0-dataease.js";import"./exceljs-0.0.0-dataease.js";import"./file-saver-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./snowflake-id-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./less-0.0.0-dataease.js";import"./copy-anything-0.0.0-dataease.js";import"./is-what-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./translate-0.0.0-dataease.js";import"./eventBus-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease.js";import"./snapshot-0.0.0-dataease.js";import"./ModelUtil-0.0.0-dataease.js";const vt={class:"canvas-area"},fe=.01,gt=it({__name:"ChartComponentG2Plot",props:{element:{type:Object,default(){return{propValue:null}}},view:{type:Object,default(){return{propValue:null}}},showPosition:{type:String,required:!1,default:"canvas"},scale:{type:Number,required:!1,default:1},terminal:{type:String,default:"pc"},suffixId:{type:String,required:!1,default:"common"},fontFamily:{type:String,required:!1,default:"inherit"}},emits:["onPointClick","onChartClick","onDrillFilters","onJumpClick","resetLoading"],setup(K,{expose:ve,emit:ge}){const{t:ye}=Xe(),D=ze(),{nowPanelTrackInfo:q,nowPanelJumpInfo:j,mobileInPc:$,embeddedCallBack:he,inMobile:ee}=Ge(D),{emitter:I}=X(),b=K,_=ge,ke=["bidirectional-bar"],Se=["bar-range"],Ae=["circle-packing"],Pe=["bar-stack","bar-group-stack","percentage-bar-stack","bar-stack-horizontal","percentage-bar-stack-horizontal"],Te=["bar-group"],{view:c,showPosition:te,scale:ie,terminal:oe,suffixId:be}=ot(b),N=E(!1),re=E(""),O=E(!1),ae=!Ye()&&Qe(),s=rt({trackBarStyle:{position:"absolute",left:"50px",top:"50px"},trackBarStyleMobile:{position:"absolute",left:"50px",top:"50px"},linkageActiveParam:null,pointParam:null,data:{fields:[]}});let A=at({fields:[]});const x="container-"+te.value+"-"+c.value.id+"-"+be.value,ne=E(null),xe=()=>{O.value=!1;try{i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1)}catch{console.warn("clearLinkage error")}},we=()=>{var o;O.value=!1,((o=i==null?void 0:i.chart)==null?void 0:o.getController("slider"))||i==null||i.render()},_e=()=>{O.value&&we(),dt(()=>{le()})},le=()=>{O.value=!0,i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1),i==null||i.setState("active",e=>Array.isArray(e)?!1:C(e)),i==null||i.setState("inactive",e=>Array.isArray(e)?!1:!C(e)),i==null||i.setState("selected",e=>Array.isArray(e)?!1:C(e))},C=e=>{var h,k;const o=Array.from(new Set((h=A.value)==null?void 0:h.fields.map(u=>u.id).filter(u=>Object.keys(q.value).some(p=>p.startsWith(c.value.id)&&p.split("#")[1]===u)))),[r,t,a]=["xAxis","xAxisExt","extStack"].map(u=>c.value[u].find(p=>o.includes(p.id))),{group:n,name:l,category:m}=s.linkageActiveParam;if(ke.includes(c.value.type))return l===e.field;if(Se.includes(c.value.type))return m===e.category;if(Ae.includes(c.value.type))return(k=e.path)!=null&&k.startsWith(l)||l===ye("commons.all")?!0:l===e.name;if(Te.includes(c.value.type)){const u=l===e.name||l==="NO_DATA"&&!e.name,p=m===e.category;return r&&t?u&&p:r&&!t?u:!r&&t?p:!1}else if(Pe.includes(c.value.type)){const u=n===e.group||n==="NO_DATA"&&!e.group,p=l===e.name||l==="NO_DATA"&&!e.name,d=m===e.category;return r&&t&&a?p&&u&&d:r&&!t&&!a?p:!r&&t&&!a?u:!r&&!t&&a?d:r&&t&&!a?p&&u:r&&!t&&a?p&&d:!r&&t&&a?u&&d:!1}else return(l===e.name||l==="NO_DATA"&&!e.name)&&m===e.category},Le=async(e,o)=>{if(e.tableId||e.dataFrom==="template"){N.value=!1;const r=JSON.parse(JSON.stringify(e));Ve(r).then(async t=>{var a,n,l,m,h,k,u,p;if(t.code&&t.code!==0)N.value=!0,re.value=t.msg,o==null||o();else{if(A.value=t==null?void 0:t.data,_("onDrillFilters",t==null?void 0:t.drillFilters),!((a=t==null?void 0:t.drillFilters)!=null&&a.length))y.value="",G=null;else{const d=(m=(n=e.chartExtRequest)==null?void 0:n.drill)==null?void 0:m[((l=t==null?void 0:t.drillFilters)==null?void 0:l.length)-1].extra;y.value=(d==null?void 0:d.adcode)+"",G=d==null?void 0:d.scope;const P=(h=pe(e.customAttr))==null?void 0:h.map;if(P){let T=P.id;w.value=T.slice(0,3)}(k=y.value)!=null&&k.startsWith(w.value)||(w.value==="cus"?y.value="156"+y.value:y.value=w.value+y.value)}D.setViewDataDetails(e.id,t),!t.drill&&!((p=(u=t.chartExtRequest)==null?void 0:u.linkageFilters)!=null&&p.length)&&(D.setViewOriginData(e.id,A.value),I.emit("chart-data-change")),await V(t,o)}}).catch(()=>{o==null||o()})}else["bubble-map","map","flow-map","heat-map"].includes(e.type)&&await V(e,o),o==null||o()};let f;const V=async(e,o)=>{if(!e)return;f=e;const r=Ue({...et(e,tt(Je)),data:A.value,...b.fontFamily&&b.fontFamily!=="inherit"?{fontFamily:b.fontFamily}:{}}),t=U.getChartView(e.render,e.type);switch(me(He,r.customAttr,ie.value,oe.value),me(Ze,r.customStyle,ie.value,oe.value),t.library){case L.L7_PLOT:await Ie(r,t,o);break;case L.L7:await De(r,t,o);break;case L.G2_PLOT:await Ee(r,t),o==null||o();break}};let i=null,z;const Ee=async(e,o)=>{z&&clearTimeout(z),z=setTimeout(async()=>{try{Ne([1],x),i==null||i.destroy(),i=await o.drawChart({chartObj:i,container:x,chart:e,scale:1,action:H,quadrantDefaultBaseline:Fe}),i==null||i.render(),O.value&&le()}catch(r){console.error("renderG2Plot error",r)}},300)},y=E(""),w=E("");Ce();const R=E(null);let G,W;const Ie=async(e,o,r)=>{let a=pe(e.customAttr).map.id;w.value=a.slice(0,3),y.value&&(w.value==="000"&&y.value.startsWith("000")?(w.value=y.value.slice(3),a=w.value):a=y.value),W&&clearTimeout(W),W=setTimeout(async()=>{i==null||i.destroy(),R.value&&(R.value.textContent=""),i=await o.drawChart({chartObj:i,container:x,chart:e,areaId:a,action:H,scope:G}),r==null||r(),_("resetLoading")},500)};let J;const De=async(e,o,r)=>{J&&clearTimeout(J),J=setTimeout(async()=>{i=await o.drawChart({chartObj:i,container:x,chart:e,action:H}),i==null||i.render(),r==null||r(),_("resetLoading")},500)},Oe=()=>{he.value==="yes"&&Z("pointClick")},Be=e=>{e.from==="map"&&I.emit("map-default-range",e),e.from==="word-cloud"&&I.emit("word-cloud-default-data-range",e),e.from==="gauge"&&I.emit("gauge-default-data",e),e.from==="liquid"&&I.emit("liquid-default-data",e)},H=e=>{var o,r,t,a;if(e.from){Be(e);return}if(!(c.value.type==="map"&&!((r=(o=e==null?void 0:e.data)==null?void 0:o.data)!=null&&r.quotaList&&((a=(t=e==null?void 0:e.data)==null?void 0:t.data)==null?void 0:a.quotaList.length)>0)))if(s.pointParam=e.data,Oe(),s.linkageActiveParam={category:s.pointParam.data.category?s.pointParam.data.category:"NO_DATA",name:s.pointParam.data.name?s.pointParam.data.name:"NO_DATA",group:s.pointParam.data.group?s.pointParam.data.group:"NO_DATA"},B.value.length<2)Z(B.value[0]);else{const n={left:e.x-50,top:e.y+10};Ke(b.element,n,b.scale,B.value.length);const l=n.left;let m=50;s.trackBarStyle.left=n.left+"px",f.type==="symbolic-map"?(m=e.y+10,s.trackBarStyle.top=e.y+10+"px"):(m=n.top,s.trackBarStyle.top=n.top+"px"),ae?(s.trackBarStyle.left=l+40+"px",s.trackBarStyle.top=m+70+"px"):(s.trackBarStyle.left=l+"px",s.trackBarStyle.top=m+"px"),ne.value.trackButtonClick()}},Z=e=>{var h,k,u,p,d,P,T,S,ce;const o=s.pointParam;if(!((h=o==null?void 0:o.data)!=null&&h.dimensionList))return;let r;if(o.data.dimensionList.length>1){if(c.value.type==="bar-group-stack"){const g=o.data.dimensionList.length;o.data.dimensionList[g-1].id===o.data.dimensionList[g-2].id&&o.data.dimensionList.pop(),o.data.dimensionList.forEach(v=>{v.value===o.data.category&&(r=v.id)})}r||(r=o.data.dimensionList[0].id)}r||(r=o.data.name);let t=s.pointParam.data.name;if(s.pointParam.data.dimensionList.length>1){const g=[];if(f.drill){const v=f.drillFields[f.drillFilters.length];g.push(v.id)}f.type.includes("chart-mix")?((p=(u=(k=A.value)==null?void 0:k.left)==null?void 0:u.fields)==null||p.forEach(v=>{g.includes(v.id)||g.push(v.id)}),(T=(P=(d=A.value)==null?void 0:d.right)==null?void 0:P.fields)==null||T.forEach(v=>{g.includes(v.id)||g.push(v.id)})):(ce=(S=A.value)==null?void 0:S.fields)==null||ce.forEach(v=>{g.includes(v.id)||g.push(v.id)});for(let v=0;v<g.length;v++){const ue=g[v],je=c.value.id+"#"+ue;if(j.value[je]){t=ue;break}}}let a=s.pointParam.data.quotaList;["bar-range"].includes(f.type)?a=s.pointParam.data.dimensionList:a[0].value=s.pointParam.data.value;const n={option:"linkage",name:r,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:a},l={option:"jump",name:t,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:a},m={option:"pointClick",name:r,viewId:c.value.id,dimensionList:s.pointParam.data.dimensionList,quotaList:a};switch(e){case"pointClick":_("onPointClick",m);break;case"linkageAndDrill":D.addViewTrackFilter(n),_("onChartClick",o);break;case"drill":_("onChartClick",o);break;case"linkage":_e(),D.addViewTrackFilter(n);break;case"jump":if($.value&&!ee.value)return;_("onJumpClick",l);break}},B=nt(()=>{var o,r,t,a,n,l,m,h,k,u,p;let e=[];if(!["multiplexing","viewDialog"].includes(te.value)){let d=0,P=0;(o=f==null?void 0:f.type)!=null&&o.includes("chart-mix")?((a=(t=(r=A.value)==null?void 0:r.left)==null?void 0:t.fields)==null||a.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&d++,j.value[S]&&P++}),(m=(l=(n=A.value)==null?void 0:n.right)==null?void 0:l.fields)==null||m.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&d++,j.value[S]&&P++})):(k=(h=A.value)==null?void 0:h.fields)==null||k.forEach(T=>{const S=c.value.id+"#"+T.id;q.value[S]&&d++,j.value[S]&&P++}),P&&((u=c.value)!=null&&u.jumpActive)&&(!$.value||ee.value)&&e.push("jump"),d&&((p=c.value)!=null&&p.linkageActive)&&e.push("linkage"),c.value.drillFields.length&&e.push("drill"),e.length===3&&b.element.actionSelection.linkageActive==="auto"?e=["jump","linkageAndDrill"]:e.length===2&&b.element.actionSelection.linkageActive==="auto"&&!e.includes("jump")&&(e=["linkageAndDrill"])}return e}),Fe=e=>{I.emit("quadrant-default-baseline",e)},Q=(e,o)=>{const r=document.getElementById(x),t=r.querySelectorAll(".l7-scene");if(t!=null&&t.length&&t.forEach(n=>{n.style.display="none"}),o){const n=r.querySelectorAll(".amap-maps");n==null||n.forEach(l=>{l.style.display="none"})}const a=document.createElement("img");a.style.width="100%",a.style.height="100%",a.style.position="absolute",a.style.objectFit="cover",a.style["z-index"]="2",a.classList.add("prepare-picture-img"),a.src=e,r.appendChild(a)},Me=e=>{if(e!==f.id)return;const o=U.getChartView(f.render,f.type);if(o.library===L.L7_PLOT)i.getScene().exportMap("png").then(r=>Q(r,!1));else if(o.library===L.L7){const r=i.getScene(),t=new $e({onExport:a=>{Q(a,!0)}});r.addControl(t),t.hide(),t.getImage().then(a=>{Q(a,!0)})}},qe=e=>{if(e!==f.id)return;const o=U.getChartView(f.render,f.type);if(o.library===L.L7_PLOT||o.library===L.L7){const r=document.getElementById(x),t=r.querySelectorAll(".l7-scene");t!=null&&t.length&&t.forEach(l=>{l.style.display="block"});const a=r.querySelectorAll(".prepare-picture-img");a==null||a.forEach(l=>{l.remove()});const n=r.querySelectorAll(".amap-maps");n==null||n.forEach(l=>{l.style.display="block"})}};ve({calcData:Le,renderChart:V,trackMenu:B,clearLinkage:xe});let F,M;const se=["map","bubble-map","flow-map","heat-map"];return lt(()=>{const e=document.getElementById(x),{offsetWidth:o,offsetHeight:r}=e,t=[o,r];M=new ResizeObserver(([a]=[])=>{if(!se.includes(c.value.type))return;const[n]=a.borderBoxSize||[],l=(n.inlineSize-t[0])/t[0],m=(n.blockSize-t[1])/t[1];Math.abs(l)<fe&&Math.abs(m)<fe||(i&&t[1]>1&&V(f),t[0]=n.inlineSize,t[1]=n.blockSize)}),M.observe(e),F=new IntersectionObserver(([a])=>{se.includes(c.value.type)||a.intersectionRatio<=0&&(i==null||i.emit("tooltip:hidden"))}),F.observe(e),X({name:"l7-prepare-picture",callback:Me}),X({name:"l7-unprepare-picture",callback:qe})}),st(()=>{try{i==null||i.destroy(),M==null||M.disconnect(),F==null||F.disconnect()}catch(e){console.warn(e)}}),(e,o)=>(Y(),de("div",vt,[ct(Re,{ref_key:"viewTrack",ref:ne,"track-menu":B.value,"font-family":K.fontFamily,"is-data-v-mobile":ut(ae),class:"track-bar",style:pt(s.trackBarStyle),onTrackClick:Z},null,8,["track-menu","font-family","is-data-v-mobile","style"]),N.value?(Y(),mt(We,{key:1,"err-msg":re.value},null,8,["err-msg"])):(Y(),de("div",{key:0,ref_key:"chartContainer",ref:R,class:"canvas-content",id:x},null,512))]))}});const jo=ft(gt,[["__scopeId","data-v-b735150f"]]);export{jo as default};
