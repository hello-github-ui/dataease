import{u as Ke}from"./index-0.0.0-dataease.js";import{a as Ne,E as je}from"./el-table-column-0.0.0-dataease.js";import{E as Ve}from"./el-checkbox-0.0.0-dataease.js";import"./el-tag-0.0.0-dataease.js";import"./el-tooltip-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as Be}from"./el-input-number-0.0.0-dataease.js";import{o as Le,n as Y,j as ue,D as S,F as me,y as Oe,G as Ie}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import"./el-empty-0.0.0-dataease.js";import"./el-virtual-list-0.0.0-dataease.js";import{a as ze,E as Me}from"./el-table-v2-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{a as Ue,E as Re}from"./el-form-item-0.0.0-dataease.js";import{E as qe}from"./el-upload-0.0.0-dataease.js";import"./el-progress-0.0.0-dataease.js";import{i as Ae}from"./icon_upload_outlined-0.0.0-dataease.js";import{e as $e,b as Ge,u as Pe}from"./datasource-0.0.0-dataease.js";import{g as Xe}from"./base64-0.0.0-dataease.js";import Je from"./ExcelInfo-0.0.0-dataease.js";import Ye from"./SheetTabs-0.0.0-dataease.js";import{i as pe}from"./field-list-0.0.0-dataease.js";import{d as L,e as Ze}from"./lodash-0.0.0-dataease.js";import{d as He,Z,t as Qe,r as v,s as H,G as We,n as fe,o as Ce,a as et,aa as tt,f,L as R,M as q,T as at,g as T,i as m,j as o,k as r,a5 as O,a6 as w,a0 as j,U as A,Y as lt,m as st,h as ot,al as nt}from"./vue-0.0.0-dataease.js";import{b as it}from"./pureFunctionsAny.generated-0.0.0-dataease.js";const rt={class:"excel-detail"},ct={class:"detail-inner"},dt={class:"upload-tip",style:{width:"100%"}},ut={key:0,class:"ed-form-item__error"},mt={class:"title-form_primary"},pt={key:0,class:"table-select_mode"},ft={class:"btn-select"},ht={class:"flex-align-center"};function _t(I){return typeof I=="function"||Object.prototype.toString.call(I)==="[object Object]"&&!nt(I)}const At=He({__name:"ExcelDetail",props:{param:{required:!1,default(){return Z({id:"0",name:"",desc:"",type:"Excel",editType:0})},type:Object},isSupportSetKey:{type:it,required:!0}},setup(I,{expose:he}){const g=I,{param:_,isSupportSetKey:_e}=Qe(g),{t:l}=Le(),{emitter:G}=Ke(),E=v(!1),D=H([]),y=H([]),$=v(),V={tableName:" ",sheetExcelId:"",fields:[],jsonArray:[],nameExist:!1,empty:"",overLength:!1},b=Z(L(V)),h=Z({excelData:[],defaultExpandedKeys:[],defaultCheckedKeys:[],fileList:null,sheets:[]}),z=We(()=>{const[e={}]=h.excelData;return{name:e.excelLabel,size:e.excelLabel}}),Q=v(!1),M={TEXT:"text",DATETIME:"time",LONG:"value",DOUBLE:"value"},ve=e=>e.map(t=>({key:t.originName,fieldType:t.fieldType,dataKey:t.originName,title:t.name,checked:t.checked,primaryKey:t.primaryKey,length:t.length,width:150,headerCellRenderer:({column:s})=>{let a;return r("div",{class:"flex-align-center icon"},[r(ue,null,{default:()=>[r(Y,null,_t(a=ot(pe[M[s.fieldType]],{class:`svg-icon field-icon-${M[s.fieldType]}`}))?a:{default:()=>[a]})]}),r("span",{class:"ellipsis",title:s.title,style:{width:"100px"}},[s.title])])}})),ge=e=>{e.sheet&&(Object.assign(b,e),D.value=ve(e.fields),y.value=D.value.filter(t=>t.checked),U.value="preview")},W=()=>{Q.value=!0},C=e=>{var s;k.value=e.value;const t=(s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===e.value);ge(t)},ee=e=>{h.excelData=[],k.value="",K.value=[],Object.assign(b,L(V)),e.toString().replace("Error: ","")},K=H([]),k=v(""),ye=()=>{h.excelData=[],k.value="",K.value=[],Object.assign(b,L(V))},te=e=>{if(!e)return;if((e==null?void 0:e.code)!==0){h.excelData=[],k.value="",K.value=[],Object.assign(b,L(V)),S.warning(e.msg);return}D.value=[],Object.assign(b,L(V)),y.value=[],Q.value=!1,_.value.name||(_.value.name=e.data.excelLabel),K.value=e.data.sheets.map(s=>{const{sheetId:a,tableName:n,newSheet:c}=s;return{value:a,label:n,newSheet:c}}),h.excelData=[e.data];const[t]=K.value;t&&C(t)},xe=(e,t,s)=>{var F;let a=[],n=[],c=!1,p=!1,d=(F=h.excelData[0])==null?void 0:F.sheets;for(let u=0;u<d.length;u++)if(d[u].sheet){if(d[u].effectExtField&&(c=!0),d[u].changeFiled&&(p=!0),d[u].fields.filter(x=>x.checked).length==0){S({message:d[u].excelLabel+l("datasource.api_field_not_empty"),type:"error"}),s==null||s();return}for(let x=0;x<d[u].fields.length;x++)if(d[u].fields[x].checked&&d[u].fields[x].primaryKey&&!d[u].fields[x].length&&d[u].fields[x].deExtractType===0){S({message:l("datasource.primary_key_length")+d[u].excelLabel+": "+d[u].fields[x].name,type:"error"}),s==null||s();return}a.push(d[u]),n.push(d[u].fieldsMd5)}if(!a.length){S({message:l("dataset.ple_select_excel"),type:"error"}),s==null||s();return}let B={};e&&(_.value.name=e.name),g.param.id?B={id:g.param.id,name:g.param.name,type:"Excel",sheets:a,editType:g.param.editType?g.param.editType:0}:B={id:g.param.id,name:g.param.name,type:"Excel",sheets:a,editType:0},g.param.editType===0&&g.param.id&&(c||p)?me.confirm(l("deDataset.replace_the_data"),{confirmButtonText:l("dataset.confirm"),tip:l("data_source.to_replace_it"),cancelButtonText:"Cancel",confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1,callback:u=>{u==="confirm"&&ae(n,B,e,t,s)}}):ae(n,B,e,t,s)},ae=(e,t,s,a,n)=>{for(let p=0;p<t.sheets.length;p++)t.sheets[p].data=[],t.sheets[p].jsonArray=[];t.configuration=Xe.encode(JSON.stringify(t.sheets));let c=Ge;if(!t.id||t.id==="0"?(delete t.id,t.pid=s.pid):c=Pe,new Set(e).size!==e.length&&!g.param.id)me.confirm(l("dataset.merge_title"),{confirmButtonText:l("dataset.merge"),tip:l("dataset.task.excel_replace_msg"),cancelButtonText:l("dataset.no_merge"),confirmButtonType:"primary",type:"warning",autofocus:!1,callback:p=>{p!=="close"&&(E.value=!0,t.mergeSheet=p==="confirm",p==="confirm"&&c(t).then(d=>{G.emit("showFinishPage",d),a==null||a(),S({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),E.value=!1}),p==="cancel"&&c(t).then(d=>{G.emit("showFinishPage",d),a==null||a(),S({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),E.value=!1}))}});else{if(E.value)return;E.value=!0,c(t).then(p=>{G.emit("showFinishPage",p),a==null||a(),S({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),E.value=!1})}},le=e=>{h.fileList=e},P=v(!0),se=Ze(()=>{P.value=!1,fe(()=>{P.value=!0})},500);Ce(()=>{window.addEventListener("resize",se)}),et(()=>{window.removeEventListener("resize",se)});const oe=v(),ne=v(),ie=()=>{const e=new FormData;return e.append("file",h.fileList.raw),e.append("type",""),e.append("editType",_.value.editType),e.append("id",_.value.id||0),E.value=!0,$e(e).then(t=>{var s,a;(s=oe.value)==null||s.clearFiles(),(a=ne.value)==null||a.clearFiles(),te(t),E.value=!1}).catch(t=>{h.excelData=[],k.value="",K.value=[],Object.assign(b,L(V)),t.code==="ECONNABORTED"&&S({type:"error",message:t.message,showClose:!0}),E.value=!1})},re=v(),Ee=()=>re.value.validate,ce=v(!0),ke=e=>{ce.value=!1,te(e)},X=v(!1),J=v(!1),U=v("preview"),Te=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===k.value)).fields.forEach(a=>{a.originName===e.dataKey&&(a.length=e.length)})},we=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===k.value)).fields.forEach(a=>{a.originName===e.dataKey&&(a.primaryKey=e.primaryKey)})},De=e=>{var t;J.value||(y.value=e,y.value.forEach(a=>{a.checked=!0}),D.value.forEach(a=>{let n;for(let c=0;c<y.value.length;c++)a.dataKey===y.value[c].dataKey&&(n=y.value[c]);n?a.checked=n.checked:a.checked=!1}),((t=h.excelData[0])==null?void 0:t.sheets.find(a=>a.sheetId===k.value)).fields.forEach(a=>{let n;for(let c=0;c<y.value.length;c++)a.originName===y.value[c].dataKey&&(n=y.value[c]);n?a.checked=n.checked:a.checked=!1}))},Fe=e=>{if(!e.checked||e.fieldType!=="TEXT")return!0},de=e=>{U.value=e,e==="select"&&fe(()=>{var t;J.value=!0;for(let s=0;s<D.value.length;s++)D.value[s].checked&&((t=$==null?void 0:$.value)==null||t.toggleRowSelection(D.value[s],!0));J.value=!1})};return he({saveExcelDs:xe,submitForm:Ee,sheetFile:z,appendReplaceExcel:ke,uploadStatus:e=>{X.value=e}}),(e,t)=>{const s=Oe,a=qe,n=Ue,c=Ie,p=Re,d=ze,B=Me,F=Ne,u=Be,x=Ve,Se=je,be=tt("loading");return f(),R("div",rt,[q("div",ct,[at((f(),T(p,{ref_key:"excelForm",ref:re,"require-asterisk-position":"right",model:o(_),"label-position":"top"},{default:m(()=>[z.value.name?(f(),T(n,{prop:"id",label:o(l)("data_source.document"),key:"sheetFile",rules:[{required:!0}]},{default:m(()=>[r(Je,{onDel:ye,"show-del":"",name:z.value.name,size:z.value.size},null,8,["name","size"]),r(a,{action:"",multiple:!1,ref_key:"uploadAgain",ref:ne,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":W,"on-change":le,"http-request":ie,"on-error":ee,name:"file"},{trigger:m(()=>[r(s,{text:""},{default:m(()=>[O(w(o(l)("data_source.reupload")),1)]),_:1})]),_:1},512)]),_:1},8,["label"])):(f(),T(n,{prop:"id",key:"sheetId",label:o(l)("data_source.document"),rules:[{required:!0}]},{default:m(()=>[r(a,{multiple:!1,action:"",ref_key:"upload",ref:oe,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":W,"on-change":le,"http-request":ie,"on-error":ee,name:"file"},{trigger:m(()=>[r(s,{secondary:""},{icon:m(()=>[r(o(Y),{name:"icon_upload_outlined"},{default:m(()=>[r(o(Ae),{class:"svg-icon"})]),_:1})]),default:m(()=>[O(" "+w(o(l)("dataset.upload_file")),1)]),_:1})]),_:1},512),q("p",dt,w(o(l)("data_source.and_csv_formats")),1),X.value?(f(),R("div",ut,w(o(l)("data_source.please_upload_files")),1)):j("",!0)]),_:1},8,["label"])),ce.value?(f(),T(n,{class:A(X.value&&!z.value.name&&"error-status"),prop:"name",key:"name",rules:[{required:!0,message:o(l)("common.please_input")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")}],label:o(l)("visualization.custom")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")},{default:m(()=>[r(c,{modelValue:o(_).name,"onUpdate:modelValue":t[0]||(t[0]=i=>o(_).name=i),placeholder:o(l)("common.please_input")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")},null,8,["modelValue","placeholder"])]),_:1},8,["class","rules","label"])):j("",!0)]),_:1},8,["model"])),[[be,E.value]]),k.value?(f(),R(lt,{key:0},[q("div",mt,w(o(l)("chart.data_preview")),1),r(Ye,{activeTab:k.value,onTabClick:C,"tab-list":K.value},null,8,["activeTab","tab-list"]),o(_).editType===0?(f(),R("div",pt,[q("div",ft,[r(s,{onClick:t[1]||(t[1]=i=>de("preview")),class:A([U.value==="preview"&&"is-active"]),text:""},{default:m(()=>[O(w(o(l)("chart.data_preview")),1)]),_:1},8,["class"]),r(s,{onClick:t[2]||(t[2]=i=>de("select")),class:A([U.value==="select"&&"is-active"]),text:""},{default:m(()=>[O(w(o(l)("data_set.field_selection")),1)]),_:1},8,["class"])])])):j("",!0),P.value?(f(),R("div",{key:1,class:A(["info-table",o(_).editType===0&&"info-table_height"])},[U.value==="preview"?(f(),T(B,{key:0},{default:m(({height:i,width:N})=>[r(d,{columns:y.value,"header-class":"excel-header-cell",data:b.jsonArray,width:N,height:i,fixed:""},null,8,["columns","data","width","height"])]),_:1})):(f(),T(Se,{key:1,"header-class":"header-cell",ref_key:"multipleTable",ref:$,data:D.value,style:{width:"100%"},onSelectionChange:De},{default:m(()=>[r(F,{type:"selection",width:"55"}),r(F,{label:o(l)("data_set.field_name")},{default:m(i=>[O(w(i.row.title),1)]),_:1},8,["label"]),r(F,{label:o(l)("data_set.field_type")},{default:m(i=>[q("div",ht,[r(o(ue),null,{default:m(()=>[r(o(Y),null,{default:m(()=>[(f(),T(st(o(pe)[M[i.row.fieldType]]),{class:A(`svg-icon field-icon-${M[i.row.fieldType]}`)},null,8,["class"]))]),_:2},1024)]),_:2},1024),O(" "+w(o(l)(`dataset.${M[i.row.fieldType]}`)),1)])]),_:1},8,["label"]),o(_).editType===0?(f(),T(F,{key:0,prop:"length",label:o(l)("datasource.length")},{default:m(i=>[r(u,{disabled:Fe(i.row),modelValue:i.row.length,"onUpdate:modelValue":N=>i.row.length=N,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:o(l)("common.inputText"),"controls-position":"right",type:"number",onChange:N=>Te(i.row)},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder","onChange"])]),_:1},8,["label"])):j("",!0),o(_).editType===0&&o(_e)?(f(),T(F,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:o(l)("datasource.set_key"),width:"100"},{default:m(i=>[(f(),T(x,{key:i.row.dataKey,modelValue:i.row.primaryKey,"onUpdate:modelValue":N=>i.row.primaryKey=N,disabled:!i.row.checked,onChange:N=>we(i.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"])):j("",!0)]),_:1},8,["data"]))],2)):j("",!0)],64)):j("",!0)])])}}});export{At as _};
