import{d as ue,p as b,q as me,h as Ke,K as Ne,w as Ve,r as je,v as Be,U as Oe,S as ze,V as Le,A as Ie,z as Me,T as Ue}from"./element-plus-secondary-0.0.0-dataease.js";import{i as qe}from"./icon_upload_outlined-0.0.0-dataease.js";import{j as Ae,h as W}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{e as Re,b as $e,u as Pe}from"./datasource-0.0.0-dataease.js";import{g as Xe}from"./js-base64-0.0.0-dataease.js";import Ge from"./ExcelInfo-0.0.0-dataease.js";import Je from"./SheetTabs-0.0.0-dataease.js";import{u as We}from"./index-0.0.0-dataease.js";import{i as pe}from"./field-list-0.0.0-dataease.js";import{e as O,d as Ye}from"./lodash-es-0.0.0-dataease.js";import{d as Ze,l as Y,t as He,r as v,x as Z,k as Qe,n as fe,b as Ce,e as et,ak as tt,o as f,c as q,a as A,W as at,Z as T,_ as m,u as o,a0 as r,a4 as z,a2 as w,Y as V,z as R,M as lt,$ as st,h as ot,s as nt}from"./@vue-0.0.0-dataease.js";import{b as it}from"./mathjs-0.0.0-dataease.js";const rt={class:"excel-detail"},ct={class:"detail-inner"},dt={class:"upload-tip",style:{width:"100%"}},ut={key:0,class:"ed-form-item__error"},mt={class:"title-form_primary"},pt={key:0,class:"table-select_mode"},ft={class:"btn-select"},ht={class:"flex-align-center"};function _t(L){return typeof L=="function"||Object.prototype.toString.call(L)==="[object Object]"&&!nt(L)}const Nt=Ze({__name:"ExcelDetail",props:{param:{required:!1,default(){return Y({id:"0",name:"",desc:"",type:"Excel",editType:0})},type:Object},isSupportSetKey:{type:it,required:!0}},setup(L,{expose:he}){const g=L,{param:_,isSupportSetKey:_e}=He(g),{t:l}=Ae(),{emitter:P}=We(),k=v(!1),D=Z([]),y=Z([]),$=v(),j={tableName:" ",sheetExcelId:"",fields:[],jsonArray:[],nameExist:!1,empty:"",overLength:!1},F=Y(O(j)),h=Y({excelData:[],defaultExpandedKeys:[],defaultCheckedKeys:[],fileList:null,sheets:[]}),I=Qe(()=>{const[e={}]=h.excelData;return{name:e.excelLabel,size:e.excelLabel}}),H=v(!1),M={TEXT:"text",DATETIME:"time",LONG:"value",DOUBLE:"value"},ve=e=>e.map(t=>({key:t.originName,fieldType:t.fieldType,dataKey:t.originName,title:t.name,checked:t.checked,primaryKey:t.primaryKey,length:t.length,width:150,headerCellRenderer:({column:s})=>{let a;return r("div",{class:"flex-align-center icon"},[r(ue,null,{default:()=>[r(W,null,_t(a=ot(pe[M[s.fieldType]],{class:`svg-icon field-icon-${M[s.fieldType]}`}))?a:{default:()=>[a]})]}),r("span",{class:"ellipsis",title:s.title,style:{width:"100px"}},[s.title])])}})),ge=e=>{e.sheet&&(Object.assign(F,e),D.value=ve(e.fields),y.value=D.value.filter(t=>t.checked),U.value="preview")},Q=()=>{H.value=!0},C=e=>{var s;E.value=e.value;const t=(s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===e.value);ge(t)},ee=e=>{h.excelData=[],E.value="",K.value=[],Object.assign(F,O(j)),e.toString().replace("Error: ","")},K=Z([]),E=v(""),ye=()=>{h.excelData=[],E.value="",K.value=[],Object.assign(F,O(j))},te=e=>{if(!e)return;if((e==null?void 0:e.code)!==0){h.excelData=[],E.value="",K.value=[],Object.assign(F,O(j)),b.warning(e.msg);return}D.value=[],Object.assign(F,O(j)),y.value=[],H.value=!1,_.value.name||(_.value.name=e.data.excelLabel),K.value=e.data.sheets.map(s=>{const{sheetId:a,tableName:n,newSheet:c}=s;return{value:a,label:n,newSheet:c}}),h.excelData=[e.data];const[t]=K.value;t&&C(t)},xe=(e,t,s)=>{var S;let a=[],n=[],c=!1,p=!1,d=(S=h.excelData[0])==null?void 0:S.sheets;for(let u=0;u<d.length;u++)if(d[u].sheet){if(d[u].effectExtField&&(c=!0),d[u].changeFiled&&(p=!0),d[u].fields.filter(x=>x.checked).length==0){b({message:d[u].excelLabel+l("datasource.api_field_not_empty"),type:"error"}),s==null||s();return}for(let x=0;x<d[u].fields.length;x++)if(d[u].fields[x].checked&&d[u].fields[x].primaryKey&&!d[u].fields[x].length&&d[u].fields[x].deExtractType===0){b({message:l("datasource.primary_key_length")+d[u].excelLabel+": "+d[u].fields[x].name,type:"error"}),s==null||s();return}a.push(d[u]),n.push(d[u].fieldsMd5)}if(!a.length){b({message:l("dataset.ple_select_excel"),type:"error"}),s==null||s();return}let B={};e&&(_.value.name=e.name),g.param.id?B={id:g.param.id,name:g.param.name,type:"Excel",sheets:a,editType:g.param.editType?g.param.editType:0}:B={id:g.param.id,name:g.param.name,type:"Excel",sheets:a,editType:0},g.param.editType===0&&g.param.id&&(c||p)?me.confirm(l("deDataset.replace_the_data"),{confirmButtonText:l("dataset.confirm"),tip:l("data_source.to_replace_it"),cancelButtonText:"Cancel",confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1,callback:u=>{u==="confirm"&&ae(n,B,e,t,s)}}):ae(n,B,e,t,s)},ae=(e,t,s,a,n)=>{for(let p=0;p<t.sheets.length;p++)t.sheets[p].data=[],t.sheets[p].jsonArray=[];t.configuration=Xe.encode(JSON.stringify(t.sheets));let c=$e;if(!t.id||t.id==="0"?(delete t.id,t.pid=s.pid):c=Pe,new Set(e).size!==e.length&&!g.param.id)me.confirm(l("dataset.merge_title"),{confirmButtonText:l("dataset.merge"),tip:l("dataset.task.excel_replace_msg"),cancelButtonText:l("dataset.no_merge"),confirmButtonType:"primary",type:"warning",autofocus:!1,callback:p=>{p!=="close"&&(k.value=!0,t.mergeSheet=p==="confirm",p==="confirm"&&c(t).then(d=>{P.emit("showFinishPage",d),a==null||a(),b({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),k.value=!1}),p==="cancel"&&c(t).then(d=>{P.emit("showFinishPage",d),a==null||a(),b({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),k.value=!1}))}});else{if(k.value)return;k.value=!0,c(t).then(p=>{P.emit("showFinishPage",p),a==null||a(),b({message:l("commons.save_success"),type:"success"})}).finally(()=>{n==null||n(),k.value=!1})}},le=e=>{h.fileList=e},X=v(!0),se=Ye(()=>{X.value=!1,fe(()=>{X.value=!0})},500);Ce(()=>{window.addEventListener("resize",se)}),et(()=>{window.removeEventListener("resize",se)});const oe=v(),ne=v(),ie=()=>{const e=new FormData;return e.append("file",h.fileList.raw),e.append("type",""),e.append("editType",_.value.editType),e.append("id",_.value.id||0),k.value=!0,Re(e).then(t=>{var s,a;(s=oe.value)==null||s.clearFiles(),(a=ne.value)==null||a.clearFiles(),te(t),k.value=!1}).catch(t=>{h.excelData=[],E.value="",K.value=[],Object.assign(F,O(j)),t.code==="ECONNABORTED"&&b({type:"error",message:t.message,showClose:!0}),k.value=!1})},re=v(),ke=()=>re.value.validate,ce=v(!0),Ee=e=>{ce.value=!1,te(e)},G=v(!1),J=v(!1),U=v("preview"),Te=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===E.value)).fields.forEach(a=>{a.originName===e.dataKey&&(a.length=e.length)})},we=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(a=>a.sheetId===E.value)).fields.forEach(a=>{a.originName===e.dataKey&&(a.primaryKey=e.primaryKey)})},De=e=>{var t;J.value||(y.value=e,y.value.forEach(a=>{a.checked=!0}),D.value.forEach(a=>{let n;for(let c=0;c<y.value.length;c++)a.dataKey===y.value[c].dataKey&&(n=y.value[c]);n?a.checked=n.checked:a.checked=!1}),((t=h.excelData[0])==null?void 0:t.sheets.find(a=>a.sheetId===E.value)).fields.forEach(a=>{let n;for(let c=0;c<y.value.length;c++)a.originName===y.value[c].dataKey&&(n=y.value[c]);n?a.checked=n.checked:a.checked=!1}))},Se=e=>{if(!e.checked||e.fieldType!=="TEXT")return!0},de=e=>{U.value=e,e==="select"&&fe(()=>{var t;J.value=!0;for(let s=0;s<D.value.length;s++)D.value[s].checked&&((t=$==null?void 0:$.value)==null||t.toggleRowSelection(D.value[s],!0));J.value=!1})};return he({saveExcelDs:xe,submitForm:ke,sheetFile:I,appendReplaceExcel:Ee,uploadStatus:e=>{G.value=e}}),(e,t)=>{const s=Ke,a=Ne,n=Ve,c=je,p=Be,d=Oe,B=ze,S=Le,u=Ie,x=Me,be=Ue,Fe=tt("loading");return f(),q("div",rt,[A("div",ct,[at((f(),T(p,{ref_key:"excelForm",ref:re,"require-asterisk-position":"right",model:o(_),"label-position":"top"},{default:m(()=>[I.value.name?(f(),T(n,{prop:"id",label:o(l)("data_source.document"),key:"sheetFile",rules:[{required:!0}]},{default:m(()=>[r(Ge,{onDel:ye,"show-del":"",name:I.value.name,size:I.value.size},null,8,["name","size"]),r(a,{action:"",multiple:!1,ref_key:"uploadAgain",ref:ne,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":Q,"on-change":le,"http-request":ie,"on-error":ee,name:"file"},{trigger:m(()=>[r(s,{text:""},{default:m(()=>[z(w(o(l)("data_source.reupload")),1)]),_:1})]),_:1},512)]),_:1},8,["label"])):(f(),T(n,{prop:"id",key:"sheetId",label:o(l)("data_source.document"),rules:[{required:!0}]},{default:m(()=>[r(a,{multiple:!1,action:"",ref_key:"upload",ref:oe,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":Q,"on-change":le,"http-request":ie,"on-error":ee,name:"file"},{trigger:m(()=>[r(s,{secondary:""},{icon:m(()=>[r(o(W),{name:"icon_upload_outlined"},{default:m(()=>[r(o(qe),{class:"svg-icon"})]),_:1})]),default:m(()=>[z(" "+w(o(l)("dataset.upload_file")),1)]),_:1})]),_:1},512),A("p",dt,w(o(l)("data_source.and_csv_formats")),1),G.value?(f(),q("div",ut,w(o(l)("data_source.please_upload_files")),1)):V("",!0)]),_:1},8,["label"])),ce.value?(f(),T(n,{class:R(G.value&&!I.value.name&&"error-status"),prop:"name",key:"name",rules:[{required:!0,message:o(l)("common.please_input")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")}],label:o(l)("visualization.custom")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")},{default:m(()=>[r(c,{modelValue:o(_).name,"onUpdate:modelValue":t[0]||(t[0]=i=>o(_).name=i),placeholder:o(l)("common.please_input")+o(l)("common.empty")+o(l)("datasource.datasource")+o(l)("common.empty")+o(l)("common.name")},null,8,["modelValue","placeholder"])]),_:1},8,["class","rules","label"])):V("",!0)]),_:1},8,["model"])),[[Fe,k.value]]),E.value?(f(),q(lt,{key:0},[A("div",mt,w(o(l)("chart.data_preview")),1),r(Je,{activeTab:E.value,onTabClick:C,"tab-list":K.value},null,8,["activeTab","tab-list"]),o(_).editType===0?(f(),q("div",pt,[A("div",ft,[r(s,{onClick:t[1]||(t[1]=i=>de("preview")),class:R([U.value==="preview"&&"is-active"]),text:""},{default:m(()=>[z(w(o(l)("chart.data_preview")),1)]),_:1},8,["class"]),r(s,{onClick:t[2]||(t[2]=i=>de("select")),class:R([U.value==="select"&&"is-active"]),text:""},{default:m(()=>[z(w(o(l)("data_set.field_selection")),1)]),_:1},8,["class"])])])):V("",!0),X.value?(f(),q("div",{key:1,class:R(["info-table",o(_).editType===0&&"info-table_height"])},[U.value==="preview"?(f(),T(B,{key:0},{default:m(({height:i,width:N})=>[r(d,{columns:y.value,"header-class":"excel-header-cell",data:F.jsonArray,width:N,height:i,fixed:""},null,8,["columns","data","width","height"])]),_:1})):(f(),T(be,{key:1,"header-class":"header-cell",ref_key:"multipleTable",ref:$,data:D.value,style:{width:"100%"},onSelectionChange:De},{default:m(()=>[r(S,{type:"selection",width:"55"}),r(S,{label:o(l)("data_set.field_name")},{default:m(i=>[z(w(i.row.title),1)]),_:1},8,["label"]),r(S,{label:o(l)("data_set.field_type")},{default:m(i=>[A("div",ht,[r(o(ue),null,{default:m(()=>[r(o(W),null,{default:m(()=>[(f(),T(st(o(pe)[M[i.row.fieldType]]),{class:R(`svg-icon field-icon-${M[i.row.fieldType]}`)},null,8,["class"]))]),_:2},1024)]),_:2},1024),z(" "+w(o(l)(`dataset.${M[i.row.fieldType]}`)),1)])]),_:1},8,["label"]),o(_).editType===0?(f(),T(S,{key:0,prop:"length",label:o(l)("datasource.length")},{default:m(i=>[r(u,{disabled:Se(i.row),modelValue:i.row.length,"onUpdate:modelValue":N=>i.row.length=N,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:o(l)("common.inputText"),"controls-position":"right",type:"number",onChange:N=>Te(i.row)},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder","onChange"])]),_:1},8,["label"])):V("",!0),o(_).editType===0&&o(_e)?(f(),T(S,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:o(l)("datasource.set_key"),width:"100"},{default:m(i=>[(f(),T(x,{key:i.row.dataKey,modelValue:i.row.primaryKey,"onUpdate:modelValue":N=>i.row.primaryKey=N,disabled:!i.row.checked,onChange:N=>we(i.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"])):V("",!0)]),_:1},8,["data"]))],2)):V("",!0)],64)):V("",!0)])])}}});export{Nt as _};
