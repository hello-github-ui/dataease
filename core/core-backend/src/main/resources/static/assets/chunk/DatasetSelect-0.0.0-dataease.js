import{w as ze,d as xe,r as Be,v as Fe,h as Oe,k as Pe,t as We,a as Ae,m as Me,a6 as je,n as He,f as Ue}from"./element-plus-secondary-0.0.0-dataease.js";import{a as Le,j as Re,h as Ke}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{d as Xe,r as l,k as s,w as Ye,b as Ze,ah as q,ak as $e,o as n,c as B,a0 as a,_ as o,u as i,W as F,X as G,z as v,Z as h,Y as p,a as w,a2 as S,a4 as O}from"./@vue-0.0.0-dataease.js";import{d as qe}from"./dv-folder-0.0.0-dataease.js";import{i as Ge}from"./icon_dataset-0.0.0-dataease.js";import{i as Je}from"./icon_done_outlined-0.0.0-dataease.js";import{K as Qe,p as et}from"./@element-plus-0.0.0-dataease.js";import{useAppStoreWithOut as tt}from"./app-0.0.0-dataease.js";import{_ as b}from"./lodash-0.0.0-dataease.js";import{l as ot,g as at}from"./dataset-0.0.0-dataease.js";import{a as rt,u as J}from"./index-0.0.0-dataease.js";import{d as st}from"./dvMain-0.0.0-dataease.js";import{t as it}from"./treeSortUtils-0.0.0-dataease.js";import{_ as lt}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./@vueuse-0.0.0-dataease.js";import"./lodash-es-0.0.0-dataease.js";import"./dayjs-0.0.0-dataease.js";import"./@amap-0.0.0-dataease.js";import"./async-validator-0.0.0-dataease.js";import"./@ctrl-0.0.0-dataease.js";import"./@popperjs-0.0.0-dataease.js";import"./escape-html-0.0.0-dataease.js";import"./normalize-wheel-es-0.0.0-dataease.js";import"./memoize-one-0.0.0-dataease.js";import"./pinia-0.0.0-dataease.js";import"./vue-demi-0.0.0-dataease.js";import"./jspdf-0.0.0-dataease.js";import"./@babel-0.0.0-dataease.js";import"./fflate-0.0.0-dataease.js";import"./vue-i18n-0.0.0-dataease.js";import"./@intlify-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./qs-0.0.0-dataease.js";import"./side-channel-0.0.0-dataease.js";import"./es-errors-0.0.0-dataease.js";import"./object-inspect-0.0.0-dataease.js";import"./crypto-js-0.0.0-dataease.js";import"./side-channel-list-0.0.0-dataease.js";import"./side-channel-map-0.0.0-dataease.js";import"./get-intrinsic-0.0.0-dataease.js";import"./es-object-atoms-0.0.0-dataease.js";import"./math-intrinsics-0.0.0-dataease.js";import"./gopd-0.0.0-dataease.js";import"./es-define-property-0.0.0-dataease.js";import"./has-symbols-0.0.0-dataease.js";import"./get-proto-0.0.0-dataease.js";import"./dunder-proto-0.0.0-dataease.js";import"./call-bind-apply-helpers-0.0.0-dataease.js";import"./function-bind-0.0.0-dataease.js";import"./hasown-0.0.0-dataease.js";import"./call-bound-0.0.0-dataease.js";import"./side-channel-weakmap-0.0.0-dataease.js";import"./vue-router-0.0.0-dataease.js";import"./vue-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./zrender-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./mitt-0.0.0-dataease.js";import"./vue-types-0.0.0-dataease.js";import"./is-plain-object-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./snowflake-id-0.0.0-dataease.js";import"./index-0.0.0-dataease12.js";import"./util-0.0.0-dataease2.js";import"./chart-0.0.0-dataease2.js";import"./@antv-0.0.0-dataease.js";import"./eventemitter3-0.0.0-dataease.js";import"./@mapbox-0.0.0-dataease.js";import"./pbf-0.0.0-dataease.js";import"./ieee754-0.0.0-dataease.js";import"./supercluster-0.0.0-dataease.js";import"./gl-matrix-0.0.0-dataease.js";import"./tslib-0.0.0-dataease.js";import"./topojson-client-0.0.0-dataease.js";import"./viewport-mercator-project-0.0.0-dataease.js";import"./@turf-0.0.0-dataease.js";import"./polygon-clipping-0.0.0-dataease.js";import"./splaytree-0.0.0-dataease.js";import"./robust-predicates-0.0.0-dataease.js";import"./d3-scale-0.0.0-dataease.js";import"./d3-collection-0.0.0-dataease.js";import"./d3-format-0.0.0-dataease.js";import"./d3-time-format-0.0.0-dataease.js";import"./d3-time-0.0.0-dataease.js";import"./d3-color-0.0.0-dataease.js";import"./d3-array-0.0.0-dataease.js";import"./earcut-0.0.0-dataease.js";import"./regl-0.0.0-dataease.js";import"./mapbox-gl-0.0.0-dataease.js";import"./d3-dsv-0.0.0-dataease.js";import"./geojson-vt-0.0.0-dataease.js";import"./hammerjs-0.0.0-dataease.js";import"./element-resize-detector-0.0.0-dataease.js";import"./batch-processor-0.0.0-dataease.js";import"./d3-hexbin-0.0.0-dataease.js";import"./detect-browser-0.0.0-dataease.js";import"./d3-ease-0.0.0-dataease.js";import"./d3-interpolate-0.0.0-dataease.js";import"./d3-timer-0.0.0-dataease.js";import"./fecha-0.0.0-dataease.js";import"./size-sensor-0.0.0-dataease.js";import"./d3-regression-0.0.0-dataease.js";import"./d3-hierarchy-0.0.0-dataease.js";import"./fmin-0.0.0-dataease.js";import"./pdfast-0.0.0-dataease.js";import"./mathjs-0.0.0-dataease.js";import"./decimal.js-0.0.0-dataease.js";import"./typed-function-0.0.0-dataease.js";import"./complex.js-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./exceljs-0.0.0-dataease.js";import"./file-saver-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./less-0.0.0-dataease.js";import"./copy-anything-0.0.0-dataease.js";import"./is-what-0.0.0-dataease.js";const nt={key:0,class:"m-loading"},mt={key:1,class:"empty-info"},ct=["title"],pt={class:"m-icon"},ut={class:"footer-container"},dt=Xe({__name:"DatasetSelect",props:{themes:{default:"dark"},modelValue:{},stateObj:{},disabled:{type:Boolean,default:!1},viewId:{},sourceType:{default:"dataset"}},emits:["update:modelValue","update:stateObj","onDatasetChange","addDsWindow"],setup(Q,{expose:ee,emit:te}){const P=st(),{wsCache:D}=rt("localStorage"),W=Le(),{t:m}=Re(),c=Q,g=l(null),u=l(!1),y=l(!0),d=l([]),oe=c.sourceType==="datasource"?m("visualization.select_datasource"):m("visualization.select_dataset"),ae=c.sourceType==="datasource"?m("visualization.new_datasource"):m("visualization.new_dataset"),T=s(()=>c.sourceType==="datasource"?m("datasource.datasource"):m("visualization.dataset")),re=e=>{const t=D.get("TreeSort-dataset")||"time_desc";d.value=it(e,t)},A=()=>{u.value=!0;const e=c.sourceType==="datasource"?ot:at,t=c.sourceType==="datasource"?null:{};e(t).then(r=>{re(r||[])}).finally(()=>{var r;u.value=!1,(r=M.value)==null||r.validate()})},E=te,f=s({get(){return c.modelValue},set(e){E("update:modelValue",e)}}),se={label:"name",children:"children",value:"id",isLeaf:e=>{var t;return!((t=e.children)!=null&&t.length)}},M=l(),V=l();Ye(V,e=>{g.value.filter(e)});const N=s(()=>d.value&&d.value.length>0&&!u.value&&y.value),ie=s(()=>y.value?"暂无"+T.value:"已切换至新组织，无权访问其他组织的资源"),le=s(()=>!N.value&&!u.value&&!y.value),j=s(()=>N.value&&d.value[0].id==="0"?d.value[0].children:d.value),ne=s(()=>b.filter(L(j.value),e=>e.leaf)),H=s(()=>b.find(ne.value,e=>e.id===f.value)),U=s(()=>!(f.value&&H.value===void 0)),I=s(()=>{var e;return U.value?(e=H.value)==null?void 0:e.name:T.value+"不存在"}),me=s(()=>({name:I.value})),ce=l([{validator:(...e)=>{U.value?e[2]():e[2](new Error)},trigger:["change","blur"]}]);function L(e){let t=b.cloneDeep(e);return b.forEach(e,r=>{r.children&&r.children.length>0&&(t=b.union(t,L(r.children)))}),t}const pe=e=>{E("onDatasetChange",e)},ue=(e,t)=>{var r;return e?(r=t.name)==null?void 0:r.includes(e):!0},R=()=>{A()},de=()=>{E("addDsWindow")},K=l(),X=e=>{var t;e.leaf&&(f.value!==e.id&&pe(e.id),f.value=e.id,(t=K.value)==null||t.hide())},z=l(!1);function fe(){z.value=!0}function _e(){z.value=!1}function ve(e){var t;return(t=g==null?void 0:g.value)==null?void 0:t.getNode(e)}const he=s(()=>c.sourceType==="dataset"&&P.curComponent&&["rich-text","picture-group"].includes(P.curComponent.innerType)),ge=e=>{e.preventDefault(),e.stopPropagation(),X({leaf:!0,id:null}),J().emitter.emit("clear-remove",["xAxis","yAxis","drillFields"])},ye=()=>{c.sourceType==="dataset"&&W.getOid&&D.get("user.oid")&&W.getOid!==D.get("user.oid")?y.value=!1:y.value=!0};ee({getNode:ve});const Y=tt(),ke=s(()=>Y.getIsDataEaseBi||Y.getIsIframe);return Ze(()=>{A(),J({name:"refresh-dataset-selector",callback:()=>R()})}),(e,t)=>{const r=q("ArrowDown"),k=xe,we=q("CircleClose"),Z=Be,Se=Fe,$=Oe,be=Pe,x=Ke,Ce=We,De=Ae,Te=Me,Ee=je,Ve=He,Ne=Ue,Ie=$e("loading");return n(),B("div",null,[a(Ne,{ref_key:"datasetSelectorPopover",ref:K,trigger:"click",placement:"bottom-start",width:320,"popper-class":"customDatasetSelect","show-arrow":!1,onShow:fe,onHide:_e,disabled:e.disabled,effect:e.themes,offset:4},{reference:o(()=>[a(Se,{ref_key:"formRef",ref:M,model:me.value},{default:o(()=>[a(i(ze),{prop:"name",rules:ce.value},{default:o(()=>[a(Z,{size:"middle",effect:e.themes,modelValue:I.value,"onUpdate:modelValue":t[0]||(t[0]=_=>I.value=_),class:"data-set-dark",onFocus:ye,disabled:e.disabled,placeholder:i(oe)},{suffix:o(()=>[F(a(k,{class:v(["input-arrow-icon",{reverse:z.value}])},{default:o(()=>[a(r)]),_:1},8,["class"]),[[G,!e.disabled]]),he.value?F((n(),h(k,{key:0,class:"input-custom-clear-icon",onClick:ge},{default:o(()=>[a(we)]),_:1},512)),[[G,!e.disabled]]):p("",!0)]),_:1},8,["effect","modelValue","disabled","placeholder"])]),_:1},8,["rules"])]),_:1},8,["model"])]),default:o(()=>[a(Ve,{class:v(e.themes)},{default:o(()=>[a(be,null,{default:o(()=>[w("div",{class:v(["m-title",{dark:e.themes==="dark"}])},[w("div",null,S(T.value),1),a($,{type:"primary",link:"",class:"refresh-btn",onClick:R},{default:o(()=>[O(S(i(m)("commons.refresh")),1)]),_:1})],2),a(Z,{size:"middle",effect:e.themes,modelValue:V.value,"onUpdate:modelValue":t[1]||(t[1]=_=>V.value=_),placeholder:i(m)("dataset.search"),"prefix-icon":i(Qe),clearable:""},null,8,["effect","modelValue","placeholder","prefix-icon"])]),_:1}),a(Te,{class:v({dark:e.themes==="dark"})},{default:o(()=>[a(De,{"max-height":"252px",always:""},{default:o(()=>[u.value?F((n(),B("div",nt,null,512)),[[Ie,u.value]]):p("",!0),le.value?(n(),B("div",mt,S(ie.value),1)):p("",!0),N.value?(n(),h(Ce,{key:2,class:v({dark:e.themes==="dark"}),ref_key:"datasetSelector",ref:g,"node-key":"id",data:j.value,teleported:!1,props:se,"render-after-expand":!1,filterable:"",onNodeClick:X,"filter-node-method":ue,"empty-text":"暂无相关数据"},{default:o(({node:_,data:C})=>[w("div",{class:v(["tree-row-item",{dark:e.themes==="dark",active:f.value===C.id}]),title:_.label},[w("div",pt,[C.leaf?p("",!0):(n(),h(k,{key:0},{default:o(()=>[a(x,{name:"dv-folder"},{default:o(()=>[a(i(qe),{class:"svg-icon"})]),_:1})]),_:1})),C.leaf?(n(),h(k,{key:1},{default:o(()=>[a(x,{name:"icon_dataset"},{default:o(()=>[a(i(Ge),{class:"svg-icon"})]),_:1})]),_:1})):p("",!0)]),O(" "+S(_.label)+" ",1),f.value===C.id?(n(),h(k,{key:0,class:"checked-item"},{default:o(()=>[a(x,{name:"icon_done_outlined"},{default:o(()=>[a(i(Je),{class:"svg-icon"})]),_:1})]),_:1})):p("",!0)],10,ct)]),_:1},8,["class","data"])):p("",!0)]),_:1})]),_:1},8,["class"]),ke.value?p("",!0):(n(),h(Ee,{key:0},{default:o(()=>[w("div",ut,[a($,{type:"primary",icon:i(et),link:"",class:"add-btn",onClick:de},{default:o(()=>[O(S(i(ae)),1)]),_:1},8,["icon"])])]),_:1}))]),_:1},8,["class"])]),_:1},8,["disabled","effect"])])}}});const Na=lt(dt,[["__scopeId","data-v-468828d8"]]);export{Na as default};
