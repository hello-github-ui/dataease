import{a as xe,u as Q,aA as ze,ad as Be,M as Fe}from"./index-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as Me}from"./el-popover-0.0.0-dataease.js";import"./el-footer-0.0.0-dataease.js";import"./el-aside-0.0.0-dataease.js";import"./el-main-0.0.0-dataease.js";import{E as Oe}from"./el-tree-0.0.0-dataease.js";import"./el-checkbox-0.0.0-dataease.js";import{a as Pe,o as Ae,j as We,G as je,y as Ue,n as He}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{d as Le,r as n,G as r,w as Ge,o as Re,e as X,aa as $e,f as i,L as B,k as o,i as a,j as l,T as F,W as Y,U as v,g as h,a0 as d,M as w,a6 as S,a5 as M}from"./vue-0.0.0-dataease.js";import{d as qe}from"./dv-folder-0.0.0-dataease.js";import{i as Je}from"./icon_dataset-0.0.0-dataease.js";import{i as Ke}from"./icon_done_outlined-0.0.0-dataease.js";import{useAppStoreWithOut as Qe}from"./app-0.0.0-dataease.js";import{_ as b}from"./lodash-0.0.0-dataease.js";import{l as Xe,g as Ye}from"./dataset-0.0.0-dataease.js";import{a as Ze,E as et}from"./el-form-item-0.0.0-dataease.js";import{d as tt}from"./dvMain-0.0.0-dataease.js";import{t as at}from"./treeSortUtils-0.0.0-dataease.js";import{E as ot,b as st,d as rt,c as lt}from"./index-0.0.0-dataease14.js";import{_ as nt}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./index-0.0.0-dataease3.js";import"./dropdown-0.0.0-dataease.js";import"./index-0.0.0-dataease13.js";import"./library-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./formatter-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./index-0.0.0-dataease19.js";import"./util-0.0.0-dataease2.js";import"./chart-0.0.0-dataease2.js";import"./antv-0.0.0-dataease.js";import"./index-0.0.0-dataease20.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./row-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";const it={key:0,class:"m-loading"},ct={key:1,class:"empty-info"},ut=["title"],dt={class:"m-icon"},mt={class:"footer-container"},pt=Le({__name:"DatasetSelect",props:{themes:{default:"dark"},modelValue:{},stateObj:{},disabled:{type:Boolean,default:!1},viewId:{},sourceType:{default:"dataset"}},emits:["update:modelValue","update:stateObj","onDatasetChange","addDsWindow"],setup(Z,{expose:ee,emit:te}){const O=tt(),{wsCache:D}=xe("localStorage"),P=Pe(),{t:c}=Ae(),u=Z,g=n(null),m=n(!1),y=n(!0),p=n([]),ae=u.sourceType==="datasource"?c("visualization.select_datasource"):c("visualization.select_dataset"),oe=u.sourceType==="datasource"?c("visualization.new_datasource"):c("visualization.new_dataset"),E=r(()=>u.sourceType==="datasource"?c("datasource.datasource"):c("visualization.dataset")),se=e=>{const t=D.get("TreeSort-dataset")||"time_desc";p.value=at(e,t)},A=()=>{m.value=!0;const e=u.sourceType==="datasource"?Xe:Ye,t=u.sourceType==="datasource"?null:{};e(t).then(s=>{se(s||[])}).finally(()=>{var s;m.value=!1,(s=W.value)==null||s.validate()})},T=te,f=r({get(){return u.modelValue},set(e){T("update:modelValue",e)}}),re={label:"name",children:"children",value:"id",isLeaf:e=>{var t;return!((t=e.children)!=null&&t.length)}},W=n(),V=n();Ge(V,e=>{g.value.filter(e)});const N=r(()=>p.value&&p.value.length>0&&!m.value&&y.value),le=r(()=>y.value?"暂无"+E.value:"已切换至新组织，无权访问其他组织的资源"),ne=r(()=>!N.value&&!m.value&&!y.value),j=r(()=>N.value&&p.value[0].id==="0"?p.value[0].children:p.value),ie=r(()=>b.filter(L(j.value),e=>e.leaf)),U=r(()=>b.find(ie.value,e=>e.id===f.value)),H=r(()=>!(f.value&&U.value===void 0)),I=r(()=>{var e;return H.value?(e=U.value)==null?void 0:e.name:E.value+"不存在"}),ce=r(()=>({name:I.value})),ue=n([{validator:(...e)=>{H.value?e[2]():e[2](new Error)},trigger:["change","blur"]}]);function L(e){let t=b.cloneDeep(e);return b.forEach(e,s=>{s.children&&s.children.length>0&&(t=b.union(t,L(s.children)))}),t}const de=e=>{T("onDatasetChange",e)},me=(e,t)=>{var s;return e?(s=t.name)==null?void 0:s.includes(e):!0},G=()=>{A()},pe=()=>{T("addDsWindow")},R=n(),$=e=>{var t;e.leaf&&(f.value!==e.id&&de(e.id),f.value=e.id,(t=R.value)==null||t.hide())},x=n(!1);function fe(){x.value=!0}function _e(){x.value=!1}function ve(e){var t;return(t=g==null?void 0:g.value)==null?void 0:t.getNode(e)}const he=r(()=>u.sourceType==="dataset"&&O.curComponent&&["rich-text","picture-group"].includes(O.curComponent.innerType)),ge=e=>{e.preventDefault(),e.stopPropagation(),$({leaf:!0,id:null}),Q().emitter.emit("clear-remove",["xAxis","yAxis","drillFields"])},ye=()=>{u.sourceType==="dataset"&&P.getOid&&D.get("user.oid")&&P.getOid!==D.get("user.oid")?y.value=!1:y.value=!0};ee({getNode:ve});const q=Qe(),ke=r(()=>q.getIsDataEaseBi||q.getIsIframe);return Re(()=>{A(),Q({name:"refresh-dataset-selector",callback:()=>G()})}),(e,t)=>{const s=X("ArrowDown"),k=We,we=X("CircleClose"),J=je,Se=et,K=Ue,be=ot,z=He,Ce=Oe,De=Fe,Ee=st,Te=rt,Ve=lt,Ne=Me,Ie=$e("loading");return i(),B("div",null,[o(Ne,{ref_key:"datasetSelectorPopover",ref:R,trigger:"click",placement:"bottom-start",width:320,"popper-class":"customDatasetSelect","show-arrow":!1,onShow:fe,onHide:_e,disabled:e.disabled,effect:e.themes,offset:4},{reference:a(()=>[o(Se,{ref_key:"formRef",ref:W,model:ce.value},{default:a(()=>[o(l(Ze),{prop:"name",rules:ue.value},{default:a(()=>[o(J,{size:"middle",effect:e.themes,modelValue:I.value,"onUpdate:modelValue":t[0]||(t[0]=_=>I.value=_),class:"data-set-dark",onFocus:ye,disabled:e.disabled,placeholder:l(ae)},{suffix:a(()=>[F(o(k,{class:v(["input-arrow-icon",{reverse:x.value}])},{default:a(()=>[o(s)]),_:1},8,["class"]),[[Y,!e.disabled]]),he.value?F((i(),h(k,{key:0,class:"input-custom-clear-icon",onClick:ge},{default:a(()=>[o(we)]),_:1},512)),[[Y,!e.disabled]]):d("",!0)]),_:1},8,["effect","modelValue","disabled","placeholder"])]),_:1},8,["rules"])]),_:1},8,["model"])]),default:a(()=>[o(Ve,{class:v(e.themes)},{default:a(()=>[o(be,null,{default:a(()=>[w("div",{class:v(["m-title",{dark:e.themes==="dark"}])},[w("div",null,S(E.value),1),o(K,{type:"primary",link:"",class:"refresh-btn",onClick:G},{default:a(()=>[M(S(l(c)("commons.refresh")),1)]),_:1})],2),o(J,{size:"middle",effect:e.themes,modelValue:V.value,"onUpdate:modelValue":t[1]||(t[1]=_=>V.value=_),placeholder:l(c)("dataset.search"),"prefix-icon":l(ze),clearable:""},null,8,["effect","modelValue","placeholder","prefix-icon"])]),_:1}),o(Ee,{class:v({dark:e.themes==="dark"})},{default:a(()=>[o(De,{"max-height":"252px",always:""},{default:a(()=>[m.value?F((i(),B("div",it,null,512)),[[Ie,m.value]]):d("",!0),ne.value?(i(),B("div",ct,S(le.value),1)):d("",!0),N.value?(i(),h(Ce,{key:2,class:v({dark:e.themes==="dark"}),ref_key:"datasetSelector",ref:g,"node-key":"id",data:j.value,teleported:!1,props:re,"render-after-expand":!1,filterable:"",onNodeClick:$,"filter-node-method":me,"empty-text":"暂无相关数据"},{default:a(({node:_,data:C})=>[w("div",{class:v(["tree-row-item",{dark:e.themes==="dark",active:f.value===C.id}]),title:_.label},[w("div",dt,[C.leaf?d("",!0):(i(),h(k,{key:0},{default:a(()=>[o(z,{name:"dv-folder"},{default:a(()=>[o(l(qe),{class:"svg-icon"})]),_:1})]),_:1})),C.leaf?(i(),h(k,{key:1},{default:a(()=>[o(z,{name:"icon_dataset"},{default:a(()=>[o(l(Je),{class:"svg-icon"})]),_:1})]),_:1})):d("",!0)]),M(" "+S(_.label)+" ",1),f.value===C.id?(i(),h(k,{key:0,class:"checked-item"},{default:a(()=>[o(z,{name:"icon_done_outlined"},{default:a(()=>[o(l(Ke),{class:"svg-icon"})]),_:1})]),_:1})):d("",!0)],10,ut)]),_:1},8,["class","data"])):d("",!0)]),_:1})]),_:1},8,["class"]),ke.value?d("",!0):(i(),h(Te,{key:0},{default:a(()=>[w("div",mt,[o(K,{type:"primary",icon:l(Be),link:"",class:"add-btn",onClick:pe},{default:a(()=>[M(S(l(oe)),1)]),_:1},8,["icon"])])]),_:1}))]),_:1},8,["class"])]),_:1},8,["disabled","effect"])])}}});const ia=nt(pt,[["__scopeId","data-v-468828d8"]]);export{ia as default};
