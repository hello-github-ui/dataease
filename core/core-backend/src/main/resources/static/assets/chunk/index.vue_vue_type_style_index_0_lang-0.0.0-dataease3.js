import{d as de,p as k,q as Ne,af as qe,ag as Ge,r as Qe,g as ea,t as aa,h as ta,X as sa}from"./element-plus-secondary-0.0.0-dataease.js";import{d as la,r as c,l as K,w as fe,k as me,ak as ia,o as h,c as U,a0 as d,_,a as C,a2 as T,u as g,Y as N,W as B,M as pe,z as $,ab as na,Z as E,$ as oa,X as J,a4 as X,n as z}from"./@vue-0.0.0-dataease.js";import{i as ua}from"./icon_close_outlined-0.0.0-dataease.js";import{i as ra}from"./icon_search-outline_outlined-0.0.0-dataease.js";import ca from"./CreatDsGroup-0.0.0-dataease2.js";import va from"./DsTypeList-0.0.0-dataease.js";import{j as da,h as te,l as fa}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import ma from"./EditorDetail-0.0.0-dataease.js";import{_ as pa}from"./ExcelDetail.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{h as _a,i as ga,f as ya,v as ha,a as Ca,b as Ta,u as ba}from"./datasource-0.0.0-dataease.js";import{g as V}from"./js-base64-0.0.0-dataease.js";import{t as se,n as Ee,d as Da}from"./option-0.0.0-dataease.js";import{b as Sa}from"./vue-router-0.0.0-dataease.js";import{u as xa}from"./vue-uuid-0.0.0-dataease.js";import{a as wa,u as ka}from"./index-0.0.0-dataease.js";import Fa from"./FinishPage-0.0.0-dataease.js";import{_ as Na}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as Ea}from"./datasource-list-0.0.0-dataease.js";import Pa from"./ExcelRemoteDetail-0.0.0-dataease.js";import{e as I}from"./lodash-es-0.0.0-dataease.js";const Aa={key:0,class:"editor-step flex-center"},La={class:"step-icon"},Oa={class:"icon"},Ia={class:"title"},Ua={class:"step-icon"},Ba={class:"icon"},ja={class:"title"},Ja={class:"datasource"},Va={key:0,class:"ds-type-select"},Ma={class:"title"},Ra=["onClick"],Wa=["title"],Ka={class:"custom-tree-node flex-align-center"},$a=["title"],Xa={class:"editor-footer"},_t=la({__name:"index",emits:["refresh"],setup(za,{expose:Pe,emit:Ae}){const{t:u}=da(),Z=c(),Le=Sa(),{wsCache:_e}=wa(),S=c(!1);let ge=!1,ye=!1,le=!1;const he=e=>{le=e},Ce=K({datasourceTree:[]});Ce.datasourceTree=se.map(e=>({name:Ee[e],type:e}));const n=c(0),y=c(),b=c(),P=c(),v=c(),Te=c([]),M=c("OLTP"),H=c(""),s=c(""),ie=Ae,{emitter:Oe}=ka(),F=c(!1),Y=c(!1),be=e=>{s.value=e,n.value=1,x.value=1,z(()=>{var a,t,o;(a=y==null?void 0:y.value)!=null&&a.initForm(e,Q.value,R.value,F.value)||((t=b==null?void 0:b.value)==null||t.invokeMethod({methodName:"initForm",args:e})),(o=v==null?void 0:v.value)==null||o.initForm(e),q.value&&De.value.map(l=>l.dbList).flat().some(l=>l.type===s.value?(q.value.setCurrentNode(l),F.value=l.isPlugin,!0):!1)})},Ie=e=>{e.type&&(F.value=e.isPlugin,be(e.type))},ne=e=>{M.value=e.type};fe(H,e=>{n.value===1&&q.value.filter(e.toLocaleLowerCase())});const q=c(),Ue={children:"dbList",label:"name"},Be=(e,a)=>e?a.name.toLowerCase().includes(e):!0,G=c([]),De=me(()=>se.map((e,a)=>({name:Ee[e],dbList:G.value[a]})));(()=>{const e=[[],[],[],[],[]];Da.forEach(a=>{const t=se.findIndex(o=>o===a.catalog);t!==-1&&e[t].push(a)}),G.value=e.map(a=>a.sort((t,o)=>t.name.toLowerCase().charCodeAt(0)-o.name.toLowerCase().charCodeAt(0)))})();const R=c(""),Q=c([]),je=e=>{Q.value=e,e.forEach(a=>{const{name:t,category:o,type:l,icon:i,extraParams:m,staticMap:w}=a,O={name:t,catalog:o,type:l,icon:i,extraParams:m,isPlugin:!0,staticMap:w},ae=se.findIndex(p=>p===O.catalog);ae!==-1&&G.value[ae].push(O)})},Je=e=>{var t;const a=Q.value.filter(o=>o.type===e);return R.value?R.value:a&&a.length>0?(t=a[0].staticMap)==null?void 0:t.index:null};(()=>{_a({}).then(e=>{Te.value=e.data})})();const x=c(0),oe=()=>{x.value=n.value+1,!((s.value.includes("API")||s.value==="ExcelRemote")&&n.value===1)&&(n.value=n.value+1)},Ve=()=>{var e;if(s.value===""){k.error(u("datasource.select_type"));return}if(((e=r.apiConfiguration)==null?void 0:e.length)===0&&s.value.includes("API")&&n.value!==2){k.error(u("data_source.cannot_be_empty_table"));return}if(s.value.includes("ExcelRemote")&&n.value!==2){v.value.validateExcel()&&oe();return}if(s.value.includes("API")&&n.value!==2){y.value.submitForm()(t=>{t&&oe()});return}oe()},ue=(e,a,t)=>{var o,l;(o=P==null?void 0:P.value)==null||o.saveExcelDs(e,()=>{L.value=e.pid,a()},t),(l=v==null?void 0:v.value)==null||l.saveExcelDs(e,()=>{L.value=e.pid,a()},t)},j=c(!1),re=K({name:"",id:""}),Me=()=>{Le.push({path:"/dataset-form",query:{datasourceId:re.id}})},Re=()=>{A.value=!1,ie("refresh"),j.value=!1},We=()=>{j.value=!1,ke(null,L.value)},ee=({id:e,name:a,pid:t})=>{ga().then(o=>{if(f.value||!o.data){ie("refresh"),A.value=!1;return}else j.value=!0,Object.assign(re,{id:e,name:a})}).finally(()=>{t.value=t})};Oe.on("showFinishPage",ee);const Ke=()=>{$e()},$e=()=>{if((s.value.includes("API")||s.value==="ExcelRemote")&&x.value===2){x.value=1,n.value=1;return}n.value===1&&(s.value=""),n.value=n.value-1},Xe=e=>{const a=e.validate;e.eventName==="saveDs"?a(t=>{t&&ce(e.args)}):a(t=>{t&&Se(e.args)})},ze=()=>{var a,t,o,l;const e=JSON.parse(JSON.stringify(r));if(s.value.includes("API")){if(r.apiConfiguration.length===0){k.error(u("data_source.add_data_table"));return}let i=[];i=i.concat(e.apiConfiguration),e.paramsConfiguration&&(i=i.concat(e.paramsConfiguration)),e.configuration=V.encode(JSON.stringify(i)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=V.encode(JSON.stringify(e.configuration));if(F.value&&!s.value.includes("API"))(a=b==null?void 0:b.value)==null||a.invokeMethod({methodName:"submitForm",args:[{eventName:"validateDs",args:e}]});else{let i=(t=y==null?void 0:y.value)==null?void 0:t.submitForm();(o=v==null?void 0:v.value)!=null&&o.submitForm()&&(i=(l=v==null?void 0:v.value)==null?void 0:l.submitForm()),i(m=>{m&&Se(e)})}},Se=e=>{if(S.value=!0,s.value==="ExcelRemote"){let a=JSON.parse(JSON.stringify(D.configuration));return a.datasourceId=D.id||0,a.editType=D.editType,a.userName=V.encode(a.userName),a.passwd=V.encode(a.passwd),ya(a).then(t=>{if(S.value=!1,!t){k.warning(t.msg);return}if((t==null?void 0:t.code)!==0){k.warning(t.msg);return}k.success(u("datasource.validate_success")),S.value=!1}).catch(()=>{k.error(u("data_source.verification_failed")),S.value=!1})}ha(e).then(a=>{if(a.data.type.includes("API")){let t=0;const o=JSON.parse(a.data.status);for(let l=0;l<o.length;l++){o[l].status==="Error"&&t++;for(let i=0;i<r.apiConfiguration.length;i++)o[l].name===r.apiConfiguration[i].name&&(r.apiConfiguration[i].status=o[l].status)}t===0?k.success(u("datasource.validate_success")):k.error(u("data_source.verification_failed"))}else k.success(u("datasource.validate_success"))}).finally(()=>{S.value=!1})},Ze=me(()=>{if(!s.value)return"";let e="";return G.value.some(a=>a.some(t=>t.type===s.value?(e=t.name,!0):!1)),e}),He=()=>{var a,t,o;le=!1;const e=JSON.parse(JSON.stringify(r));if(s.value==="Excel"){if(P.value.uploadStatus(!1),!((a=P.value.sheetFile)!=null&&a.name)){P.value.uploadStatus(!0);return}P.value.submitForm()(i=>{i&&(f.value?ue(null,null,null):Z.value.createInit("datasource",{id:L.value},"",D.name))});return}if(s.value==="ExcelRemote"){v.value.submitForm()(i=>{var m;i&&((m=v==null?void 0:v.value)==null?void 0:m.submitSyncSettingForm())(O=>{O&&(f.value&&D.id?ue(null,null,null):Z.value.createInit("datasource",{id:L.value},"",D.name))})});return}else if(s.value.includes("API")){for(let i=0;i<e.apiConfiguration.length;i++){(e.apiConfiguration[i].deTableName===""||e.apiConfiguration[i].deTableName===void 0||e.apiConfiguration[i].deTableName===null)&&(e.apiConfiguration[i].deTableName="api_"+e.apiConfiguration[i].name+"_"+xa.v1().replaceAll("-","").substring(0,10)),e.apiConfiguration[i].jsonFields=[];for(let m=0;m<e.apiConfiguration[i].fields.length;m++)e.apiConfiguration[i].fields[m].value=[]}let l=[];l=l.concat(e.apiConfiguration),e.paramsConfiguration&&(l=l.concat(e.paramsConfiguration)),e.configuration=V.encode(JSON.stringify(l)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=V.encode(JSON.stringify(e.configuration));if(F.value&&!s.value.includes("API"))(t=b==null?void 0:b.value)==null||t.invokeMethod({methodName:"submitForm",args:[{eventName:"saveDs",args:e}]});else{const l=(o=y==null?void 0:y.value)==null?void 0:o.submitForm();e.apiConfiguration="",l(i=>{var m;i&&(s.value.includes("API")?((m=y==null?void 0:y.value)==null?void 0:m.submitApiForm())(O=>{O&&ce(e)}):ce(e))})}},ce=e=>{if(f.value&&r.id){let a={confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,tip:""};Ca(e).then(t=>{let o=e.id===""?Ta:ba;if(t)Ne.confirm(u("datasource.has_same_ds"),a).then(()=>{S.value!==!0&&(S.value=!0,o(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),k.success(u("data_source.source_saved_successfully")))}).finally(()=>{S.value=!1}))});else{if(S.value===!0)return;S.value=!0,o(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),k.success(u("data_source.source_saved_successfully")))}).finally(()=>{S.value=!1})}})}else Z.value.createInit("datasource",{id:L.value,request:e},"",r.name)},ve={id:"",name:"",description:"",type:"API",apiConfiguration:[],paramsConfiguration:[],enableDataFill:!1},xe={type:"",id:"0",editType:0,name:"",creator:"",configuration:{}},we=K(I(ve)),r=K(I(ve)),D=K(I(xe)),A=c(!1),f=c(!1),L=c("0");fe(()=>r,()=>{ge&&he(!0)},{deep:!0}),fe(()=>D,()=>{ye&&he(!0)},{deep:!0});const ke=(e,a,t,o)=>{var l;F.value=e==null?void 0:e.isPlugin,R.value=F.value?(l=e==null?void 0:e.staticMap)==null?void 0:l.index:null,Y.value=o,f.value=!!e,j.value=!1,e?(e.type.startsWith("Excel")?Object.assign(D,I(e)):(Object.assign(r,I(e)),Object.assign(we,I(e)),r.hasOwnProperty("configuration")&&r.configuration.urlType==null&&(r.configuration.urlType="hostName"),r.hasOwnProperty("configuration")&&r.configuration.sshType==null&&(r.configuration.sshType="password")),L.value=e.pid||"0"):(Object.assign(D,I(xe)),Object.assign(r,I(ve)),L.value=a||"0"),n.value=Number(f.value),x.value=n.value,A.value=!0,z(()=>{ye=!0,ge=!0}),e&&z(()=>{s.value=e.type,n.value=1,x.value=n.value,t&&z(()=>{P.value.appendReplaceExcel(t)}),z(()=>{var i,m,w;(i=y==null?void 0:y.value)==null||i.clearForm(),(m=v==null?void 0:v.value)==null||m.clearForm(),(w=b==null?void 0:b.value)==null||w.invokeMethod({methodName:"clearForm",args:[]})})})},Ye=me(()=>{const{id:e,editType:a,creator:t}=D;return t&&e&&s.value=="Excel"?u(a===1?"data_source.append_data":"data_source.replace_data"):s.value=="ExcelRemote"?f.value?D.id?u("datasource.modify"):u("data_source.copy_data_source"):u("data_source.create_data_source"):f.value?r.id?u("datasource.modify"):u("data_source.copy_data_source"):u("data_source.create_data_source")}),Fe=()=>{_e.get("ds-new-success")&&(ie("refresh"),_e.set("ds-new-success",!1)),!j.value&&(!f.value&&n.value!==0||le)&&JSON.stringify(r)!==JSON.stringify(we)?Ne.confirm(u("data_source.want_to_exit"),{confirmButtonText:u("dataset.confirm"),cancelButtonText:u("common.cancel"),showCancelButton:!0,confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1}).then(()=>{A.value=!1}):A.value=!1};return Pe({init:ke}),(e,a)=>{const t=qe,o=Ge,l=Qe,i=ea,m=aa,w=ta,O=sa,ae=ia("loading");return h(),U(pe,null,[d(O,{"close-on-click-modal":!1,size:"calc(100% - 100px)","modal-class":"datasource-drawer-fullscreen",direction:"btt","before-close":Fe,"show-close":!1,modelValue:A.value,"onUpdate:modelValue":a[3]||(a[3]=p=>A.value=p)},{header:_(({close:p})=>[C("span",null,T(Ye.value),1),f.value?N("",!0):(h(),U("div",Aa,[d(o,{space:"150px",active:n.value,"align-center":""},{default:_(()=>[d(t,null,{icon:_(()=>[C("div",La,[C("span",Oa,T(n.value<=0?"1":""),1),C("span",Ia,T(g(u)("deDataset.select_data_source")),1)])]),_:1}),d(t,null,{icon:_(()=>[C("div",Ua,[C("span",Ba,T(n.value<=1?"2":""),1),C("span",ja,T(g(u)("data_source.configuration_information")),1)])]),_:1})]),_:1},8,["active"])])),d(g(de),{onClick:p,class:"datasource-close"},{default:_(()=>[d(te,{name:"icon_close_outlined"},{default:_(()=>[d(g(ua),{class:"svg-icon"})]),_:1})]),_:2},1032,["onClick"])]),default:_(()=>[B((h(),U("div",Ja,[f.value?N("",!0):(h(),U("div",Va,[C("div",Ma,[d(l,{placeholder:g(u)("chart.search"),class:"m24 w100",modelValue:H.value,"onUpdate:modelValue":a[0]||(a[0]=p=>H.value=p),clearable:""},{prefix:_(()=>[d(g(de),null,{default:_(()=>[d(te,{name:"icon_search-outline_outlined"},{default:_(()=>[d(g(ra),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["placeholder","modelValue"])]),n.value===0?(h(),U(pe,{key:0},[C("p",{class:$([M.value==="latestUse"&&"active","list-item_primary"]),onClick:a[1]||(a[1]=p=>ne({type:"latestUse",name:"latestUse",id:"latestUse"}))},T(g(u)("data_source.recently_created")),3),d(i),C("p",{class:$([M.value==="all"&&"active","list-item_primary"]),onClick:a[2]||(a[2]=p=>ne({type:"all",name:"all",id:"all"}))},T(g(u)("data_source.all")),3),(h(!0),U(pe,null,na(Ce.datasourceTree,p=>(h(),U("div",{key:p.name,onClick:W=>ne(p),class:$(["list-item_primary",M.value===p.type&&"active"])},[C("span",{title:p.name,class:"label"},T(p.name),9,Wa)],10,Ra))),128))],64)):N("",!0),n.value>0?(h(),E(m,{key:1,"expand-on-click-node":!1,menu:"",ref_key:"dsTree",ref:q,data:De.value,nodeKey:"name",props:Ue,"filter-node-method":Be,onNodeClick:Ie},{default:_(({node:p,data:W})=>[C("span",Ka,[W.catalog?(h(),E(g(de),{key:0,class:"icon-border",style:{width:"18px",height:"18px"}},{default:_(()=>[W.isPlugin?(h(),E(te,{key:0,"static-content":W.icon},null,8,["static-content"])):(h(),E(te,{key:1},{default:_(()=>[(h(),E(oa(g(Ea)[W.type]),{class:"svg-icon"}))]),_:2},1024))]),_:2},1024)):N("",!0),C("span",{title:p.label,class:"label-tooltip"},T(p.label),9,$a)])]),_:1},8,["data"])):N("",!0)])),C("div",{class:$(["ds-editor",f.value&&"edit-ds"])},[B(C("div",{class:"ds-type-title"},T(Ze.value),513),[[J,n.value!==0&&!f.value]]),C("div",{class:$(["editor-content",(n.value===0||f.value)&&"type-title"])},[B(d(va,{"filter-text":H.value.toLocaleLowerCase(),onSelectDsType:be,"current-type":M.value,"latest-use-types":Te.value},null,8,["filter-text","current-type","latest-use-types"]),[[J,n.value===0]]),n.value!==0&&s.value&&!s.value.startsWith("Excel")&&A.value&&(!F.value||s.value.startsWith("API"))?(h(),E(ma,{key:0,ref_key:"detail",ref:y,form:r,"is-plugin":F.value,"plugin-ds":Q.value,"plugin-index":R.value,editDs:f.value,"active-step":x.value,"is-supportSetKey":Y.value},null,8,["form","is-plugin","plugin-ds","plugin-index","editDs","active-step","is-supportSetKey"])):N("",!0),n.value!==0&&s.value&&s.value!=="Excel"&&A.value&&F.value&&!s.value.startsWith("API")?(h(),E(g(Na),{key:1,jsname:Je(s.value),ref_key:"xpack",ref:b,form:r,editDs:f.value,"active-step":x.value,onSubmitForm:Xe},null,8,["jsname","form","editDs","active-step"])):N("",!0),n.value!==0&&s.value=="Excel"?(h(),E(pa,{key:2,editDs:f.value,"is-supportSetKey":Y.value,ref_key:"excel",ref:P,param:D},null,8,["editDs","is-supportSetKey","param"])):N("",!0),n.value!==0&&s.value=="ExcelRemote"?(h(),E(Pa,{key:3,editDs:f.value,"is-supportSetKey":Y.value,ref_key:"excelRemote",ref:v,"active-step":x.value,form:D},null,8,["editDs","is-supportSetKey","active-step","form"])):N("",!0)],2)],2),C("div",Xa,[d(w,{secondary:"",onClick:Fe},{default:_(()=>[X(T(g(u)("common.cancel")),1)]),_:1}),B(d(w,{secondary:"",onClick:Ke},{default:_(()=>[X(T(g(u)("common.prev")),1)]),_:1},512),[[J,!(n.value===0||f.value&&x.value<=1)]]),B(d(w,{secondary:"",onClick:ze},{default:_(()=>[X(T(g(u)("datasource.validate")),1)]),_:1},512),[[J,n.value===1&&s.value!=="Excel"]]),B(d(w,{type:"primary",onClick:Ve},{default:_(()=>[X(T(g(u)("common.next")),1)]),_:1},512),[[J,n.value===0&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||x.value!==2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]]),B(d(w,{type:"primary",onClick:He},{default:_(()=>[X(T(g(u)("common.save")),1)]),_:1},512),[[J,n.value===1&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||x.value===2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]])]),j.value?(h(),E(Fa,{key:1,onContinueCreating:We,onBackToDatasourceList:Re,onCreateDataset:Me,name:re.name},null,8,["name"])):N("",!0),d(g(fa),{jsname:"L2NvbXBvbmVudC9wbHVnaW5zLWhhbmRsZXIvRHNDYXRlZ29yeUhhbmRsZXI=",onLoadDsPlugin:je})])),[[ae,S.value]])]),_:1},8,["modelValue"]),d(ca,{onHandleShowFinishPage:ee,onFinish:ue,ref_key:"creatDsFolder",ref:Z},null,512)],64)}}});export{_t as _};
