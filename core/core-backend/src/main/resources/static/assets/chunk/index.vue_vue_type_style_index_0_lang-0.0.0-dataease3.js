import{a as Ye,u as qe}from"./index-0.0.0-dataease.js";import{E as Qe}from"./el-drawer-0.0.0-dataease.js";import{o as ea,j as de,n as te,v as aa,D as E,F as Fe,G as ta,y as sa}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{E as la}from"./el-tree-0.0.0-dataease.js";import"./el-checkbox-0.0.0-dataease.js";import{E as ia}from"./el-divider-0.0.0-dataease.js";import{E as na,a as oa}from"./ApiHttpRequestDraw.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{d as ua,r as c,a7 as ra,Z as K,w as fe,G as me,aa as ca,f as h,L as I,k as d,i as _,M as C,a6 as T,j as g,a0 as F,T as j,Y as pe,U as $,a9 as va,g as N,m as da,W as J,a5 as X,n as Z}from"./vue-0.0.0-dataease.js";import{i as fa}from"./icon_close_outlined-0.0.0-dataease.js";import{i as ma}from"./icon_search-outline_outlined-0.0.0-dataease.js";import pa from"./CreatDsGroup-0.0.0-dataease2.js";import _a from"./DsTypeList-0.0.0-dataease.js";import ga from"./EditorDetail-0.0.0-dataease.js";import{_ as ya}from"./ExcelDetail.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{h as ha,i as Ca,f as Ta,v as Da,a as ba,b as Sa,u as xa}from"./datasource-0.0.0-dataease.js";import{g as V}from"./base64-0.0.0-dataease.js";import{t as se,n as Ne,d as wa}from"./option-0.0.0-dataease.js";import{u as Ea}from"./index.esm-0.0.0-dataease.js";import ka from"./FinishPage-0.0.0-dataease.js";import{_ as Fa}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as Na}from"./datasource-list-0.0.0-dataease.js";import Pa from"./ExcelRemoteDetail-0.0.0-dataease.js";import{d as U}from"./lodash-0.0.0-dataease.js";const Aa={key:0,class:"editor-step flex-center"},La={class:"step-icon"},Oa={class:"icon"},Ua={class:"title"},Ia={class:"step-icon"},ja={class:"icon"},Ba={class:"title"},Ja={class:"datasource"},Va={key:0,class:"ds-type-select"},Ma={class:"title"},Ra=["onClick"],Wa=["title"],Ka={class:"custom-tree-node flex-align-center"},$a=["title"],Xa={class:"editor-footer"},ht=ua({__name:"index",emits:["refresh"],setup(Za,{expose:Pe,emit:Ae}){const{t:u}=ea(),z=c(),Le=ra(),{wsCache:_e}=Ye(),S=c(!1);let ge=!1,ye=!1,le=!1;const he=e=>{le=e},Ce=K({datasourceTree:[]});Ce.datasourceTree=se.map(e=>({name:Ne[e],type:e}));const n=c(0),y=c(),D=c(),P=c(),v=c(),Te=c([]),M=c("OLTP"),G=c(""),s=c(""),ie=Ae,{emitter:Oe}=qe(),k=c(!1),H=c(!1),De=e=>{s.value=e,n.value=1,x.value=1,Z(()=>{var a,t,o;(a=y==null?void 0:y.value)!=null&&a.initForm(e,Q.value,R.value,k.value)||((t=D==null?void 0:D.value)==null||t.invokeMethod({methodName:"initForm",args:e})),(o=v==null?void 0:v.value)==null||o.initForm(e),Y.value&&be.value.map(l=>l.dbList).flat().some(l=>l.type===s.value?(Y.value.setCurrentNode(l),k.value=l.isPlugin,!0):!1)})},Ue=e=>{e.type&&(k.value=e.isPlugin,De(e.type))},ne=e=>{M.value=e.type};fe(G,e=>{n.value===1&&Y.value.filter(e.toLocaleLowerCase())});const Y=c(),Ie={children:"dbList",label:"name"},je=(e,a)=>e?a.name.toLowerCase().includes(e):!0,q=c([]),be=me(()=>se.map((e,a)=>({name:Ne[e],dbList:q.value[a]})));(()=>{const e=[[],[],[],[],[]];wa.forEach(a=>{const t=se.findIndex(o=>o===a.catalog);t!==-1&&e[t].push(a)}),q.value=e.map(a=>a.sort((t,o)=>t.name.toLowerCase().charCodeAt(0)-o.name.toLowerCase().charCodeAt(0)))})();const R=c(""),Q=c([]),Be=e=>{Q.value=e,e.forEach(a=>{const{name:t,category:o,type:l,icon:i,extraParams:m,staticMap:w}=a,O={name:t,catalog:o,type:l,icon:i,extraParams:m,isPlugin:!0,staticMap:w},ae=se.findIndex(p=>p===O.catalog);ae!==-1&&q.value[ae].push(O)})},Je=e=>{var t;const a=Q.value.filter(o=>o.type===e);return R.value?R.value:a&&a.length>0?(t=a[0].staticMap)==null?void 0:t.index:null};(()=>{ha({}).then(e=>{Te.value=e.data})})();const x=c(0),oe=()=>{x.value=n.value+1,!((s.value.includes("API")||s.value==="ExcelRemote")&&n.value===1)&&(n.value=n.value+1)},Ve=()=>{var e;if(s.value===""){E.error(u("datasource.select_type"));return}if(((e=r.apiConfiguration)==null?void 0:e.length)===0&&s.value.includes("API")&&n.value!==2){E.error(u("data_source.cannot_be_empty_table"));return}if(s.value.includes("ExcelRemote")&&n.value!==2){v.value.validateExcel()&&oe();return}if(s.value.includes("API")&&n.value!==2){y.value.submitForm()(t=>{t&&oe()});return}oe()},ue=(e,a,t)=>{var o,l;(o=P==null?void 0:P.value)==null||o.saveExcelDs(e,()=>{L.value=e.pid,a()},t),(l=v==null?void 0:v.value)==null||l.saveExcelDs(e,()=>{L.value=e.pid,a()},t)},B=c(!1),re=K({name:"",id:""}),Me=()=>{Le.push({path:"/dataset-form",query:{datasourceId:re.id}})},Re=()=>{A.value=!1,ie("refresh"),B.value=!1},We=()=>{B.value=!1,Ee(null,L.value)},ee=({id:e,name:a,pid:t})=>{Ca().then(o=>{if(f.value||!o.data){ie("refresh"),A.value=!1;return}else B.value=!0,Object.assign(re,{id:e,name:a})}).finally(()=>{t.value=t})};Oe.on("showFinishPage",ee);const Ke=()=>{$e()},$e=()=>{if((s.value.includes("API")||s.value==="ExcelRemote")&&x.value===2){x.value=1,n.value=1;return}n.value===1&&(s.value=""),n.value=n.value-1},Xe=e=>{const a=e.validate;e.eventName==="saveDs"?a(t=>{t&&ce(e.args)}):a(t=>{t&&Se(e.args)})},Ze=()=>{var a,t,o,l;const e=JSON.parse(JSON.stringify(r));if(s.value.includes("API")){if(r.apiConfiguration.length===0){E.error(u("data_source.add_data_table"));return}let i=[];i=i.concat(e.apiConfiguration),e.paramsConfiguration&&(i=i.concat(e.paramsConfiguration)),e.configuration=V.encode(JSON.stringify(i)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=V.encode(JSON.stringify(e.configuration));if(k.value&&!s.value.includes("API"))(a=D==null?void 0:D.value)==null||a.invokeMethod({methodName:"submitForm",args:[{eventName:"validateDs",args:e}]});else{let i=(t=y==null?void 0:y.value)==null?void 0:t.submitForm();(o=v==null?void 0:v.value)!=null&&o.submitForm()&&(i=(l=v==null?void 0:v.value)==null?void 0:l.submitForm()),i(m=>{m&&Se(e)})}},Se=e=>{if(S.value=!0,s.value==="ExcelRemote"){let a=JSON.parse(JSON.stringify(b.configuration));return a.datasourceId=b.id||0,a.editType=b.editType,a.userName=V.encode(a.userName),a.passwd=V.encode(a.passwd),Ta(a).then(t=>{if(S.value=!1,!t){E.warning(t.msg);return}if((t==null?void 0:t.code)!==0){E.warning(t.msg);return}E.success(u("datasource.validate_success")),S.value=!1}).catch(()=>{E.error(u("data_source.verification_failed")),S.value=!1})}Da(e).then(a=>{if(a.data.type.includes("API")){let t=0;const o=JSON.parse(a.data.status);for(let l=0;l<o.length;l++){o[l].status==="Error"&&t++;for(let i=0;i<r.apiConfiguration.length;i++)o[l].name===r.apiConfiguration[i].name&&(r.apiConfiguration[i].status=o[l].status)}t===0?E.success(u("datasource.validate_success")):E.error(u("data_source.verification_failed"))}else E.success(u("datasource.validate_success"))}).finally(()=>{S.value=!1})},ze=me(()=>{if(!s.value)return"";let e="";return q.value.some(a=>a.some(t=>t.type===s.value?(e=t.name,!0):!1)),e}),Ge=()=>{var a,t,o;le=!1;const e=JSON.parse(JSON.stringify(r));if(s.value==="Excel"){if(P.value.uploadStatus(!1),!((a=P.value.sheetFile)!=null&&a.name)){P.value.uploadStatus(!0);return}P.value.submitForm()(i=>{i&&(f.value?ue(null,null,null):z.value.createInit("datasource",{id:L.value},"",b.name))});return}if(s.value==="ExcelRemote"){v.value.submitForm()(i=>{var m;i&&((m=v==null?void 0:v.value)==null?void 0:m.submitSyncSettingForm())(O=>{O&&(f.value&&b.id?ue(null,null,null):z.value.createInit("datasource",{id:L.value},"",b.name))})});return}else if(s.value.includes("API")){for(let i=0;i<e.apiConfiguration.length;i++){(e.apiConfiguration[i].deTableName===""||e.apiConfiguration[i].deTableName===void 0||e.apiConfiguration[i].deTableName===null)&&(e.apiConfiguration[i].deTableName="api_"+e.apiConfiguration[i].name+"_"+Ea.v1().replaceAll("-","").substring(0,10)),e.apiConfiguration[i].jsonFields=[];for(let m=0;m<e.apiConfiguration[i].fields.length;m++)e.apiConfiguration[i].fields[m].value=[]}let l=[];l=l.concat(e.apiConfiguration),e.paramsConfiguration&&(l=l.concat(e.paramsConfiguration)),e.configuration=V.encode(JSON.stringify(l)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=V.encode(JSON.stringify(e.configuration));if(k.value&&!s.value.includes("API"))(t=D==null?void 0:D.value)==null||t.invokeMethod({methodName:"submitForm",args:[{eventName:"saveDs",args:e}]});else{const l=(o=y==null?void 0:y.value)==null?void 0:o.submitForm();e.apiConfiguration="",l(i=>{var m;i&&(s.value.includes("API")?((m=y==null?void 0:y.value)==null?void 0:m.submitApiForm())(O=>{O&&ce(e)}):ce(e))})}},ce=e=>{if(f.value&&r.id){let a={confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,tip:""};ba(e).then(t=>{let o=e.id===""?Sa:xa;if(t)Fe.confirm(u("datasource.has_same_ds"),a).then(()=>{S.value!==!0&&(S.value=!0,o(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),E.success(u("data_source.source_saved_successfully")))}).finally(()=>{S.value=!1}))});else{if(S.value===!0)return;S.value=!0,o(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),E.success(u("data_source.source_saved_successfully")))}).finally(()=>{S.value=!1})}})}else z.value.createInit("datasource",{id:L.value,request:e},"",r.name)},ve={id:"",name:"",description:"",type:"API",apiConfiguration:[],paramsConfiguration:[],enableDataFill:!1},xe={type:"",id:"0",editType:0,name:"",creator:"",configuration:{}},we=K(U(ve)),r=K(U(ve)),b=K(U(xe)),A=c(!1),f=c(!1),L=c("0");fe(()=>r,()=>{ge&&he(!0)},{deep:!0}),fe(()=>b,()=>{ye&&he(!0)},{deep:!0});const Ee=(e,a,t,o)=>{var l;k.value=e==null?void 0:e.isPlugin,R.value=k.value?(l=e==null?void 0:e.staticMap)==null?void 0:l.index:null,H.value=o,f.value=!!e,B.value=!1,e?(e.type.startsWith("Excel")?Object.assign(b,U(e)):(Object.assign(r,U(e)),Object.assign(we,U(e)),r.hasOwnProperty("configuration")&&r.configuration.urlType==null&&(r.configuration.urlType="hostName"),r.hasOwnProperty("configuration")&&r.configuration.sshType==null&&(r.configuration.sshType="password")),L.value=e.pid||"0"):(Object.assign(b,U(xe)),Object.assign(r,U(ve)),L.value=a||"0"),n.value=Number(f.value),x.value=n.value,A.value=!0,Z(()=>{ye=!0,ge=!0}),e&&Z(()=>{s.value=e.type,n.value=1,x.value=n.value,t&&Z(()=>{P.value.appendReplaceExcel(t)}),Z(()=>{var i,m,w;(i=y==null?void 0:y.value)==null||i.clearForm(),(m=v==null?void 0:v.value)==null||m.clearForm(),(w=D==null?void 0:D.value)==null||w.invokeMethod({methodName:"clearForm",args:[]})})})},He=me(()=>{const{id:e,editType:a,creator:t}=b;return t&&e&&s.value=="Excel"?u(a===1?"data_source.append_data":"data_source.replace_data"):s.value=="ExcelRemote"?f.value?b.id?u("datasource.modify"):u("data_source.copy_data_source"):u("data_source.create_data_source"):f.value?r.id?u("datasource.modify"):u("data_source.copy_data_source"):u("data_source.create_data_source")}),ke=()=>{_e.get("ds-new-success")&&(ie("refresh"),_e.set("ds-new-success",!1)),!B.value&&(!f.value&&n.value!==0||le)&&JSON.stringify(r)!==JSON.stringify(we)?Fe.confirm(u("data_source.want_to_exit"),{confirmButtonText:u("dataset.confirm"),cancelButtonText:u("common.cancel"),showCancelButton:!0,confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1}).then(()=>{A.value=!1}):A.value=!1};return Pe({init:Ee}),(e,a)=>{const t=na,o=oa,l=ta,i=ia,m=la,w=sa,O=Qe,ae=ca("loading");return h(),I(pe,null,[d(O,{"close-on-click-modal":!1,size:"calc(100% - 100px)","modal-class":"datasource-drawer-fullscreen",direction:"btt","before-close":ke,"show-close":!1,modelValue:A.value,"onUpdate:modelValue":a[3]||(a[3]=p=>A.value=p)},{header:_(({close:p})=>[C("span",null,T(He.value),1),f.value?F("",!0):(h(),I("div",Aa,[d(o,{space:"150px",active:n.value,"align-center":""},{default:_(()=>[d(t,null,{icon:_(()=>[C("div",La,[C("span",Oa,T(n.value<=0?"1":""),1),C("span",Ua,T(g(u)("deDataset.select_data_source")),1)])]),_:1}),d(t,null,{icon:_(()=>[C("div",Ia,[C("span",ja,T(n.value<=1?"2":""),1),C("span",Ba,T(g(u)("data_source.configuration_information")),1)])]),_:1})]),_:1},8,["active"])])),d(g(de),{onClick:p,class:"datasource-close"},{default:_(()=>[d(te,{name:"icon_close_outlined"},{default:_(()=>[d(g(fa),{class:"svg-icon"})]),_:1})]),_:2},1032,["onClick"])]),default:_(()=>[j((h(),I("div",Ja,[f.value?F("",!0):(h(),I("div",Va,[C("div",Ma,[d(l,{placeholder:g(u)("chart.search"),class:"m24 w100",modelValue:G.value,"onUpdate:modelValue":a[0]||(a[0]=p=>G.value=p),clearable:""},{prefix:_(()=>[d(g(de),null,{default:_(()=>[d(te,{name:"icon_search-outline_outlined"},{default:_(()=>[d(g(ma),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["placeholder","modelValue"])]),n.value===0?(h(),I(pe,{key:0},[C("p",{class:$([M.value==="latestUse"&&"active","list-item_primary"]),onClick:a[1]||(a[1]=p=>ne({type:"latestUse",name:"latestUse",id:"latestUse"}))},T(g(u)("data_source.recently_created")),3),d(i),C("p",{class:$([M.value==="all"&&"active","list-item_primary"]),onClick:a[2]||(a[2]=p=>ne({type:"all",name:"all",id:"all"}))},T(g(u)("data_source.all")),3),(h(!0),I(pe,null,va(Ce.datasourceTree,p=>(h(),I("div",{key:p.name,onClick:W=>ne(p),class:$(["list-item_primary",M.value===p.type&&"active"])},[C("span",{title:p.name,class:"label"},T(p.name),9,Wa)],10,Ra))),128))],64)):F("",!0),n.value>0?(h(),N(m,{key:1,"expand-on-click-node":!1,menu:"",ref_key:"dsTree",ref:Y,data:be.value,nodeKey:"name",props:Ie,"filter-node-method":je,onNodeClick:Ue},{default:_(({node:p,data:W})=>[C("span",Ka,[W.catalog?(h(),N(g(de),{key:0,class:"icon-border",style:{width:"18px",height:"18px"}},{default:_(()=>[W.isPlugin?(h(),N(te,{key:0,"static-content":W.icon},null,8,["static-content"])):(h(),N(te,{key:1},{default:_(()=>[(h(),N(da(g(Na)[W.type]),{class:"svg-icon"}))]),_:2},1024))]),_:2},1024)):F("",!0),C("span",{title:p.label,class:"label-tooltip"},T(p.label),9,$a)])]),_:1},8,["data"])):F("",!0)])),C("div",{class:$(["ds-editor",f.value&&"edit-ds"])},[j(C("div",{class:"ds-type-title"},T(ze.value),513),[[J,n.value!==0&&!f.value]]),C("div",{class:$(["editor-content",(n.value===0||f.value)&&"type-title"])},[j(d(_a,{"filter-text":G.value.toLocaleLowerCase(),onSelectDsType:De,"current-type":M.value,"latest-use-types":Te.value},null,8,["filter-text","current-type","latest-use-types"]),[[J,n.value===0]]),n.value!==0&&s.value&&!s.value.startsWith("Excel")&&A.value&&(!k.value||s.value.startsWith("API"))?(h(),N(ga,{key:0,ref_key:"detail",ref:y,form:r,"is-plugin":k.value,"plugin-ds":Q.value,"plugin-index":R.value,editDs:f.value,"active-step":x.value,"is-supportSetKey":H.value},null,8,["form","is-plugin","plugin-ds","plugin-index","editDs","active-step","is-supportSetKey"])):F("",!0),n.value!==0&&s.value&&s.value!=="Excel"&&A.value&&k.value&&!s.value.startsWith("API")?(h(),N(g(Fa),{key:1,jsname:Je(s.value),ref_key:"xpack",ref:D,form:r,editDs:f.value,"active-step":x.value,onSubmitForm:Xe},null,8,["jsname","form","editDs","active-step"])):F("",!0),n.value!==0&&s.value=="Excel"?(h(),N(ya,{key:2,editDs:f.value,"is-supportSetKey":H.value,ref_key:"excel",ref:P,param:b},null,8,["editDs","is-supportSetKey","param"])):F("",!0),n.value!==0&&s.value=="ExcelRemote"?(h(),N(Pa,{key:3,editDs:f.value,"is-supportSetKey":H.value,ref_key:"excelRemote",ref:v,"active-step":x.value,form:b},null,8,["editDs","is-supportSetKey","active-step","form"])):F("",!0)],2)],2),C("div",Xa,[d(w,{secondary:"",onClick:ke},{default:_(()=>[X(T(g(u)("common.cancel")),1)]),_:1}),j(d(w,{secondary:"",onClick:Ke},{default:_(()=>[X(T(g(u)("common.prev")),1)]),_:1},512),[[J,!(n.value===0||f.value&&x.value<=1)]]),j(d(w,{secondary:"",onClick:Ze},{default:_(()=>[X(T(g(u)("datasource.validate")),1)]),_:1},512),[[J,n.value===1&&s.value!=="Excel"]]),j(d(w,{type:"primary",onClick:Ve},{default:_(()=>[X(T(g(u)("common.next")),1)]),_:1},512),[[J,n.value===0&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||x.value!==2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]]),j(d(w,{type:"primary",onClick:Ge},{default:_(()=>[X(T(g(u)("common.save")),1)]),_:1},512),[[J,n.value===1&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||x.value===2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]])]),B.value?(h(),N(ka,{key:1,onContinueCreating:We,onBackToDatasourceList:Re,onCreateDataset:Me,name:re.name},null,8,["name"])):F("",!0),d(g(aa),{jsname:"L2NvbXBvbmVudC9wbHVnaW5zLWhhbmRsZXIvRHNDYXRlZ29yeUhhbmRsZXI=",onLoadDsPlugin:Be})])),[[ae,S.value]])]),_:1},8,["modelValue"]),d(pa,{onHandleShowFinishPage:ee,onFinish:ue,ref_key:"creatDsFolder",ref:z},null,512)],64)}}});export{ht as _};
